   Cipolla's algorithm      Cipolla's algorithm   In computational number theory , Cipolla's algorithm is a technique for solving a congruence of the form        x  2   â‰¡   n     (   mod  p   )     .       superscript  x  2    annotated  n   pmod  p      x^{2}\equiv n\;\;(\mathop{{\rm mod}}p).     where     x  ,  n   âˆˆ   ð…  p        x  n    subscript  ð…  p     x,n\in\mathbf{F}_{p}   , so n is the square of x , and where   p   p   p   is an odd  prime . Here    ð…  p     subscript  ð…  p    \mathbf{F}_{p}   denotes the finite field with   p   p   p    elements ;    {  0  ,  1  ,  â€¦  ,   p  -  1   }     0  1  normal-â€¦    p  1     \{0,1,\dots,p-1\}   . The algorithm is named after Michele Cipolla , an Italian  mathematician who discovered it in the year 1907.  The algorithm  Inputs:      p   p   p   , an odd prime,      n  âˆˆ   ð…  p       n   subscript  ð…  p     n\in\mathbf{F}_{p}   , which is a square.   Outputs:       x  âˆˆ   ð…  p       x   subscript  ð…  p     x\in\mathbf{F}_{p}   , satisfying      x  2   =  n   .       superscript  x  2   n    x^{2}=n.      Step 1 is to find an    a  âˆˆ   ð…  p       a   subscript  ð…  p     a\in\mathbf{F}_{p}   such that     a  2   -  n       superscript  a  2   n    a^{2}-n   is not a square. There is no known algorithm for finding such an   a   a   a   , except the trial and error method. Simply pick an   a   a   a   and by computing the Legendre symbol     (   a  2   -  n  |  p  )     fragments  normal-(   superscript  a  2    n  normal-|  p  normal-)    (a^{2}-n|p)   one can see whether   a   a   a   satisfies the condition. The chance that a random   a   a   a   will satisfy is      (   p  -  1   )   /  2   p          p  1   2   p    (p-1)/2p   . With   p   p   p   large enough this is about    1  /  2      1  2    1/2   . 1 Therefore, the expected number of trials before finding a suitable a is about 2.  Step 2 is to compute x by computing    x  =    (   a  +     a  2   -  n     )     (   p  +  1   )   /  2        x   superscript    a       superscript  a  2   n         p  1   2      x=\left(a+\sqrt{a^{2}-n}\right)^{(p+1)/2}   within the field     ð…   p  2    =    ð…  p    (     a  2   -  n    )         subscript  ð…   superscript  p  2       subscript  ð…  p        superscript  a  2   n       \mathbf{F}_{p^{2}}=\mathbf{F}_{p}(\sqrt{a^{2}-n})   . This x will be the one satisfying      x  2   =  n   .       superscript  x  2   n    x^{2}=n.     If     x  2   =  n       superscript  x  2   n    x^{2}=n   , then      (   -  x   )   2   =  n       superscript    x   2   n    (-x)^{2}=n   also holds. And since p is odd,    x  â‰    -  x       x    x     x\neq-x   . So whenever a solution x is found, there's always a second solution, -x .  Example  (Note: All elements before step two are considered as an element of    ð…  13     subscript  ð…  13    \mathbf{F}_{13}   and all elements in step two are considered as elements of    ð…   13  2      subscript  ð…   superscript  13  2     \mathbf{F}_{13^{2}}   ).  Find all x such that     x  2   =  10.       superscript  x  2   10.    x^{2}=10.     Before applying the algorithm, it must be checked that   10   10   10   is indeed a square in    ð…  13     subscript  ð…  13    \mathbf{F}_{13}   . Therefore, the Legendre symbol    (  10  |  13  )     fragments  normal-(  10  normal-|  13  normal-)    (10|13)   has to be equal to 1. This can be computed using Euler's criterion ;     (  10  |  13  )   â‰¡   10  6   â‰¡  1  mod  13.     fragments   fragments  normal-(  10  normal-|  13  normal-)     superscript  10  6    1  modulo  13.    (10|13)\equiv 10^{6}\equiv 1\bmod 13.   This confirms 10 being a square and hence the algorithm can be applied.   Step 1: Find an a such that     a  2   -  n       superscript  a  2   n    a^{2}-n   is not a square. As stated, this has to be done by trial and error. Choose    a  =  2      a  2    a=2   . Then     a  2   -  n       superscript  a  2   n    a^{2}-n   becomes 7. The Legendre symbol    (  7  |  13  )     fragments  normal-(  7  normal-|  13  normal-)    (7|13)   has to be -1. Again this can be computed using Euler's criterion.     7  6   =   343  2   â‰¡   5  2   â‰¡  25  â‰¡    -  1   mod  13.          superscript  7  6    superscript  343  2         superscript  5  2        25        modulo    1   13.      7^{6}=343^{2}\equiv 5^{2}\equiv 25\equiv-1\bmod 13.   So    a  =  2      a  2    a=2   is a suitable choice for a .  Step 2: Compute     x  =    (   a  +     a  2   -  n     )     (   p  +  1   )   /  2    =    (   2  +    -  6     )   7    .        x   superscript    a       superscript  a  2   n         p  1   2          superscript    2      6     7      x=\left(a+\sqrt{a^{2}-n}\right)^{(p+1)/2}=\left(2+\sqrt{-6}\right)^{7}.             (   2  +    -  6     )   2   =    4  +   4    -  6      -  6   =    -  2   +   4    -  6       .         superscript    2      6     2       4    4      6      6            2     4      6         \left(2+\sqrt{-6}\right)^{2}=4+4\sqrt{-6}-6=-2+4\sqrt{-6}.            (   2  +    -  6     )   4   =    (    -  2   +   4    -  6      )   2   =    -  1   -   3    -  6       .         superscript    2      6     4    superscript      2     4      6      2            1     3      6         \left(2+\sqrt{-6}\right)^{4}=\left(-2+4\sqrt{-6}\right)^{2}=-1-3\sqrt{-6}.            (   2  +    -  6     )   6   =    (    -  2   +   4    -  6      )    (    -  1   -   3    -  6      )    =   9  +   2    -  6       .         superscript    2      6     6         2     4      6          1     3      6              9    2      6         \left(2+\sqrt{-6}\right)^{6}=\left(-2+4\sqrt{-6}\right)\left(-1-3\sqrt{-6}%
 \right)=9+2\sqrt{-6}.           (   2  +    -  6     )   7   =    (   9  +   2    -  6      )    (   2  +    -  6     )    =  6.         superscript    2      6     7       9    2      6        2      6           6.     \left(2+\sqrt{-6}\right)^{7}=\left(9+2\sqrt{-6}\right)\left(2+\sqrt{-6}\right)%
 =6.     So    x  =  6      x  6    x=6   is a solution, as well as    x  =   -  6   =  7.        x    6        7.     x=-6=7.   Indeed,     6  2   =  36  =  10         superscript  6  2   36       10     \ 6^{2}=36=10   and     7  2   =  49  =  10.         superscript  7  2   49       10.     7^{2}=49=10.     Proof  The first part of the proof is to verify that     ð…   p  2    =    ð…  p    (     a  2   -  n    )    =   {   x  +   y     a  2   -  n      :    x  ,  y   âˆˆ   ð…  p    }          subscript  ð…   superscript  p  2       subscript  ð…  p        superscript  a  2   n           conditional-set    x    y       superscript  a  2   n         x  y    subscript  ð…  p        \mathbf{F}_{p^{2}}=\mathbf{F}_{p}(\sqrt{a^{2}-n})=\{x+y\sqrt{a^{2}-n}:x,y\in%
 \mathbf{F}_{p}\}   is indeed a field. For the sake of notation simplicity,   Ï‰   Ï‰   \omega   is defined as      a  2   -  n          superscript  a  2   n     \sqrt{a^{2}-n}   . Of course,     a  2   -  n       superscript  a  2   n    a^{2}-n   is a quadratic non-residue, so there is no square root in    ð…  p     subscript  ð…  p    \mathbf{F}_{p}   . This   Ï‰   Ï‰   \omega   can roughly be seen as analogous to the complex number i . The field arithmetic is quite obvious. Addition is defined as        (    x  1   +    y  1   Ï‰    )   +   (    x  2   +    y  2   Ï‰    )    =    (    x  1   +   x  2    )   +    (    y  1   +   y  2    )   Ï‰             subscript  x  1      subscript  y  1   Ï‰       subscript  x  2      subscript  y  2   Ï‰          subscript  x  1    subscript  x  2         subscript  y  1    subscript  y  2    Ï‰      \left(x_{1}+y_{1}\omega\right)+\left(x_{2}+y_{2}\omega\right)=\left(x_{1}+x_{2%
 }\right)+\left(y_{1}+y_{2}\right)\omega   . Multiplication is also defined as usual. With keeping in mind that     Ï‰  2   =    a  2   -  n        superscript  Ï‰  2      superscript  a  2   n     \omega^{2}=a^{2}-n   , it becomes        (    x  1   +    y  1   Ï‰    )    (    x  2   +    y  2   Ï‰    )    =     x  1    x  2    +    x  1    y  2   Ï‰   +    y  1    x  2   Ï‰   +    y  1    y  2    Ï‰  2     =    (     x  1    x  2    +    y  1    y  2    (    a  2   -  n   )     )   +    (     x  1    y  2    +    y  1    x  2     )   Ï‰               subscript  x  1      subscript  y  1   Ï‰       subscript  x  2      subscript  y  2   Ï‰          subscript  x  1    subscript  x  2       subscript  x  1    subscript  y  2   Ï‰      subscript  y  1    subscript  x  2   Ï‰      subscript  y  1    subscript  y  2    superscript  Ï‰  2                 subscript  x  1    subscript  x  2       subscript  y  1    subscript  y  2      superscript  a  2   n            subscript  x  1    subscript  y  2       subscript  y  1    subscript  x  2     Ï‰       \left(x_{1}+y_{1}\omega\right)\left(x_{2}+y_{2}\omega\right)=x_{1}x_{2}+x_{1}y%
 _{2}\omega+y_{1}x_{2}\omega+y_{1}y_{2}\omega^{2}=\left(x_{1}x_{2}+y_{1}y_{2}%
 \left(a^{2}-n\right)\right)+\left(x_{1}y_{2}+y_{1}x_{2}\right)\omega   . Now the field properties have to be checked. The properties of closure under addition and multiplication, associativity , commutativity and distributivity are easily seen. This is because in this case the field    ð…   p  2      subscript  ð…   superscript  p  2     \mathbf{F}_{p^{2}}   is somewhat equivalent to the field of complex numbers (with   Ï‰   Ï‰   \omega   being the analogon of i ). The additive identity is   0   0    , more formal    0  +   0  Ï‰       0    0  Ï‰     0+0\omega   : Let    Î±  âˆˆ   ð…   p  2        Î±   subscript  ð…   superscript  p  2      \alpha\in\mathbf{F}_{p^{2}}   , then       Î±  +  0   =    (   x  +   y  Ï‰    )   +   (   0  +   0  Ï‰    )    =    (   x  +  0   )   +    (   y  +  0   )   Ï‰    =   x  +   y  Ï‰    =  Î±          Î±  0       x    y  Ï‰      0    0  Ï‰              x  0       y  0   Ï‰           x    y  Ï‰         Î±     \alpha+0=(x+y\omega)+(0+0\omega)=(x+0)+(y+0)\omega=x+y\omega=\alpha   . The multiplicative identity is   1   1   1   , or more formal    1  +   0  Ï‰       1    0  Ï‰     1+0\omega   :       Î±  â‹…  1   =    (   x  +   y  Ï‰    )    (   1  +   0  Ï‰    )    =    (    x  â‹…  1   +    0  â‹…  0    (    n  2   -  a   )     )   +    (    x  â‹…  0   +   1  â‹…  x    )   Ï‰    =   x  +   y  Ï‰    =  Î±         normal-â‹…  Î±  1       x    y  Ï‰      1    0  Ï‰               normal-â‹…  x  1      normal-â‹…  0  0      superscript  n  2   a          normal-â‹…  x  0    normal-â‹…  1  x    Ï‰           x    y  Ï‰         Î±     \alpha\cdot 1=(x+y\omega)(1+0\omega)=\left(x\cdot 1+0\cdot 0\left(n^{2}-a%
 \right)\right)+(x\cdot 0+1\cdot x)\omega=x+y\omega=\alpha   . The only thing left for    ð…   p  2      subscript  ð…   superscript  p  2     \mathbf{F}_{p^{2}}   being a field is the existence of additive and multiplicative inverses . It is easily seen that the additive inverse of    x  +   y  Ï‰       x    y  Ï‰     x+y\omega   is     -  x   -   y  Ï‰         x     y  Ï‰     -x-y\omega   , which is an element of    ð…   p  2      subscript  ð…   superscript  p  2     \mathbf{F}_{p^{2}}   , because      -  x   ,   -  y    âˆˆ   ð…  p          x     y     subscript  ð…  p     -x,-y\in\mathbf{F}_{p}   . In fact, those are the additive inverse elements of x and y . For showing that every non-zero element   Î±   Î±   \alpha   has a multiplicative inverse, write down    Î±  =    x  1   +    y  1   Ï‰        Î±     subscript  x  1      subscript  y  1   Ï‰      \alpha=x_{1}+y_{1}\omega   and     Î±   -  1    =    x  2   +    y  2   Ï‰         superscript  Î±    1       subscript  x  2      subscript  y  2   Ï‰      \alpha^{-1}=x_{2}+y_{2}\omega   . In other words,        (    x  1   +    y  1   Ï‰    )    (    x  2   +    y  2   Ï‰    )    =    (     x  1    x  2    +    y  1    y  2    (    n  2   -  a   )     )   +    (     x  1    y  2    +    y  1    x  2     )   Ï‰    =  1             subscript  x  1      subscript  y  1   Ï‰       subscript  x  2      subscript  y  2   Ï‰            subscript  x  1    subscript  x  2       subscript  y  1    subscript  y  2      superscript  n  2   a            subscript  x  1    subscript  y  2       subscript  y  1    subscript  x  2     Ï‰         1     (x_{1}+y_{1}\omega)(x_{2}+y_{2}\omega)=\left(x_{1}x_{2}+y_{1}y_{2}\left(n^{2}-%
 a\right)\right)+\left(x_{1}y_{2}+y_{1}x_{2}\right)\omega=1   . So the two equalities       x  1    x  2    +    y  1    y  2    (    n  2   -  a   )     =  1           subscript  x  1    subscript  x  2       subscript  y  1    subscript  y  2      superscript  n  2   a     1    x_{1}x_{2}+y_{1}y_{2}(n^{2}-a)=1   and       x  1    y  2    +    y  1    x  2     =  0           subscript  x  1    subscript  y  2       subscript  y  1    subscript  x  2     0    x_{1}y_{2}+y_{1}x_{2}=0   must hold. Working out the details gives expressions for    x  2     subscript  x  2    x_{2}   and    y  2     subscript  y  2    y_{2}   , namely       x  2   =   -    y  1   -  1     x  1     (     y  1    (    n  2   -  a   )    -    x  1  2    y  1   -  1      )    -  1           subscript  x  2        superscript   subscript  y  1     1     subscript  x  1    superscript       subscript  y  1      superscript  n  2   a       superscript   subscript  x  1   2    superscript   subscript  y  1     1        1        x_{2}=-y_{1}^{-1}x_{1}\left(y_{1}\left(n^{2}-a\right)-x_{1}^{2}y_{1}^{-1}%
 \right)^{-1}   ,       y  2   =    (     y  1    (    n  2   -  a   )    -    x  1  2    y  1   -  1      )    -  1         subscript  y  2    superscript       subscript  y  1      superscript  n  2   a       superscript   subscript  x  1   2    superscript   subscript  y  1     1        1      y_{2}=\left(y_{1}\left(n^{2}-a\right)-x_{1}^{2}y_{1}^{-1}\right)^{-1}   . The inverse elements which are shown in the expressions of    x  2     subscript  x  2    x_{2}   and    y  2     subscript  y  2    y_{2}   do exist, because these are all elements of    ð…  p     subscript  ð…  p    \mathbf{F}_{p}   . This completes the first part of the proof, showing that    ð…   p  2      subscript  ð…   superscript  p  2     \mathbf{F}_{p^{2}}   is a field.  The second and middle part of the proof is showing that for every element      x  +   y  Ï‰    âˆˆ   ð…   p  2     :     (   x  +   y  Ï‰    )   p   =   x  -   y  Ï‰        normal-:      x    y  Ï‰     subscript  ð…   superscript  p  2        superscript    x    y  Ï‰    p     x    y  Ï‰       x+y\omega\in\mathbf{F}_{p^{2}}:(x+y\omega)^{p}=x-y\omega   . By definition,     Ï‰  2   =    a  2   -  n        superscript  Ï‰  2      superscript  a  2   n     \omega^{2}=a^{2}-n   is not a square in    ð…  p     subscript  ð…  p    \mathbf{F}_{p}   . Euler's criterion then says that       Ï‰   p  -  1    =    (   Ï‰  2   )     p  -  1   2    =   -  1          superscript  Ï‰    p  1     superscript   superscript  Ï‰  2       p  1   2           1      \omega^{p-1}=\left(\omega^{2}\right)^{\frac{p-1}{2}}=-1   . Thus     Ï‰  p   =   -  Ï‰        superscript  Ï‰  p     Ï‰     \omega^{p}=-\omega   . This, together with Fermat's little theorem (which says that     x  p   =  x       superscript  x  p   x    x^{p}=x   for all    x  âˆˆ   ð…  p       x   subscript  ð…  p     x\in\mathbf{F}_{p}   ) and the knowledge that in fields of characteristic  p the equation      (   a  +  b   )   p   =    a  p   +   b  p         superscript    a  b   p      superscript  a  p    superscript  b  p      \left(a+b\right)^{p}=a^{p}+b^{p}   holds, shows the desired result        (   x  +   y  Ï‰    )   p   =    x  p   +    y  p    Ï‰  p     =   x  -   y  Ï‰           superscript    x    y  Ï‰    p      superscript  x  p      superscript  y  p    superscript  Ï‰  p            x    y  Ï‰       (x+y\omega)^{p}=x^{p}+y^{p}\omega^{p}=x-y\omega   .  The third and last part of the proof is to show that if     x  0   =    (   a  +  Ï‰   )     p  +  1   2    âˆˆ   ð…   p  2           subscript  x  0    superscript    a  Ï‰       p  1   2          subscript  ð…   superscript  p  2       x_{0}=\left(a+\omega\right)^{\frac{p+1}{2}}\in\mathbf{F}_{p^{2}}   , then     x  0  2   =  n  âˆˆ   ð…  p          superscript   subscript  x  0   2   n        subscript  ð…  p      x_{0}^{2}=n\in\mathbf{F}_{p}   . Compute       x  0  2   =    (   a  +  Ï‰   )    p  +  1    =    (   a  +  Ï‰   )     (   a  +  Ï‰   )   p    =    (   a  +  Ï‰   )    (   a  -  Ï‰   )    =    a  2   -   Ï‰  2    =    a  2   -   (    a  2   -  n   )    =  n         superscript   subscript  x  0   2    superscript    a  Ï‰     p  1             a  Ï‰    superscript    a  Ï‰   p             a  Ï‰     a  Ï‰            superscript  a  2    superscript  Ï‰  2            superscript  a  2      superscript  a  2   n         n     x_{0}^{2}=\left(a+\omega\right)^{p+1}=(a+\omega)(a+\omega)^{p}=(a+\omega)(a-%
 \omega)=a^{2}-\omega^{2}=a^{2}-\left(a^{2}-n\right)=n   . Note that this computation took place in    ð…   p  2      subscript  ð…   superscript  p  2     \mathbf{F}_{p^{2}}   , so this     x  0   âˆˆ   ð…   p  2         subscript  x  0    subscript  ð…   superscript  p  2      x_{0}\in\mathbf{F}_{p^{2}}   . But with Lagrange's theorem , stating that a non-zero polynomial of degree n has at most n roots in any field K , and the knowledge that     x  2   -  n       superscript  x  2   n    x^{2}-n   has 2 roots in    ð…  p     subscript  ð…  p    \mathbf{F}_{p}   , these roots must be all of the roots in    ð…   p  2      subscript  ð…   superscript  p  2     \mathbf{F}_{p^{2}}   . It was just shown that    x  0     subscript  x  0    x_{0}   and    -   x  0        subscript  x  0     -x_{0}   are roots of     x  2   -  n       superscript  x  2   n    x^{2}-n   in    ð…   p  2      subscript  ð…   superscript  p  2     \mathbf{F}_{p^{2}}   , so it must be that      x  0   ,   -   x  0     âˆˆ   ð…  p         subscript  x  0      subscript  x  0      subscript  ð…  p     x_{0},-x_{0}\in\mathbf{F}_{p}   . 2  Speed of the algorithm  After finding a suitable a , the number of operations required for the algorithm is      4  m   +   2  k    -  4          4  m     2  k    4    4m+2k-4   multiplications,     4  m   -  2        4  m   2    4m-2   sums, where m is the number of digits in the binary representation of p and k is the number of ones in this representation. To find a by trial and error, the expected number of computations of the Legendre symbol is 2. But one can be lucky with the first try and one may need more than 2 tries. In the field    ð…   p  2      subscript  ð…   superscript  p  2     \mathbf{F}_{p^{2}}   , the following two equalities hold         (   x  +   y  Ï‰    )   2   =    (    x  2   +    y  2    Ï‰  2     )   +    (     (   x  +  y   )   2   -   x  2   -   y  2    )   Ï‰     ,       superscript    x    y  Ï‰    2        superscript  x  2      superscript  y  2    superscript  Ï‰  2          superscript    x  y   2    superscript  x  2    superscript  y  2    Ï‰      (x+y\omega)^{2}=\left(x^{2}+y^{2}\omega^{2}\right)+\left(\left(x+y\right)^{2}-%
 x^{2}-y^{2}\right)\omega,   where     Ï‰  2   =    a  2   -  n        superscript  Ï‰  2      superscript  a  2   n     \omega^{2}=a^{2}-n   is known in advance. This computation needs 4 multiplications and 4 sums.          (   x  +   y  Ï‰    )   2    (   c  +  Ï‰   )    =    (    c  d   -   b   (   x  +  d   )     )   +    (    d  2   -   b  y    )   Ï‰     ,         superscript    x    y  Ï‰    2     c  Ï‰          c  d     b    x  d          superscript  d  2     b  y    Ï‰      \left(x+y\omega\right)^{2}\left(c+\omega\right)=\left(cd-b\left(x+d\right)%
 \right)+\left(d^{2}-by\right)\omega,   where    d  =   (   x  +   y  c    )       d    x    y  c      d=(x+yc)   and    b  =   n  y       b    n  y     b=ny   . This operation needs 6 multiplications and 4 sums.  Assuming that     p  â‰¡   1     (   mod  4   )     ,      p   annotated  1   pmod  4      p\equiv 1\;\;(\mathop{{\rm mod}}4),   (in the case    p  â‰¡   3     (   mod  4   )        p   annotated  3   pmod  4      p\equiv 3\;\;(\mathop{{\rm mod}}4)   , the direct computation    x  â‰¡   Â±   n    p  +  1   4         x   plus-or-minus   superscript  n      p  1   4       x\equiv\pm n^{\frac{p+1}{4}}   is much faster) the binary expression of     (   p  +  1   )   /  2        p  1   2    (p+1)/2   has    m  -  1      m  1    m-1   digits, of which k are ones. So for computing a     (   p  +  1   )   /  2        p  1   2    (p+1)/2   power of    (   a  +  Ï‰   )      a  Ï‰    \left(a+\omega\right)   , the first formula has to be used    n  -  k  -  1      n  k  1    n-k-1   times and the second    k  -  1      k  1    k-1   times.  For this, Cipolla's algorithm is better than the Tonelli-Shanks algorithm if and only if     S   (   S  -  1   )    >    8  m   +  20         S    S  1        8  m   20     S(S-1)>8m+20   , with    2  S     superscript  2  S    2^{S}   being the maximum power of 2 which divides    p  -  1      p  1    p-1   . 3  References     E. Bach, J.O. Shallit Algorithmic Number Theory: Efficient algorithms MIT Press, (1996)   "  Category:Modular arithmetic  Category:Number theoretic algorithms  Category:Articles containing proofs     R. Crandall, C. Pomerance Prime Numbers: A Computational Perspective Springer-Verlag, (2001) p. 157 â†©  M. Baker Cipolla's Algorithm for finding square roots mod p â†©  Gonzalo Tornaria Square roots modulo p â†©     