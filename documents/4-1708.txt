   Monte Carlo integration      Monte Carlo integration   (Figure)  An illustration of Monte Carlo integration. In this example, the domain D is the inner circle and the domain E is the square. Because the square's area (4) can be easily calculated, the area of the circle (π*1 2 ) can be estimated by the ratio (0.8) of the points inside the circle (40) to the total number of points (50), yielding an approximation for the circle's area of 4*0.8 = 3.2 ≈ π*1 2 .   In mathematics , Monte Carlo integration is a technique for numerical integration using random numbers . It is a particular Monte Carlo method that numerically computes a definite integral . While other algorithms usually evaluate the integrand at a regular grid, 1 Monte Carlo randomly choose points at which the integrand is evaluated. 2 This method is particularly useful for higher-dimensional integrals. 3  There are different methods to perform a Monte Carlo integration, such as uniform sampling , stratified sampling , importance sampling , Sequential Monte Carlo (a.k.a. particle filter), and mean field particle methods.  Overview  In numerical integration, methods such as the Trapezoidal rule use a deterministic approach . Monte Carlo integration, on the other hand, employs a non-deterministic approach: each realization provides a different outcome. In Monte Carlo, the final outcome is an approximation of the correct value with respective error bars, and the correct value is within those error bars.  The problem Monte Carlo integration addresses is the computation of a multidimensional definite integral      I  =    ∫  Ω    f   (   𝐱  ¯   )   d   𝐱  ¯         I    subscript   normal-Ω     f   normal-¯  𝐱   d   normal-¯  𝐱       I=\int_{\Omega}f(\overline{\mathbf{x}})\,d\overline{\mathbf{x}}     where Ω, a subset of R m , has volume      V  =    ∫  Ω    d   𝐱  ¯         V    subscript   normal-Ω     d   normal-¯  𝐱       V=\int_{\Omega}d\overline{\mathbf{x}}     The naive Monte Carlo approach is to sample points uniformly on Ω: 4 given N uniform samples,          𝐱  ¯   1   ,  ⋯  ,    𝐱  ¯   N    ∈  Ω   ,        subscript   normal-¯  𝐱   1   normal-⋯   subscript   normal-¯  𝐱   N    normal-Ω    \overline{\mathbf{x}}_{1},\cdots,\overline{\mathbf{x}}_{N}\in\Omega,     I can be approximated by      I  ≈   Q  N   ≡   V   1  N     ∑   i  =  1   N    f   (    𝐱  ¯   i   )      =   V   ⟨  f  ⟩          I   subscript  Q  N          V    1  N     superscript   subscript     i  1    N     f   subscript   normal-¯  𝐱   i             V   delimited-⟨⟩  f       I\approx Q_{N}\equiv V\frac{1}{N}\sum_{i=1}^{N}f(\overline{\mathbf{x}}_{i})=V%
 \langle f\rangle   .  This is because the law of large numbers ensures that        lim   N  →  ∞     Q  N    =  I        subscript    normal-→  N      subscript  Q  N    I    \lim_{N\to\infty}Q_{N}=I   .  Given the estimation of I from Q N , the error bars of Q N can be estimated by the sample variance using the unbiased estimate of the variance :        Var   (  f  )    ≡   σ  N  2   =    1   N  -  1      ∑   i  =  1   N     (    f   (    𝐱  ¯   i   )    -   ⟨  f  ⟩    )   2      .          Var  f    superscript   subscript  σ  N   2            1    N  1      superscript   subscript     i  1    N    superscript      f   subscript   normal-¯  𝐱   i     delimited-⟨⟩  f    2        \mathrm{Var}(f)\equiv\sigma_{N}^{2}=\frac{1}{N-1}\sum_{i=1}^{N}\left(f(%
 \overline{\mathbf{x}}_{i})-\langle f\rangle\right)^{2}.     which leads to       Var   (   Q  N   )    =     V  2    N  2      ∑   i  =  1   N    Var   (  f  )      =    V  2     Var   (  f  )    N    =    V  2     σ  N  2   N            Var   subscript  Q  N         superscript  V  2    superscript  N  2      superscript   subscript     i  1    N     Var  f             superscript  V  2       Var  f   N            superscript  V  2      superscript   subscript  σ  N   2   N       \mathrm{Var}(Q_{N})=\frac{V^{2}}{N^{2}}\sum_{i=1}^{N}\mathrm{Var}(f)=V^{2}%
 \frac{\mathrm{Var}(f)}{N}=V^{2}\frac{\sigma_{N}^{2}}{N}   .  As long as the sequence      {   σ  1  2   ,   σ  2  2   ,   σ  3  2   ,  …  }      superscript   subscript  σ  1   2    superscript   subscript  σ  2   2    superscript   subscript  σ  3   2   normal-…    \left\{\sigma_{1}^{2},\sigma_{2}^{2},\sigma_{3}^{2},\ldots\right\}     is bounded, this variance decreases asymptotically to zero as 1/ N . The estimation of the error of Q N is thus        δ   Q  N    ≈    Var   (   Q  N   )     =   V    σ  N    N      ,          δ   subscript  Q  N        Var   subscript  Q  N            V     subscript  σ  N     N        \delta Q_{N}\approx\sqrt{\mathrm{Var}(Q_{N})}=V\frac{\sigma_{N}}{\sqrt{N}},     which decreases as    1   N       1    N     \tfrac{1}{\sqrt{N}}   . This result does not depend on the number of dimensions of the integral, which is the promised advantage of Monte Carlo integration against most deterministic methods that depend exponentially on the dimension. 5 It is important to notice that, like in deterministic methods, the estimate of the error is not a strict error bound; random sampling may not uncover all the important features of the integrand that can result in an underestimate of the error.  While the naive Monte Carlo works for simple examples, this is not the case in most problems. A large part of the Monte Carlo literature is dedicated in developing strategies to improve the error estimates. In particular, stratified sampling - dividing the region in sub-domains -, and importance sampling - sampling from non-uniform distributions - are two of such techniques.  Example  (Figure)  as a function of the number of samples, showing the scaling    1   N       1    N     \tfrac{1}{\sqrt{N}}      A paradigmatic example of a Monte Carlo integration is the estimation of π. Consider the function       H   (  x  ,  y  )    =   {     1       if   x  2    +   y  2    ≤  1       0    else            H   x  y     cases  1        if   superscript  x  2     superscript  y  2    1   0  else     H\left(x,y\right)=\begin{cases}1&\text{if }x^{2}+y^{2}\leq 1\\
 0&\text{else}\end{cases}     and the set Ω = [−1,1] × [−1,1] with V = 4. Notice that        I  π   =    ∫  Ω    H   (  x  ,  y  )   d  x  d  y    =  π   .         subscript  I  π     subscript   normal-Ω     H   x  y   d  x  d  y         π     I_{\pi}=\int_{\Omega}H(x,y)dxdy=\pi.     Thus, a crude way of calculating the value of π with Monte Carlo integration is to pick N random numbers on Ω and compute       Q  N   =   4   1  N     ∑   i  =  1   N    H   (   x  i   ,   y  i   )           subscript  Q  N     4    1  N     superscript   subscript     i  1    N     H    subscript  x  i    subscript  y  i         Q_{N}=4\frac{1}{N}\sum_{i=1}^{N}H(x_{i},y_{i})     In the figure on the right, the relative error      Q  N   -  π   π         subscript  Q  N   π   π    \tfrac{Q_{N}-\pi}{\pi}   is measured as a function of N , confirming the    1   N       1    N     \tfrac{1}{\sqrt{N}}   .  Wolfram Mathematica Example  The code below describes a process of integrating the function       f   (  x  )    =   1   1  +  sinh   (  2  x  )   log    (  x  )   2           f  x     1   fragments  1     fragments  normal-(  2  x  normal-)     superscript   fragments  normal-(  x  normal-)   2       f(x)=\frac{1}{1+\sinh(2x)\log(x)^{2}}   from     E  a    (  f  )        subscript  E  a   f    E_{a}(f)   from the above illustration was integrated within a unit square using the suggested algorithm. The sampled points were recorded and plotted. Clearly stratified sampling algorithm concentrates the points in the regions where the variation of the function is largest.]]  Recursive stratified sampling is a generalization of one-dimensional adaptive quadratures to multi-dimensional integrals. On each recursion step the integral and the error are estimated using a plain Monte Carlo algorithm. If the error estimate is larger than the required accuracy the integration volume is divided into sub-volumes and the procedure is recursively applied to sub-volumes.  The ordinary 'dividing by two' strategy does not work for multi-dimensions as the number of sub-volumes grows far too quickly to keep track. Instead one estimates along which dimension a subdivision should bring the most dividends and only subdivides the volume along this dimension.  The stratified sampling algorithm concentrates the sampling points in the regions where the variance of the function is largest thus reducing the grand variance and making the sampling more effective, as shown on the illustration.  The popular MISER routine implements a similar algorithm.  MISER Monte Carlo  The MISER algorithm is based on recursive stratified sampling . This technique aims to reduce the overall integration error by concentrating integration points in the regions of highest variance. 6  The idea of stratified sampling begins with the observation that for two disjoint regions a and b with Monte Carlo estimates of the integral     E  b    (  f  )        subscript  E  b   f    E_{b}(f)   and     σ  a  2    (  f  )        superscript   subscript  σ  a   2   f    \sigma_{a}^{2}(f)   and variances     σ  b  2    (  f  )        superscript   subscript  σ  b   2   f    \sigma_{b}^{2}(f)   and     E   (  f  )    =     1  2     (     E  a    (  f  )    +    E  b    (  f  )     )          E  f       1  2        subscript  E  a   f      subscript  E  b   f       E(f)=\tfrac{1}{2}\left(E_{a}(f)+E_{b}(f)\right)   , the variance Var( f ) of the combined estimate       Var   (  f  )    =      σ  a  2    (  f  )     4   N  a     +     σ  b  2    (  f  )     4   N  b            Var  f          superscript   subscript  σ  a   2   f     4   subscript  N  a          superscript   subscript  σ  b   2   f     4   subscript  N  b        \mathrm{Var}(f)=\frac{\sigma_{a}^{2}(f)}{4N_{a}}+\frac{\sigma_{b}^{2}(f)}{4N_{%
 b}}   is given by,        N  a     N  a   +   N  b     =    σ  a     σ  a   +   σ  b            subscript  N  a      subscript  N  a    subscript  N  b        subscript  σ  a      subscript  σ  a    subscript  σ  b       \frac{N_{a}}{N_{a}+N_{b}}=\frac{\sigma_{a}}{\sigma_{a}+\sigma_{b}}     It can be shown that this variance is minimized by distributing the points such that,        E  g    (  f  ;  N  )    =   E   (    f  g    ;  N  )           subscript  E  g    f  N      E     f  g   N      E_{g}(f;N)=E\left(\tfrac{f}{g};N\right)     Hence the smallest error estimate is obtained by allocating sample points in proportion to the standard deviation of the function in each sub-region.  The MISER algorithm proceeds by bisecting the integration region along one coordinate axis to give two sub-regions at each step. The direction is chosen by examining all d possible bisections and selecting the one which will minimize the combined variance of the two sub-regions. The variance in the sub-regions is estimated by sampling with a fraction of the total number of points available to the current step. The same procedure is then repeated recursively for each of the two half-spaces from the best bisection. The remaining sample points are allocated to the sub-regions using the formula for N a and N b . This recursive allocation of integration points continues down to a user-specified depth where each sub-region is integrated using a plain Monte Carlo estimate. These individual values and their error estimates are then combined upwards to give an overall result and an estimate of its error.  Importance sampling  VEGAS Monte Carlo  The VEGAS algorithm takes advantage of the information stored during the sampling, and uses it and importance sampling to efficiently estimate the integral I . It samples points from the probability distribution described by the function | f | so that the points are concentrated in the regions that make the largest contribution to the integral.  In general, if the Monte Carlo integral of f is sampled with points distributed according to a probability distribution described by the function g , we obtain an estimate:        Var  g    (  f  ;  N  )    =   Var   (    f  g    ;  N  )           subscript  Var  g    f  N      Var     f  g   N      \mathrm{Var}_{g}(f;N)=\mathrm{Var}\left(\tfrac{f}{g};N\right)     with a corresponding variance,      g  =     |  f  |    I   (   |  f  |   )          g      f     I    f       g=\tfrac{|f|}{I(|f|)}     If the probability distribution is chosen as       V  g    (  f  ;  N  )        subscript  V  g    f  N     V_{g}(f;N)     then it can be shown that the variance     g   (   x  1   ,   x  2   ,  …  )    =    g  1    (   x  1   )    g  2    (   x  2   )   …         g    subscript  x  1    subscript  x  2   normal-…       subscript  g  1    subscript  x  1    subscript  g  2    subscript  x  2   normal-…     g(x_{1},x_{2},\ldots)=g_{1}(x_{1})g_{2}(x_{2})\ldots   vanishes, and the error in the estimate will be zero. In practice it is not possible to sample from the exact distribution g for an arbitrary function, so importance sampling algorithms aim to produce efficient approximations to the desired distribution.  The VEGAS algorithm approximates the exact distribution by making a number of passes over the integration region which creates the histogram of the function f . Each histogram is used to define a sampling distribution for the next pass. Asymptotically this procedure converges to the desired distribution. 7 In order to avoid the number of histogram bins growing like K d , the probability distribution is approximated by a separable function:      𝐱  ¯     normal-¯  𝐱    \overline{\mathbf{x}}     so that the number of bins required is only Kd . This is equivalent to locating the peaks of the function from the projections of the integrand onto the coordinate axes. The efficiency of VEGAS depends on the validity of this assumption. It is most efficient when the peaks of the integrand are well-localized. If an integrand can be rewritten in a form which is approximately separable this will increase the efficiency of integration with VEGAS.  VEGAS incorporates a number of additional features, and combines both stratified sampling and importance sampling. 8 The integration region is divided into a number of "boxes", with each box getting a fixed number of points (the goal is 2). Each box can then have a fractional number of bins, but if bins/box is less than two, Vegas switches to a kind variance reduction (rather than importance sampling).  This routines uses the VEGAS Monte Carlo algorithm to integrate the function f over the dim -dimensional hypercubic region defined by the lower and upper limits in the arrays xl and xu , each of size dim . The integration uses a fixed number of function calls. The result and its error estimate are based on a weighted average of independent samples.  The VEGAS algorithm computes a number of independent estimates of the integral internally, according to the iterations parameter described below, and returns their weighted average. Random sampling of the integrand can occasionally produce an estimate where the error is zero, particularly if the function is constant in some regions. An estimate with zero error causes the weighted average to break down and must be handled separately.  Importance sampling algorithm  Importance sampling provides a very important tool to perform Monte-Carlo integration. 9 The main result of importance sampling to this method is that the uniform sampling of    p   (   𝐱  ¯   )       p   normal-¯  𝐱     p(\overline{\mathbf{x}})   is a particular case of a more generic choice, on which the samples are drawn from any distribution    p   (   𝐱  ¯   )       p   normal-¯  𝐱     p(\overline{\mathbf{x}})   . The idea is that    p   (   𝐱  ¯   )   :    𝐱  ¯   1   ,  ⋯  ,    𝐱  ¯   N   ∈  V  ,     fragments  p   fragments  normal-(   normal-¯  𝐱   normal-)   normal-:  italic-   subscript   normal-¯  𝐱   1   normal-,  normal-⋯  normal-,   subscript   normal-¯  𝐱   N    V  normal-,    p(\overline{\mathbf{x}}):\qquad\overline{\mathbf{x}}_{1},\cdots,\overline{%
 \mathbf{x}}_{N}\in V,   can be chosen to decrease the variance of the measurement Q N .  Consider the following example where one would like to numerically integrate a gaussian function, centered at 0, with σ = 1, from −1000 to 1000. Naturally, if the samples are drawn uniformly on the interval [−1000, 1000], only a very small part of them would be significant to the integral. This can be improved by choosing a different distribution from where the samples are chosen, for instance by sampling according to a gaussian distribution centered at 0, with σ = 1. Of course the "right" choice strongly depends on the integrand.  Formally, given a set of samples chosen from a distribution       Q  N   ≡    1  N     ∑   i  =  1   N     f   (    𝐱  ¯   i   )     p   (    𝐱  ¯   i   )            subscript  Q  N       1  N     superscript   subscript     i  1    N       f   subscript   normal-¯  𝐱   i      p   subscript   normal-¯  𝐱   i         Q_{N}\equiv\frac{1}{N}\sum_{i=1}^{N}\frac{f(\overline{\mathbf{x}}_{i})}{p(%
 \overline{\mathbf{x}}_{i})}   the estimator for I is given by 10      p   (   𝐱  ¯   )       p   normal-¯  𝐱     p(\overline{\mathbf{x}})     Intuitively, this says that if we pick a particular sample twice as much as other samples, we weight it half as much as the other samples. This estimator is naturally valid for uniform sampling, the case where    𝐱  ¯     normal-¯  𝐱    \overline{\mathbf{x}}   is constant.  The Metropolis-Hastings algorithm is one of the most used algorithms to generate    p   (   𝐱  ¯   )       p   normal-¯  𝐱     p(\overline{\mathbf{x}})   from $p(\overline{\mathbf{x}})$ , 11 thus providing an efficient way of computing integrals.  See also   Auxiliary field Monte Carlo  Monte Carlo method in statistical physics  Monte Carlo method   Notes  References   R. E. Caflisch , Monte Carlo and quasi-Monte Carlo methods , Acta Numerica vol. 7, Cambridge University Press, 1998, pp. 1–49.  S. Weinzierl, Introduction to Monte Carlo methods ,  W.H. Press, G.R. Farrar, Recursive Stratified Sampling for Multidimensional Monte Carlo Integration, Computers in Physics, v4 (1990).  G.P. Lepage, A New Algorithm for Adaptive Multidimensional Integration, Journal of Computational Physics 27, 192-203, (1978)  G.P. Lepage, VEGAS: An Adaptive Multi-dimensional Integration Program, Cornell preprint CLNS 80-447, March 1980  J. M. Hammersley, D.C. Handscomb (1964) Monte Carlo Methods. Methuen. ISBN 0-416-52340-4      External links   Café math : Monte Carlo Integration : A blog article describing Monte Carlo integration (principle, hypothesis, confidence interval)  Module for Monte Carlo Integration  Internet Resources for Monte Carlo Integration   "  Category:Monte Carlo methods  Category:Articles with example code     Press et al, 2007, Chap. 4. ↩  Press et al, 2007, Chap. 7. ↩   Newman, 1999, Chap. 1. ↩  Press et al, 2007 ↩  Press, 1990, pp 190-195. ↩  Lepage, 1978 ↩   Newman, 1999, Chap. 2. ↩       