   Harris affine region detector      Harris affine region detector   In the fields of computer vision and image analysis , the Harris affine region detector belongs to the category of feature detection . Feature detection is a preprocessing step of several algorithms that rely on identifying characteristic points or interest points so to make correspondences between images, recognize textures, categorize objects or build panoramas.  Overview  The Harris affine detector can identify similar regions between images that are related through affine transformations and have different illuminations. These affine-invariant detectors should be capable of identifying similar regions in images taken from different viewpoints that are related by a simple geometric transformation: scaling, rotation and shearing. These detected regions have been called both invariant and covariant . On one hand, the regions are detected invariant of the image transformation but the regions covariantly change with image transformation. 1 Do not dwell too much on these two naming conventions; the important thing to understand is that the design of these interest points will make them compatible across images taken from several viewpoints. Other detectors that are affine-invariant include Hessian affine region detector , Maximally stable extremal regions , Kadir–Brady saliency detector , edge-based regions (EBR) and intensity-extrema-based regions (IBR).  Mikolajczyk and Schmid (2002) first described the Harris affine detector as it is used today in [ https://hal.inria.fr/inria-00548252/document An Affine Invariant Interest Point Detector ]. 2 Earlier works in this direction include use of affine shape adaptation by Lindeberg and Garding for computing affine invariant image descriptors and in this way reducing the influence of perspective image deformations, 3 the use affine adapted feature points for wide baseline matching by Baumberg 4 and the first use of scale invariant feature points by Lindeberg; 5 6 see also 7 for an overview of the theoretical background. The Harris affine detector relies on the combination of corner points detected thorough Harris corner detection , multi-scale analysis through Gaussian scale space and affine normalization using an iterative affine shape adaptation algorithm. The recursive and iterative algorithm follows an iterative approach to detecting these regions:   Identify initial region points using scale-invariant Harris-Laplace Detector .  For each initial point, normalize the region to be affine invariant using affine shape adaptation .  Iteratively estimate the affine region: selection of proper integration scale, differentiation scale and spatially localize interest points..  Update the affine region using these scales and spatial localizations.  Repeat step 3 if the stopping criterion is not met.   Algorithm description  Harris–Laplace detector (initial region points)  The Harris affine detector relies heavily on both the Harris measure and a Gaussian scale space representation . Therefore, a brief examination of both follow. For a more exhaustive derivations see corner detection and Gaussian scale space or their associated papers. 8 9  Harris corner measure  The Harris corner detector algorithm relies on a central principle: at a corner, the image intensity will change largely in multiple directions. This can alternatively be formulated by examining the changes of intensity due to shifts in a local window. Around a corner point, the image intensity will change greatly when the window is shifted in an arbitrary direction. Following this intuition and through a clever decomposition, the Harris detector uses the second moment matrix as the basis of its corner decisions. (See corner detection for more complete derivation). The matrix   A   A   A   , has also been called the autocorrelation matrix and has values closely related to the derivatives of image intensity .       A   (  𝐱  )    =    ∑   p  ,  q     w   (  p  ,  q  )    [       I  x  2    (  𝐱  )        I  x    I  y    (  𝐱  )          I  x    I  y    (  𝐱  )        I  y  2    (  𝐱  )       ]           A  𝐱     subscript    p  q      w   p  q        superscript   subscript  I  x   2   𝐱      subscript  I  x    subscript  I  y   𝐱        subscript  I  x    subscript  I  y   𝐱      superscript   subscript  I  y   2   𝐱         A(\mathbf{x})=\sum_{p,q}w(p,q)\begin{bmatrix}I_{x}^{2}(\mathbf{x})&I_{x}I_{y}(%
 \mathbf{x})\\
 I_{x}I_{y}(\mathbf{x})&I_{y}^{2}(\mathbf{x})\\
 \end{bmatrix}     where    I  x     subscript  I  x    I_{x}   and    I  y     subscript  I  y    I_{y}   are the respective derivatives (of pixel intensity) in the   x   x   x   and   y   y   y   direction at point   𝐱   𝐱   \mathbf{x}   and   p   p   p   and   q   q   q   are the values of the weighting function. The off-diagonal entries are the product of    I  x     subscript  I  x    I_{x}   and    I  y     subscript  I  y    I_{y}   , while the diagonal entries are squares of the respective derivatives . The weighting function    w   (  x  ,  y  )       w   x  y     w(x,y)   can be uniform, but is more typically an isotropic, circular Gaussian,       w   (  x  ,  y  )    =   g   (  x  ,  y  ,  σ  )    =    1   2  π   σ  2      e   (   -     x  2   +   y  2     2   σ  2      )             w   x  y      g   x  y  σ             1    2  π   superscript  σ  2      superscript  e         superscript  x  2    superscript  y  2      2   superscript  σ  2           w(x,y)=g(x,y,\sigma)=\frac{1}{2\pi\sigma^{2}}e^{\left(-\frac{x^{2}+y^{2}}{2%
 \sigma^{2}}\right)}     that acts to average in a local region while weighting those values near the center more heavily.  As it turns out, this   A   A   A   matrix describes the shape of the autocorrelation measure as due to shifts in window location. Thus, if we let    λ  1     subscript  λ  1    \lambda_{1}   and    λ  2     subscript  λ  2    \lambda_{2}   be the eigenvalues of   A   A   A   , then these values will provide a quantitative description of how the autocorrelation measure changes in space: its principal curvatures. As Harris and Stephens (1988) point out, the   A   A   A   matrix centered on corner points will have two large, positive eigenvalues. 10 Rather than extracting these eigenvalues using methods like singular value decomposition, the Harris measure based on the trace and determinant is used:      R  =    det   (  A  )    -   α    trace  2    (  A  )      =     λ  1    λ  2    -   α    (    λ  1   +   λ  2    )   2           R      A     α    superscript  trace  2   A               subscript  λ  1    subscript  λ  2      α   superscript     subscript  λ  1    subscript  λ  2    2        R=\det(A)-\alpha\operatorname{trace}^{2}(A)=\lambda_{1}\lambda_{2}-\alpha(%
 \lambda_{1}+\lambda_{2})^{2}     where   α   α   \alpha   is a constant. Corner points have large, positive eigenvalues and would thus have a large Harris measure. Thus, corner points are identified as local maxima of the Harris measure that are above a specified threshold.        {   x  c   }   =   {   x  c   |     R   (   x  c   )    >   R   (   x  i   )     ,    ∀   x  i    ∈   W   (   x  c   )      }    ,        subscript  x  c     conditional-set   subscript  x  c    formulae-sequence      R   subscript  x  c      R   subscript  x  i        for-all   subscript  x  i      W   subscript  x  c         \displaystyle\{x_{c}\}=\big\{x_{c}|R(x_{c})>R(x_{i}),\forall x_{i}\in W(x_{c})%
 \big\},     where    {   x  c   }      subscript  x  c     \{x_{c}\}   are the set of all corner points,    R   (  x  )       R  x    R(x)   is the Harris measure calculated at   x   x   x   ,    W   (   x  c   )       W   subscript  x  c     W(x_{c})   is an 8-neighbor set centered around    x  c     subscript  x  c    x_{c}   and    t   t  h  r  e  s  h  o  l  d      subscript  t    t  h  r  e  s  h  o  l  d     t_{threshold}   is a specified threshold.  Gaussian scale-space  A Gaussian scale space representation of an image is the set of images that result from convolving a Gaussian kernel of various sizes with the original image. In general, the representation can be formulated as:       L   (  𝐱  ,  s  )    =     G   (  s  )    ⊗  I    (  𝐱  )          L   𝐱  s       tensor-product    G  s   I   𝐱     L(\mathbf{x},s)=G(s)\otimes I(\mathbf{x})     where    G   (  s  )       G  s    G(s)   is an isotropic, circular Gaussian kernel as defined above. The convolution with a Gaussian kernel smooths the image using a window the size of the kernel. A larger scale,   s   s   s   , corresponds to a smoother resultant image. Mikolajczyk and Schmid (2001) point out that derivatives and other measurements must be normalized across scales. 11 A derivative of order   m   m   m   ,    D    i  1   ,   …   i  m        subscript  D    subscript  i  1     normal-…   subscript  i  m       D_{i_{1},...i_{m}}   , must be normalized by a factor    s  m     superscript  s  m    s^{m}   in the following manner:        D    i  1   ,  …  ,   i  m      (  𝐱  ,  s  )    =    s  m    L    i  1   ,  …  ,   i  m      (  𝐱  ,  s  )           subscript  D    subscript  i  1   normal-…   subscript  i  m      𝐱  s       superscript  s  m    subscript  L    subscript  i  1   normal-…   subscript  i  m      𝐱  s      D_{i_{1},\dots,i_{m}}(\mathbf{x},s)=s^{m}L_{i_{1},\dots,i_{m}}(\mathbf{x},s)     These derivatives, or any arbitrary measure, can be adapted to a scale space representation by calculating this measure using a set of scales recursively where the    n  t  h      n  t  h    nth   scale is     s  n   =    k  n    s  0         subscript  s  n      superscript  k  n    subscript  s  0      s_{n}=k^{n}s_{0}   . See scale space for a more complete description.  Combining Harris detector across Gaussian scale-space  The Harris-Laplace detector combines the traditional 2D Harris corner detector with the idea of a Gaussian scale space representation in order to create a scale-invariant detector. Harris-corner points are good starting points because they have been shown to have good rotational and illumination invariance in addition to identifying the interesting points of the image. 12 However, the points are not scale invariant and thus the second-moment matrix must be modified to reflect a scale-invariant property. Let us denote,    M  =   μ   (  𝐱  ,   σ  I   ,   σ  D   )        M    μ   𝐱   subscript  σ  I    subscript  σ  D       M=\mu(\mathbf{x},\sigma_{\mathit{I}},\sigma_{\mathit{D}})   as the scale adapted second-moment matrix used in the Harris-Laplace detector.      M  =   μ   (  𝐱  ,   σ  I   ,   σ  D   )    =     σ  D  2   g   (   σ  I   )    ⊗   [       L  x  2    (  𝐱  ,   σ  D   )        L  x    L  y    (  𝐱  ,   σ  D   )          L  x    L  y    (  𝐱  ,   σ  D   )        L  y  2    (  𝐱  ,   σ  D   )       ]          M    μ   𝐱   subscript  σ  I    subscript  σ  D           tensor-product     superscript   subscript  σ  D   2   g   subscript  σ  I         superscript   subscript  L  x   2    𝐱   subscript  σ  D        subscript  L  x    subscript  L  y    𝐱   subscript  σ  D          subscript  L  x    subscript  L  y    𝐱   subscript  σ  D        superscript   subscript  L  y   2    𝐱   subscript  σ  D           M=\mu(\mathbf{x},\sigma_{\mathit{I}},\sigma_{\mathit{D}})=\sigma_{D}^{2}g(%
 \sigma_{I})\otimes\begin{bmatrix}L_{x}^{2}(\mathbf{x},\sigma_{D})&L_{x}L_{y}(%
 \mathbf{x},\sigma_{D})\\
 L_{x}L_{y}(\mathbf{x},\sigma_{D})&L_{y}^{2}(\mathbf{x},\sigma_{D})\end{bmatrix}    13  where    g   (   σ  I   )       g   subscript  σ  I     g(\sigma_{I})   is the Gaussian kernel of scale    σ  I     subscript  σ  I    \sigma_{I}   and    𝐱  =   (  x  ,  y  )       𝐱   x  y     \mathbf{x}=(x,y)   . Similar to the Gaussian-scale space,    L   (  𝐱  )       L  𝐱    L(\mathbf{x})   is the Gaussian-smoothed image. The   ⊗   tensor-product   \mathbf{\otimes}   operator denotes convolution.     L  x    (  𝐱  ,   σ  D   )        subscript  L  x    𝐱   subscript  σ  D      L_{x}(\mathbf{x},\sigma_{D})   and     L  y    (  𝐱  ,   σ  D   )        subscript  L  y    𝐱   subscript  σ  D      L_{y}(\mathbf{x},\sigma_{D})   are the derivatives in their respective direction applied to the smoothed image and calculated using a Gaussian kernel with scale    σ  D     subscript  σ  D    \sigma_{D}   . In terms of our Gaussian scale-space framework, the    σ  I     subscript  σ  I    \sigma_{I}   parameter determines the current scale at which the Harris corner points are detected.  Building upon this scale-adapted second-moment matrix, the Harris-Laplace detector is a twofold process: applying the Harris corner detector at multiple scales and automatically choosing the characteristic scale .  Multi-scale Harris corner points  The algorithm searches over a fixed number of predefined scales. This set of scales is defined as:        σ  1   …   σ  n    =    k  1    σ  0   …   k  n    σ  0           subscript  σ  1   normal-…   subscript  σ  n       superscript  k  1    subscript  σ  0   normal-…   superscript  k  n    subscript  σ  0      {\sigma_{1}\dots\sigma_{n}}={k^{1}\sigma_{0}\dots k^{n}\sigma_{0}}     Mikolajczyk and Schmid (2004) use    k  =  1.4      k  1.4    k=1.4   . For each integration scale,    σ  I     subscript  σ  I    \sigma_{I}   , chosen from this set, the appropriate differentiation scale is chosen to be a constant factor of the integration scale     σ  D   =   s   σ  I         subscript  σ  D     s   subscript  σ  I      \sigma_{D}=s\sigma_{I}   . Mikolajczyk and Schmid (2004) used    s  =  0.7      s  0.7    s=0.7   . 14 Using these scales, the interest points are detected using a Harris measure on the    μ   (  𝐱  ,   σ  I   ,   σ  D   )       μ   𝐱   subscript  σ  I    subscript  σ  D      \mu(\mathbf{x},\sigma_{\mathit{I}},\sigma_{\mathit{D}})   matrix. The cornerness, like the typical Harris measure, is defined as:      𝑐𝑜𝑟𝑛𝑒𝑟𝑛𝑒𝑠𝑠  =    det   (   μ   (  𝐱  ,   σ  I   ,   σ  D   )    )    -   α    trace  2    (   μ   (  𝐱  ,   σ  I   ,   σ  D   )    )          𝑐𝑜𝑟𝑛𝑒𝑟𝑛𝑒𝑠𝑠        μ   𝐱   subscript  σ  I    subscript  σ  D        α    superscript  trace  2     μ   𝐱   subscript  σ  I    subscript  σ  D          \mathit{cornerness}=\det(\mu(\mathbf{x},\sigma_{\mathit{I}},\sigma_{\mathit{D}%
 }))-\alpha\operatorname{trace}^{2}(\mu(\mathbf{x},\sigma_{\mathit{I}},\sigma_{%
 \mathit{D}}))     Like the traditional Harris detector, corner points are those local (8 point neighborhood) maxima of the cornerness that are above a specified threshold.  Characteristic scale identification  An iterative algorithm based on Lindeberg (1998) both spatially localizes the corner points and selects the characteristic scale . 15 The iterative search has three key steps, that are carried for each point   𝐱   𝐱   \mathbf{x}   that were initially detected at scale    σ  I     subscript  σ  I    \sigma_{I}   by the multi-scale Harris detector (   k   k   k   indicates the    k  t  h      k  t  h    kth   iteration):   Choose the scale    σ  I   (   k  +  1   )      superscript   subscript  σ  I     k  1     \sigma_{I}^{(k+1)}   that maximizes the Laplacian-of-Gaussians (LoG) over a predefined range of neighboring scales. The neighboring scales are typically chosen from a range that is within a two scale-space neighborhood. That is, if the original points were detected using a scaling factor of   1.4   1.4   1.4   between successive scales, a two scale-space neighborhood is the range    t  ∈   [  0.7  ,  …  ,  1.4  ]       t   0.7  normal-…  1.4     t\in[0.7,\dots,1.4]   . Thus the Gaussian scales examined are     σ  I   (   k  +  1   )    =   t   σ  I  k         superscript   subscript  σ  I     k  1      t   superscript   subscript  σ  I   k      \sigma_{I}^{(k+1)}=t\sigma_{I}^{k}   . The LoG measurement is defined as:        det   (   L  o  G   (  𝐱  ,   σ  I   )    )    =    σ  I  2    det   (     L   x  x     (  𝐱  ,   σ  I   )    +    L   y  y     (  𝐱  ,   σ  I   )     )             L  o  G   𝐱   subscript  σ  I         superscript   subscript  σ  I   2          subscript  L    x  x     𝐱   subscript  σ  I        subscript  L    y  y     𝐱   subscript  σ  I          \det(LoG(\mathbf{x},\sigma_{I}))=\sigma_{I}^{2}\det(L_{xx}(\mathbf{x},\sigma_{%
 I})+L_{yy}(\mathbf{x},\sigma_{I}))      where    L   x  x      subscript  L    x  x     L_{xx}   and    L   y  y      subscript  L    y  y     L_{yy}   are the second derivatives in their respective directions. 16 The    σ  I  2     superscript   subscript  σ  I   2    \sigma_{I}^{2}   factor (as discussed above in Gaussian scale-space) is used to normalize the LoG across scales and make these measures comparable, thus making a maximum relevant. Mikolajczyk and Schmid (2001) demonstrate that the LoG measure attains the highest percentage of correctly detected corner points in comparison to other scale-selection measures. 17 The scale which maximizes this LoG measure in the two scale-space neighborhood is deemed the characteristic scale,     σ  I   (   k  +  1   )      superscript   subscript  σ  I     k  1     \sigma_{I}^{(k+1)}   , and used in subsequent iterations. If no extrema, or maxima of the LoG is found, this point is discarded from future searches.    Using the characteristic scale, the points are spatially localized. That is to say, the point    𝐱   (   k  +  1   )      superscript  𝐱    k  1     \mathbf{x}^{(k+1)}   is chosen such that it maximizes the Harris corner measure ( cornerness as defined above) within an 8×8 local neighborhood.    Stopping criterion      σ  I   (   k  +  1   )    =  =   σ  I   (  k  )       fragments   superscript   subscript  σ  I     k  1       superscript   subscript  σ  I   k     \sigma_{I}^{(k+1)}==\sigma_{I}^{(k)}   and     𝐱   (   k  +  1   )    =  =   𝐱   (  k  )       fragments   superscript  𝐱    k  1       superscript  𝐱  k     \mathbf{x}^{(k+1)}==\mathbf{x}^{(k)}   .   If the stopping criterion is not met, then the algorithm repeats from step 1 using the new    k  +  1      k  1    k+1   points and scale. When the stopping criterion is met, the found points represent those that maximize the LoG across scales (scale selection) and maximize the Harris corner measure in a local neighborhood (spatial selection).  Affine-invariant points  Mathematical theory  The Harris-Laplace detected points are scale invariant and work well for isotropic regions that are viewed from the same viewing angle. In order to be invariant to arbitrary affine transformations (and viewpoints), the mathematical framework must be revisited. The second-moment matrix   μ   μ   \mathbf{\mu}   is defined more generally for anisotropic regions:       μ   (  𝐱  ,   Σ  I   ,   Σ  D   )    =   det     (   Σ  D   )   g   (   Σ  I   )    *   (    ∇  L    (  𝐱  ,   Σ  D   )    ∇  L     (  𝐱  ,   Σ  D   )   T    )           μ   𝐱   subscript  normal-Σ  I    subscript  normal-Σ  D            subscript  normal-Σ  D   g   subscript  normal-Σ  I       normal-∇  L    𝐱   subscript  normal-Σ  D     normal-∇  L    superscript   𝐱   subscript  normal-Σ  D    T        \mu(\mathbf{x},\Sigma_{I},\Sigma_{D})=\det(\Sigma_{D})g(\Sigma_{I})*(\nabla L(%
 \mathbf{x},\Sigma_{D})\nabla L(\mathbf{x},\Sigma_{D})^{T})     where    Σ  I     subscript  normal-Σ  I    \Sigma_{I}   and    Σ  D     subscript  normal-Σ  D    \Sigma_{D}   are covariance matrices defining the differentiation and the integration Gaussian kernel scales. Although this may look significantly different from the second-moment matrix in the Harris-Laplace detector; it is in fact, identical. The earlier   μ   μ   \mu   matrix was the 2D-isotropic version in which the covariance matrices    Σ  I     subscript  normal-Σ  I    \Sigma_{I}   and    Σ  D     subscript  normal-Σ  D    \Sigma_{D}   were 2x2 identity matrices multiplied by factors    σ  I     subscript  σ  I    \sigma_{I}   and    σ  D     subscript  σ  D    \sigma_{D}   , respectively. In the new formulation, one can think of Gaussian kernels as a multivariate Gaussian distributions as opposed to a uniform Gaussian kernel. A uniform Gaussian kernel can be thought of as an isotropic, circular region. Similarly, a more general Gaussian kernel defines an ellipsoid. In fact, the eigenvectors and eigenvalues of the covariance matrix define the rotation and size of the ellipsoid. Thus we can easily see that this representation allows us to completely define an arbitrary elliptical affine region over which we want to integrate or differentiate.  The goal of the affine invariant detector is to identify regions in images that are related through affine transformations. We thus consider a point    𝐱  L     subscript  𝐱  L    \mathbf{x}_{L}   and the transformed point     𝐱  R   =   A   𝐱  L         subscript  𝐱  R     A   subscript  𝐱  L      \mathbf{x}_{R}=A\mathbf{x}_{L}   , where A is an affine transformation. In the case of images, both    𝐱  R     subscript  𝐱  R    \mathbf{x}_{R}   and    𝐱  L     subscript  𝐱  L    \mathbf{x}_{L}   live in    R  2     superscript  R  2    R^{2}   space. The second-moment matrices are related in the following manner: 18      μ   (   𝐱  L   ,   Σ   I  ,  L    ,   Σ   D  ,  L    )       μ    subscript  𝐱  L    subscript  normal-Σ   I  L     subscript  normal-Σ   D  L       \displaystyle\mu(\mathbf{x}_{L},\Sigma_{I,L},\Sigma_{D,L})     where    Σ   I  ,  b      subscript  normal-Σ   I  b     \Sigma_{I,b}   and    Σ   D  ,  b      subscript  normal-Σ   D  b     \Sigma_{D,b}   are the covariance matrices for the   b   b   b   reference frame. If we continue with this formulation and enforce that       Σ   I  ,  L    =    σ  I    M  L   -  1          subscript  normal-Σ   I  L       subscript  σ  I    superscript   subscript  M  L     1       \displaystyle\Sigma_{I,L}=\sigma_{I}M_{L}^{-1}     where    σ  I     subscript  σ  I    \sigma_{I}   and    σ  D     subscript  σ  D    \sigma_{D}   are scalar factors, one can show that the covariance matrices for the related point are similarly related:       Σ   I  ,  R    =    σ  I    M  R   -  1          subscript  normal-Σ   I  R       subscript  σ  I    superscript   subscript  M  R     1       \displaystyle\Sigma_{I,R}=\sigma_{I}M_{R}^{-1}     By requiring the covariance matrices to satisfy these conditions, several nice properties arise. One of these properties is that the square root of the second-moment matrix,    M    1  2       superscript  M    1  2     M^{\tfrac{1}{2}}   will transform the original anisotropic region into isotropic regions that are related simply through a pure rotation matrix   R   R   R   . These new isotropic regions can be thought of as a normalized reference frame. The following equations formulate the relation between the normalized points    x  R    ′      superscript   subscript  x  R    normal-′     x_{R}^{^{\prime}}   and    x  L    ′      superscript   subscript  x  L    normal-′     x_{L}^{^{\prime}}   :      A  =    M  R   -    1  2      R   M  L    1  2          A     superscript   subscript  M  R       1  2     R   superscript   subscript  M  L     1  2       \displaystyle A=M_{R}^{-\tfrac{1}{2}}RM_{L}^{\tfrac{1}{2}}     The rotation matrix can be recovered using gradient methods likes those in the SIFT descriptor. As discussed with the Harris detector, the eigenvalues and eigenvectors of the second-moment matrix,    M  =   μ   (  𝐱  ,   Σ  I   ,   Σ  D   )        M    μ   𝐱   subscript  normal-Σ  I    subscript  normal-Σ  D       M=\mu(\mathbf{x},\Sigma_{I},\Sigma_{D})   characterize the curvature and shape of the pixel intensities. That is, the eigenvector associated with the largest eigenvalue indicates the direction of largest change and the eigenvector associated with the smallest eigenvalue defines the direction of least change. In the 2D case, the eigenvectors and eigenvalues define an ellipse. For an isotropic region, the region should be circular in shape and not elliptical. This is the case when the eigenvalues have the same magnitude. Thus a measure of the isotropy around a local region is defined as the following:      𝒬  =     λ  min    (  M  )      λ  max    (  M  )         𝒬       subscript  λ    M      subscript  λ    M      \mathcal{Q}=\frac{\lambda_{\min}(M)}{\lambda_{\max}(M)}     where   λ   λ   \lambda   denote eigenvalues. This measure has the range    [   0  …  1   ]     delimited-[]    0  normal-…  1     [0\dots 1]   . A value of   1   1   1   corresponds to perfect isotropy.  Iterative algorithm  Using this mathematical framework, the Harris affine detector algorithm iteratively discovers the second-moment matrix that transforms the anisotropic region into a normalized region in which the isotropic measure is sufficiently close to one. The algorithm uses this shape adaptation matrix ,   U   U   U   , to transform the image into a normalized reference frame. In this normalized space, the interest points' parameters (spatial location, integration scale and differentiation scale) are refined using methods similar to the Harris-Laplace detector. The second-moment matrix is computed in this normalized reference frame and should have an isotropic measure close to one at the final iteration. At every   k   k   k   th iteration, each interest region is defined by several parameters that the algorithm must discover: the    U   (  k  )      superscript  U  k    U^{(k)}   matrix, position    𝐱   (  k  )      superscript  𝐱  k    \mathbf{x}^{(k)}   , integration scale    σ  I   (  k  )      superscript   subscript  σ  I   k    \sigma_{I}^{(k)}   and differentiation scale    σ  D   (  k  )      superscript   subscript  σ  D   k    \sigma_{D}^{(k)}   . Because the detector computes the second-moment matrix in the transformed domain, it's convenient to denote this transformed position as    𝐱  w   (  k  )      superscript   subscript  𝐱  w   k    \mathbf{x}_{w}^{(k)}   where      U   (  k  )     𝐱  w   (  k  )     =   𝐱   (  𝐤  )           superscript  U  k    superscript   subscript  𝐱  w   k     superscript  𝐱  𝐤     U^{(k)}\mathbf{x}_{w}^{(k)}=\mathbf{x^{(k)}}   .  {\operatorname{argmax}} \, \sigma_I^2 \det(L_{xx}(\mathbf{x}, \sigma_I) + L_{yy}(\mathbf{x},\sigma_I))  It's important to note that the integration scale in the    U  -   n  o  r  m  a  l  i  z  e  d       U    n  o  r  m  a  l  i  z  e  d     U-normalized   space differs significantly than the non-normalized space. Therefore, it is necessary to search for the integration scale as opposed to using the scale in the non-normalized space. |4= Select the differentiation scale ,    σ  D   (  k  )      superscript   subscript  σ  D   k    \sigma_{D}^{(k)}   . In order to reduce the search space and degrees of freedom, the differentiation scale is taken to be related to the integration scale through a constant factor     σ  D  k   =   s   σ  I  k         superscript   subscript  σ  D   k     s   superscript   subscript  σ  I   k      \sigma_{D}^{k}=s\sigma_{I}^{k}   . For obvious reasons, the constant factor is less than one. Mikolajczyk and Schmid (2001) note that a too small factor will make smoothing (integration) too significant in comparison to differentiation and a factor that's too large will not allow for the integration to average the covariance matrix. 19 It is common to choose    s  ∈   [  0.5  ,  0.75  ]       s   0.5  0.75     s\in[0.5,0.75]   . From this set, the chosen scale will maximize the isotropic measure    𝒬  =     λ   m  i  n     (  μ  )      λ   m  a  x     (  μ  )         𝒬       subscript  λ    m  i  n    μ      subscript  λ    m  a  x    μ      \mathcal{Q}=\frac{\lambda_{min}(\mu)}{\lambda_{max}(\mu)}   .       σ  D   (  k  )    =     argmax     σ  D   =   s   σ  I   (  k  )      ,   s  ∈   [  0.5  ,  …  ,  0.75  ]          λ  min    (   μ   (   𝐱  w   (  k  )    ,   σ  I  k   ,   σ  D   )    )      λ  max    (   μ   (   𝐱  w   (  k  )    ,   σ  I  k   ,   σ  D   )    )           superscript   subscript  σ  D   k       formulae-sequence     subscript  σ  D     s   superscript   subscript  σ  I   k       s   0.5  normal-…  0.75     argmax        subscript  λ      μ    superscript   subscript  𝐱  w   k    superscript   subscript  σ  I   k    subscript  σ  D         subscript  λ      μ    superscript   subscript  𝐱  w   k    superscript   subscript  σ  I   k    subscript  σ  D          \sigma_{D}^{(k)}=\underset{\sigma_{D}=s\sigma_{I}^{(k)},\;s\in[0.5,\dots,0.75]%
 }{\operatorname{argmax}}\,\frac{\lambda_{\min}(\mu(\mathbf{x}_{w}^{(k)},\sigma%
 _{I}^{k},\sigma_{D}))}{\lambda_{\max}(\mu(\mathbf{x}_{w}^{(k)},\sigma_{I}^{k},%
 \sigma_{D}))}     where    μ   (   𝐱  w   (  k  )    ,   σ  I  k   ,   σ  D   )       μ    superscript   subscript  𝐱  w   k    superscript   subscript  σ  I   k    subscript  σ  D      \mu(\mathbf{x}_{w}^{(k)},\sigma_{I}^{k},\sigma_{D})   is the second-moment matrix evaluated in the normalized reference frame. This maximization processes causes the eigenvalues to converge to the same value. |5= Spatial Localization: Select the point    𝐱  w   (  k  )      superscript   subscript  𝐱  w   k    \mathbf{x}_{w}^{(k)}   that maximizes the Harris corner measure (   𝑐𝑜𝑟𝑛𝑒𝑟𝑛𝑒𝑠𝑠   𝑐𝑜𝑟𝑛𝑒𝑟𝑛𝑒𝑠𝑠   \mathit{cornerness}   ) within an 8-point neighborhood around the previous    𝐱  w   (   k  -  1   )      superscript   subscript  𝐱  w     k  1     \mathbf{x}_{w}^{(k-1)}   point.       𝐱  w   (  k  )    =      argmax    𝐱  w   ∈   W   (   𝐱  w   (   k  -  1   )    )        det   (   μ   (   𝐱  w   ,   σ  I  k   ,   σ  D   (  k  )    )    )     -   α    trace  2    (   μ   (   𝐱  w   ,   σ  I  k   ,   σ  D   (  k  )    )    )           superscript   subscript  𝐱  w   k           subscript  𝐱  w     W   superscript   subscript  𝐱  w     k  1      argmax       μ    subscript  𝐱  w    superscript   subscript  σ  I   k    superscript   subscript  σ  D   k         α    superscript  trace  2     μ    subscript  𝐱  w    superscript   subscript  σ  I   k    superscript   subscript  σ  D   k          \mathbf{x}_{w}^{(k)}=\underset{\mathbf{x}_{w}\in W(\mathbf{x}_{w}^{(k-1)})}{%
 \operatorname{argmax}}\,\det(\mu(\mathbf{x}_{w},\sigma_{I}^{k},\sigma_{D}^{(k)%
 }))-\alpha\operatorname{trace}^{2}(\mu(\mathbf{x}_{w},\sigma_{I}^{k},\sigma_{D%
 }^{(k)}))     where   μ   μ   \mu   is the second-moment matrix as defined above. The window    W   (   𝐱  w   (   k  -  1   )    )       W   superscript   subscript  𝐱  w     k  1      W(\mathbf{x}_{w}^{(k-1)})   is the set of 8-nearest neighbors of the previous iteration's point in the normalized reference frame.  Because our spatial localization was done in the   U   U   U   -normalized reference frame, the newly chosen point must be transformed back to the original reference frame. This is achieved by transforming a displacement vector and adding this to the previous point:       𝐱   (  k  )    =    𝐱   (   k  -  1   )    +    U   (   k  -  1   )    ⋅   (    𝐱  w   (  k  )    -   𝐱  w   (   k  -  1   )     )          superscript  𝐱  k      superscript  𝐱    k  1     normal-⋅   superscript  U    k  1       superscript   subscript  𝐱  w   k    superscript   subscript  𝐱  w     k  1         \mathbf{x}^{(k)}=\mathbf{x}^{(k-1)}+U^{(k-1)}\cdot(\mathbf{x}_{w}^{(k)}-%
 \mathbf{x}_{w}^{(k-1)})     |6= As mentioned above, the square-root of the second-moment matrix defines the transformation matrix that generates the normalized reference frame. We thus need to save this matrix     μ  i   (  k  )    =    μ   -    1  2       (   𝐱  w   (  k  )    ,   σ  I   (  k  )    ,   σ  D   (  k  )    )         superscript   subscript  μ  i   k      superscript  μ      1  2       superscript   subscript  𝐱  w   k    superscript   subscript  σ  I   k    superscript   subscript  σ  D   k       \mu_{i}^{(k)}=\mu^{-\tfrac{1}{2}}(\mathbf{x}_{w}^{(k)},\sigma_{I}^{(k)},\sigma%
 _{D}^{(k)})   . The transformation matrix   U   U   U   is updated     U   (  k  )    =    μ  i   (  k  )    ⋅   U   (   k  -  1   )          superscript  U  k    normal-⋅   superscript   subscript  μ  i   k    superscript  U    k  1       U^{(k)}=\mu_{i}^{(k)}\cdot U^{(k-1)}   . In order to ensure that the image gets sampled correctly and we are expanding the image in the direction of the least change (smallest eigenvalue), we fix the maximum eigenvalue      λ   m  a  x     (   U   (  k  )    )    =  1         subscript  λ    m  a  x     superscript  U  k    1    \lambda_{max}(U^{(k)})=1   . Using this updating method, one can easily see that the final   U   U   U   matrix takes the following form:      U  =    ∏  k     μ  i   (  k  )    ⋅   U   (  0  )      =    ∏  k      (   μ   -    1  2      )    (  k  )    ⋅   U   (  0  )            U    subscript  product  k    normal-⋅   superscript   subscript  μ  i   k    superscript  U  0            subscript  product  k    normal-⋅   superscript   superscript  μ      1  2     k    superscript  U  0        U=\prod_{k}\mu_{i}^{(k)}\cdot U^{(0)}=\prod_{k}(\mu^{-\tfrac{1}{2}})^{(k)}%
 \cdot U^{(0)}     |7= If the stopping criterion is not met, continue to the next iteration at step 2. Because the algorithm iteratively solves for the    U  -   n  o  r  m  a  l  i  z  a  t  i  o  n       U    n  o  r  m  a  l  i  z  a  t  i  o  n     U-normalization   matrix that transforms an anisotropic region into an isotropic region, it makes sense to stop when the isotropic measure,    𝒬  =     λ  min    (  μ  )      λ  max    (  μ  )         𝒬       subscript  λ    μ      subscript  λ    μ      \mathcal{Q}=\frac{\lambda_{\min}(\mu)}{\lambda_{\max}(\mu)}   , is sufficiently close to its maximum value 1. Sufficiently close implies the following stopping condition :       1  -     λ  min    (   μ  i   (  k  )    )      λ  max    (   μ  i   (  k  )    )      <   ε  C         1       subscript  λ     superscript   subscript  μ  i   k       subscript  λ     superscript   subscript  μ  i   k       subscript  ε  C     1-\frac{\lambda_{\min}(\mu_{i}^{(k)})}{\lambda_{\max}(\mu_{i}^{(k)})}<%
 \varepsilon_{C}     Mikolajczyk and Schmid (2004) had good success with     ϵ  C   =  0.05       subscript  ϵ  C   0.05    \epsilon_{C}=0.05   . }}  Computation and implementation  The computational complexity of the Harris-Affine detector is broken into two parts: initial point detection and affine region normalization. The initial point detection algorithm, Harris-Laplace, has complexity    𝒪   (  n  )       𝒪  n    \mathcal{O}(n)   where   n   n   n   is the number of pixels in the image. The affine region normalization algorithm automatically detects the scale and estimates the shape adaptation matrix ,   U   U   U   . This process has complexity    𝒪   (    (   m  +  k   )   p   )       𝒪      m  k   p     \mathcal{O}((m+k)p)   , where   p   p   p   is the number of initial points,   m   m   m   is the size of the search space for the automatic scale selection and   k   k   k   is the number of iterations required to compute the   U   U   U   matrix. 20  Some methods exist to reduce the complexity of the algorithm at the expense of accuracy. One method is to eliminate the search in the differentiation scale step. Rather than choose a factor   s   s   s   from a set of factors, the sped-up algorithm chooses the scale to be constant across iterations and points      σ  D   =   s   σ  I     ,   s  =   c  o  n  s  t  a  n  t       formulae-sequence     subscript  σ  D     s   subscript  σ  I       s    c  o  n  s  t  a  n  t      \sigma_{D}=s\sigma_{I},\;s=constant   . Although this reduction in search space might decrease the complexity, this change can severely effect the convergence of the   U   U   U   matrix.  Analysis  Convergence  One can imagine that this algorithm might identify duplicate interest points at multiple scales. Because the Harris affine algorithm looks at each initial point given by the Harris-Laplace detector independently, there is no discrimination between identical points. In practice, it has been shown that these points will ultimately all converge to the same interest point. After finishing identifying all interest points, the algorithm accounts for duplicates by comparing the spatial coordinates (   𝐱   𝐱   \mathbf{x}   ), the integration scale    σ  I     subscript  σ  I    \sigma_{I}   , the isotropic measure      λ  min    (  U  )      λ  max    (  U  )           subscript  λ    U      subscript  λ    U     \tfrac{\lambda_{\min}(U)}{\lambda_{\max}(U)}   and skew. 21 If these interest point parameters are similar within a specified threshold, then they are labeled duplicates. The algorithm discards all these duplicate points except for the interest point that's closest to the average of the duplicates. Typically 30% of the Harris affine points are distinct and dissimilar enough to not be discarded. 22  Mikolajczyk and Schmid (2004) showed that often the initial points (40%) do not converge. The algorithm detects this divergence by stopping the iterative algorithm if the inverse of the isotropic measure is larger than a specified threshold        λ  max    (  U  )      λ  min    (  U  )      >   t  diverge            subscript  λ    U      subscript  λ    U     subscript  t  diverge     \tfrac{\lambda_{\max}(U)}{\lambda_{\min}(U)}>t_{\text{diverge}}   . Mikolajczyk and Schmid (2004) use     t   d  i  v  e  r  g  e    =  6       subscript  t    d  i  v  e  r  g  e    6    t_{diverge}=6   . Of those that did converge, the typical number of required iterations was 10. 23  Quantitative measure  Quantitative analysis of affine region detectors take into account both the accuracy of point locations and the overlap of regions across two images. Mioklajcyzk and Schmid (2004) extend the repeatability measure of Schmid et al. (1998) as the ratio of point correspondences to minimum detected points of the two images. 24 25       R  score   =    C   (  A  ,  B  )     min   (   n  A   ,   n  B   )          subscript  R  score       C   A  B       subscript  n  A    subscript  n  B       R_{\text{score}}=\frac{C(A,B)}{\min(n_{A},n_{B})}     where    C   (  A  ,  B  )       C   A  B     C(A,B)   are the number of corresponding points in images   A   A   A   and   B   B   B   .    n  B     subscript  n  B    n_{B}   and    n  A     subscript  n  A    n_{A}   are the number of detected points in the respective images. Because each image represents 3D space, it might be the case that the one image contains objects that are not in the second image and thus whose interest points have no chance of corresponding. In order to make the repeatability measure valid, one remove these points and must only consider points that lie in both images;    n  A     subscript  n  A    n_{A}   and    n  B     subscript  n  B    n_{B}   only count those points such that     x  A   =   H  ⋅   x  B         subscript  x  A    normal-⋅  H   subscript  x  B      x_{A}=H\cdot x_{B}   . For a pair of two images related through a homography matrix   H   H   H   , two points,    𝐱  𝐚     subscript  𝐱  𝐚    \mathbf{x_{a}}   and    𝐱  𝐛     subscript  𝐱  𝐛    \mathbf{x_{b}}   are said to correspond if:  Robustness to affine and other transformations  Mikolajczyk et al. (2005) have done a thorough analysis of several state-of-the-art affine region detectors: Harris affine, Hessian affine , MSER , 26 IBR & EBR 27 and salient 28 detectors. 29 Mikolajczyk et al. analyzed both structured images and textured images in their evaluation. Linux binaries of the detectors and their test images are freely available at their webpage . A brief summary of the results of Mikolajczyk et al. (2005) follow; see A comparison of affine region detectors for a more quantitative analysis.   Viewpoint Angle Change: The Harris affine detector has reasonable (average) robustness to these types of changes. The detector maintains a repeatability score of above 50% up until a viewpoint angle of above 40 degrees. The detector tends to detect a high number of repeatable and matchable regions even under a large viewpoint change.  Scale Change: The Harris affine detector remains very consistent under scale changes. Although the number of points declines considerably at large scale changes (above 2.8), the repeatability (50-60%) and matching scores (25-30%) remain very constant especially with textured images. This is consistent with the high-performance of the automatic scale selection iterative algorithm.  Blurred Images: The Harris affine detector remains very stable under image blurring. Because the detector does not rely on image segmentation or region boundaries, the repeatability and matching scores remain constant.  JPEG Artifacts: The Harris affine detector degrades similar to other affine detectors: repeatability and matching scores drop significantly above 80% compression.  Illumination Changes: The Harris affine detector, like other affine detectors, is very robust to illumination changes: repeatability and matching scores remain constant under decreasing light. This should be expected because the detectors rely heavily on relative intensities (derivatives) and not absolute intensities.   General trends   Harris affine region points tend to be small and numerous. Both the Harris-Affine detector and Hessian-Affine consistently identify double the number repeatable points as other affine detectors: ~1000 regions for an 800x640 image. 30 Small regions are less likely to be occluded but have a smaller chance of overlapping neighboring regions.  The Harris affine detector responds well to textured scenes in which there are a lot of corner-like parts. However, for some structured scenes, like buildings, the Harris-Affine detector performs very well. This is complementary to MSER that tends to do better with well structured (segmentable) scenes.  Overall the Harris affine detector performs very well, but still behind MSER and Hessian-Affine in all cases but blurred images.  Harris-Affine and Hessian-Affine detectors are less accurate than others: their repeatability score increases as the overlap threshold is increased.  The detected affine-invariant regions may still differ in their rotation and illumination. Any descriptor that uses these regions must account for the invariance when using the regions for matching or other comparisons.   Applications   Content-based image retrieval 31 32  Model-based recognition  Object retrieval in video 33  Visual data mining: identifying important objects, characters and scenes in videos 34  Object recognition and categorization 35  Remotely sensed image analysis: Object detection from remotely sensed images 36   Software packages   Affine Covariant Features : K. Mikolajczyk maintains a web page that contains Linux binaries of the Harris-Affine detector in addition to other detectors and descriptors. Matlab code is also available that can be used to illustrate and compute the repeatability of various detectors. Code and images are also available to duplicate the results found in the Mikolajczyk et al. (2005) paper.  lip-vireo - binary code for Linux, Windows and SunOS from VIREO research group. See more from the homepage   External links   1 - Presentation slides from Mikolajczyk et al. on their 2005 paper.  2 - Cordelia Schmid's Computer Vision Lab  3 - Code, test Images, bibliography of Affine Covariant Features maintained by Krystian Mikolajczyk and the Visual Geometry Group from the Robotics group at the University of Oxford.  4 - Bibliography of feature (and blob) detectors maintained by USC Institute for Robotics and Intelligent Systems  5 - Digital implementation of Laplacian of Gaussian   See also   Hessian-affine  MSER  Kadir brady saliency detector  Scale space  Isotropy  Corner detection  Interest point detection  Affine shape adaptation  Image derivatives  Computer vision  ASIFT -> Affine-Sift (A fully affine invariant image matching algorithm)   References  37    "  Category:Feature detection (computer vision)      Mikolajcyk, K. and Schmid, C. 2002. An affine invariant interest point detector. In Proceedings of the 8th International Conference on Computer Vision , Vancouver, Canada. ↩  T. Lindeberg and J. Garding (1997). "Shape-adapted smoothing in estimation of 3-{D} depth cues from affine distortions of local 2-{D} structure". Image and Vision Computing 15: pp 415—434. ↩  A. Baumberg (2000). "Reliable feature matching across widely separated views". Proceedings of IEEE Conference on Computer Vision and Pattern Recognition: pages I:1774—1781. ↩  Lindeberg, Tony, Scale-Space Theory in Computer Vision, Kluwer Academic Publishers, 1994 , ISBN 0-7923-9418-6 ↩  T. Lindeberg (1998). "Feature detection with automatic scale selection". International Journal of Computer Vision 30 (2): pp 77—116. ↩  * ↩   C. Harris and M. Stephens (1988). "A combined corner and edge detector". Proceedings of the 4th Alvey Vision Conference: pages 147—151. ↩   K. Mikolajczyk and C. Schmid. Indexing based on scale invariant interest points. In Proceedings of the 8th International Conference on Computer Vision, Vancouver, Canada, pages 525-531, 2001. ↩  Schmid, C., Mohr, R., and Bauckhage, C. 2000. Evaluation of interest point detectors. International Journal of Computer Vision, 37(2):151-172. ↩  Mikolajczyk, K. and Schmid, C. 2004. Scale & affine invariant interest point detectors. International Journal on Computer Vision 60(1):63-86. ↩    Spatial Filters: Laplacian/Laplacian of Gaussian ↩          C. Schmid, R. Mohr, and C. Bauckhage. Comparing and evaluating interest points. In International Conference on Computer Vision , pp. 230-135, 1998. ↩  J.Matas, O. Chum, M. Urban, and T. Pajdla, Robust wide baseline stereo from maximally stable extremal regions. In BMVC p. 384-393, 2002. ↩  T. Tuytelaars and L. Van Gool, Matching widely separated views based on affine invariant regions. In IJCV 59(1):61-85, 2004. ↩  T. Kadir, A. Zisserman, and M. Brady, An affine invariant salient region detector. In ECCV p. 404-416, 2004. ↩  K. Mikolajczyk, T. Tuytelaars, C. Schmid, A. Zisserman, J. Matas, F. Schaffalitzky, T. Kadir and L. Van Gool, A comparison of affine region detectors. In IJCV 65(1/2):43-72, 2005 ↩   http://staff.science.uva.nl/~gevers/pub/overview.pdf ↩  R. Datta, J. Li, and J. Z. Wang, “Content-based image retrieval - Approaches and trends of the new age,” In Proc. Int. Workshop on Multimedia Information Retrieval, pp. 253-262, 2005.IEEE Transactions on Multimedia, vol. 7, no. 1, pp. 127-142, 2005. ↩  J. Sivic and A. Zisserman. Video google: A text retrieval approach to object matching in videos. In Proceedings of the International Conference on Computer Vision, Nice, France, 2003. ↩  J. Sivic and A. Zisserman. Video data mining using configurations of viewpoint invariant regions. In Proceedings of the IEEE Conference on Computer Vision and Pattern Recognition, Washington DC, USA, pp. 488-495, 2004. ↩  G. Dorko and C. Schmid. Selection of scale invariant neighborhoods for object class recognition. In Proceedings of International Conference on Computer Vision, Nice, France, pp. 634-640, 2003. ↩   ↩     