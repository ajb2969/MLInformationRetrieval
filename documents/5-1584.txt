   Crank–Nicolson method      Crank–Nicolson method   In numerical analysis , the Crank–Nicolson method is a finite difference method used for numerically solving the heat equation and similar partial differential equations . 1 It is a second-order method in time, it is implicit in time and can be written as an implicit Runge–Kutta method , and it is numerically stable . The method was developed by John Crank and Phyllis Nicolson in the mid 20th century. 2  For diffusion equations (and many other equations), it can be shown the Crank–Nicolson method is unconditionally stable . 3 However, the approximate solutions can still contain (decaying) spurious oscillations if the ratio of time step Δ   t   t   t   times the thermal diffusivity to the square of space step, Δ   x   x   x        2     2    {}^{2}   , is large (typically larger than 1/2 per Von Neumann stability analysis ). For this reason, whenever large time steps or high spatial resolution is necessary, the less accurate backward Euler method is often used, which is both stable and immune to oscillations.  The method  (Figure)  The Crank–Nicolson stencil for a 1D problem.   The Crank–Nicolson method is based on the trapezoidal rule , giving second-order convergence in time. For example, in one dimension, if the partial differential equation is        ∂  u    ∂  t    =   F   (  u  ,  x  ,  t  ,    ∂  u    ∂  x    ,     ∂  2   u    ∂   x  2     )            u     t      F   u  x  t      u     x        superscript   2   u      superscript  x  2         \frac{\partial u}{\partial t}=F\left(u,\,x,\,t,\,\frac{\partial u}{\partial x}%
 ,\,\frac{\partial^{2}u}{\partial x^{2}}\right)     then, letting     u   (   i  Δ  x   ,   n  Δ  t   )    =    u  i  n          u     i  normal-Δ  x     n  normal-Δ  t      superscript   subscript  u  i   n     u(i\Delta x,\,n\Delta t)=u_{i}^{n}\,   , the equation for Crank–Nicolson method is a combination of the forward Euler method at   n   n   n   and the backward Euler method at n + 1 (note, however, that the method itself is not simply the average of those two methods, as the equation has an implicit dependence on the solution):         u  i   n  +  1    -   u  i  n     Δ  t    =     F  i  n    (  u  ,  x  ,  t  ,    ∂  u    ∂  x    ,     ∂  2   u    ∂   x  2     )    (forward Euler)            superscript   subscript  u  i     n  1     superscript   subscript  u  i   n      normal-Δ  t        superscript   subscript  F  i   n    u  x  t      u     x        superscript   2   u      superscript  x  2       (forward Euler)     \frac{u_{i}^{n+1}-u_{i}^{n}}{\Delta t}=F_{i}^{n}\left(u,\,x,\,t,\,\frac{%
 \partial u}{\partial x},\,\frac{\partial^{2}u}{\partial x^{2}}\right)\qquad%
 \mbox{(forward Euler)}            u  i   n  +  1    -   u  i  n     Δ  t    =     F  i   n  +  1     (  u  ,  x  ,  t  ,    ∂  u    ∂  x    ,     ∂  2   u    ∂   x  2     )    (backward Euler)            superscript   subscript  u  i     n  1     superscript   subscript  u  i   n      normal-Δ  t        superscript   subscript  F  i     n  1     u  x  t      u     x        superscript   2   u      superscript  x  2       (backward Euler)     \frac{u_{i}^{n+1}-u_{i}^{n}}{\Delta t}=F_{i}^{n+1}\left(u,\,x,\,t,\,\frac{%
 \partial u}{\partial x},\,\frac{\partial^{2}u}{\partial x^{2}}\right)\qquad%
 \mbox{(backward Euler)}             u  i   n  +  1    -   u  i  n     Δ  t    =     1  2    [     F  i   n  +  1     (  u  ,  x  ,  t  ,    ∂  u    ∂  x    ,     ∂  2   u    ∂   x  2     )    +    F  i  n    (  u  ,  x  ,  t  ,    ∂  u    ∂  x    ,     ∂  2   u    ∂   x  2     )     ]    (Crank–Nicolson)    .           superscript   subscript  u  i     n  1     superscript   subscript  u  i   n      normal-Δ  t         1  2    delimited-[]       superscript   subscript  F  i     n  1     u  x  t      u     x        superscript   2   u      superscript  x  2          superscript   subscript  F  i   n    u  x  t      u     x        superscript   2   u      superscript  x  2          (Crank–Nicolson)     \frac{u_{i}^{n+1}-u_{i}^{n}}{\Delta t}=\frac{1}{2}\left[F_{i}^{n+1}\left(u,\,x%
 ,\,t,\,\frac{\partial u}{\partial x},\,\frac{\partial^{2}u}{\partial x^{2}}%
 \right)+F_{i}^{n}\left(u,\,x,\,t,\,\frac{\partial u}{\partial x},\,\frac{%
 \partial^{2}u}{\partial x^{2}}\right)\right]\qquad\mbox{(Crank--Nicolson)}.     Note that this is an implicit method : to get the "next" value of u in time, a system of algebraic equations must be solved. If the partial differential equation is nonlinear, the discretization will also be nonlinear so that advancing in time will involve the solution of a system of nonlinear algebraic equations, though linearizations are possible. In many problems, especially linear diffusion, the algebraic problem is tridiagonal and may be efficiently solved with the tridiagonal matrix algorithm , which gives a fast    𝒪   (  n  )       𝒪  n    \mathcal{O}(n)   direct solution as opposed to the usual    𝒪   (   n  3   )       𝒪   superscript  n  3     \mathcal{O}(n^{3})   for a full matrix.  Example: 1D diffusion  The Crank–Nicolson method is often applied to diffusion problems . As an example, for linear diffusion,        ∂  u    ∂  t    =   a     ∂  2   u    ∂   x  2              u     t      a      superscript   2   u      superscript  x  2        {\partial u\over\partial t}=a\frac{\partial^{2}u}{\partial x^{2}}     applying a finite difference spatial discretization for the right hand side, the Crank–Nicolson discretization is then :         u  i   n  +  1    -   u  i  n     Δ  t    =    a   2    (   Δ  x   )   2      (    (     u   i  +  1    n  +  1    -   2   u  i   n  +  1      +   u   i  -  1    n  +  1     )   +   (     u   i  +  1   n   -   2   u  i  n     +   u   i  -  1   n    )    )             superscript   subscript  u  i     n  1     superscript   subscript  u  i   n      normal-Δ  t        a    2   superscript    normal-Δ  x   2            superscript   subscript  u    i  1      n  1      2   superscript   subscript  u  i     n  1       superscript   subscript  u    i  1      n  1          superscript   subscript  u    i  1    n     2   superscript   subscript  u  i   n      superscript   subscript  u    i  1    n        \frac{u_{i}^{n+1}-u_{i}^{n}}{\Delta t}=\frac{a}{2(\Delta x)^{2}}\left((u_{i+1}%
 ^{n+1}-2u_{i}^{n+1}+u_{i-1}^{n+1})+(u_{i+1}^{n}-2u_{i}^{n}+u_{i-1}^{n})\right)     or, letting    r  =    a  Δ  t     (   Δ  x   )   2        r      a  normal-Δ  t    superscript    normal-Δ  x   2      r=\frac{a\Delta t}{(\Delta x)^{2}}   :         -   r   u   i  +  1    n  +  1      +   2   (   1  +  r   )    u  i   n  +  1      -   r   u   i  -  1    n  +  1      =    r   u   i  +  1   n    +   2   (   1  -  r   )    u  i  n    +   r    u   i  -  1   n                  r   superscript   subscript  u    i  1      n  1        2    1  r    superscript   subscript  u  i     n  1        r   superscript   subscript  u    i  1      n  1          r   superscript   subscript  u    i  1    n      2    1  r    superscript   subscript  u  i   n      r   superscript   subscript  u    i  1    n       -ru_{i+1}^{n+1}+2(1+r)u_{i}^{n+1}-ru_{i-1}^{n+1}=ru_{i+1}^{n}+2(1-r)u_{i}^{n}+%
 ru_{i-1}^{n}\,     which is a tridiagonal problem, so that     u  i   n  +  1       superscript   subscript  u  i     n  1     u_{i}^{n+1}\,   may be efficiently solved by using the tridiagonal matrix algorithm in favor of a much more costly matrix inversion .  A quasilinear equation, such as (this is a minimalistic example and not general)        ∂  u    ∂  t    =   a   (  u  )      ∂  2   u    ∂   x  2              u     t      a  u      superscript   2   u      superscript  x  2        \frac{\partial u}{\partial t}=a(u)\frac{\partial^{2}u}{\partial x^{2}}     would lead to a nonlinear system of algebraic equations which could not be easily solved as above; however, it is possible in some cases to linearize the problem by using the old value for   a   a   a   , that is     a  i  n    (  u  )        superscript   subscript  a  i   n   u    a_{i}^{n}(u)\,   instead of     a  i   n  +  1     (  u  )        superscript   subscript  a  i     n  1    u    a_{i}^{n+1}(u)\,   . Other times, it may be possible to estimate     a  i   n  +  1     (  u  )        superscript   subscript  a  i     n  1    u    a_{i}^{n+1}(u)\,   using an explicit method and maintain stability.  Example: 1D diffusion with advection for steady flow, with multiple channel connections  This is a solution usually employed for many purposes when there is a contamination problem in streams or rivers under steady flow conditions but information is given in one dimension only. Often the problem can be simplified into a 1-dimensional problem and still yield useful information.  Here we model the concentration of a solute contaminant in water. This problem is composed of three parts: the known diffusion equation (    D  x     subscript  D  x    D_{x}   chosen as constant), an advective component (which means the system is evolving in space due to a velocity field), which we choose to be a constant Ux , and a lateral interaction between longitudinal channels (k).  where C is the concentration of the contaminant and subscripts N and M correspond to previous and next channel.  The Crank–Nicolson method (where i represents position and j time) transforms each component of the PDE into the following:  {\Delta t}| 2 }}  Now we create the following constants to simplify the algebra:      λ  =     D  x   Δ  t    2  Δ   x  2         λ       subscript  D  x   normal-Δ  t     2  normal-Δ   superscript  x  2       \lambda=\frac{D_{x}\Delta t}{2\Delta x^{2}}         α  =     U  x   Δ  t    4  Δ  x        α       subscript  U  x   normal-Δ  t     4  normal-Δ  x      \alpha=\frac{U_{x}\Delta t}{4\Delta x}         β  =    k  Δ  t   2       β      k  normal-Δ  t   2     \beta=\frac{k\Delta t}{2}     and substitute (), (), (), (), (), (), α , β and λ into (). We then put the new time terms on the left ( j + 1) and the present time terms on the right ( j ) to get:           -   β   C   N  i    j  +  1      -    (   λ  +  α   )    C   i  -  1    j  +  1      +    (   1  +   2  λ   +   2  β    )    C  i   j  +  1      -    (   λ  -  α   )    C   i  +  1    j  +  1     -   β   C   M  i    j  +  1      =    β   C   N  i   j    +    (   λ  +  α   )    C   i  -  1   j    +    (   1  -   2  λ   -   2  β    )    C  i  j    +    (   λ  -  α   )    C   i  +  1   j    +   β   C   M  i   j      .                β   superscript   subscript  C    N  i      j  1          λ  α    superscript   subscript  C    i  1      j  1          1    2  λ     2  β     superscript   subscript  C  i     j  1          λ  α    superscript   subscript  C    i  1      j  1       β   superscript   subscript  C    M  i      j  1          β   superscript   subscript  C    N  i    j        λ  α    superscript   subscript  C    i  1    j        1    2  λ     2  β     superscript   subscript  C  i   j        λ  α    superscript   subscript  C    i  1    j      β   superscript   subscript  C    M  i    j       -\beta C_{Ni}^{j+1}-(\lambda+\alpha)C_{i-1}^{j+1}+(1+2\lambda+2\beta)C_{i}^{j+%
 1}-(\lambda-\alpha)C_{i+1}^{j+1}-\beta C_{Mi}^{j+1}=\beta C_{Ni}^{j}+(\lambda+%
 \alpha)C_{i-1}^{j}+(1-2\lambda-2\beta)C_{i}^{j}+(\lambda-\alpha)C_{i+1}^{j}+%
 \beta C_{Mi}^{j}.     To model the first channel, we realize that it can only be in contact with the following channel ( M ), so the expression is simplified to:          -    (   λ  +  α   )    C   i  -  1    j  +  1      +    (   1  +   2  λ   +  β   )    C  i   j  +  1      -    (   λ  -  α   )    C   i  +  1    j  +  1     -   β   C   M  i    j  +  1      =    +    (   λ  +  α   )    C   i  -  1   j     +    (   1  -   2  λ   -  β   )    C  i  j    +    (   λ  -  α   )    C   i  +  1   j    +   β   C   M  i   j      .                λ  α    superscript   subscript  C    i  1      j  1          1    2  λ   β    superscript   subscript  C  i     j  1          λ  α    superscript   subscript  C    i  1      j  1       β   superscript   subscript  C    M  i      j  1              λ  α    superscript   subscript  C    i  1    j         1    2  λ   β    superscript   subscript  C  i   j        λ  α    superscript   subscript  C    i  1    j      β   superscript   subscript  C    M  i    j       -(\lambda+\alpha)C_{i-1}^{j+1}+(1+2\lambda+\beta)C_{i}^{j+1}-(\lambda-\alpha)C%
 _{i+1}^{j+1}-\beta C_{Mi}^{j+1}=+(\lambda+\alpha)C_{i-1}^{j}+(1-2\lambda-\beta%
 )C_{i}^{j}+(\lambda-\alpha)C_{i+1}^{j}+\beta C_{Mi}^{j}.     In the same way, to model the last channel, we realize that it can only be in contact with the previous channel ( N ), so the expression is simplified to:           -   β   C   N  i    j  +  1      -    (   λ  +  α   )    C   i  -  1    j  +  1      +    (   1  +   2  λ   +  β   )    C  i   j  +  1      -    (   λ  -  α   )    C   i  +  1    j  +  1      =    β   C   N  i   j    +    (   λ  +  α   )    C   i  -  1   j    +    (   1  -   2  λ   -  β   )    C  i  j    +    (   λ  -  α   )    C   i  +  1   j      .                β   superscript   subscript  C    N  i      j  1          λ  α    superscript   subscript  C    i  1      j  1          1    2  λ   β    superscript   subscript  C  i     j  1          λ  α    superscript   subscript  C    i  1      j  1          β   superscript   subscript  C    N  i    j        λ  α    superscript   subscript  C    i  1    j        1    2  λ   β    superscript   subscript  C  i   j        λ  α    superscript   subscript  C    i  1    j       -\beta C_{Ni}^{j+1}-(\lambda+\alpha)C_{i-1}^{j+1}+(1+2\lambda+\beta)C_{i}^{j+1%
 }-(\lambda-\alpha)C_{i+1}^{j+1}=\beta C_{Ni}^{j}+(\lambda+\alpha)C_{i-1}^{j}+(%
 1-2\lambda-\beta)C_{i}^{j}+(\lambda-\alpha)C_{i+1}^{j}.     To solve this linear system of equations we must now see that boundary conditions must be given first to the beginning of the channels:      C  0  j     superscript   subscript  C  0   j    C_{0}^{j}   : initial condition for the channel at present time step     C  0   j  +  1      superscript   subscript  C  0     j  1     C_{0}^{j+1}   : initial condition for the channel at next time step     C   N  0   j     superscript   subscript  C    N  0    j    C_{N0}^{j}   : initial condition for the previous channel to the one analyzed at present time step     C   M  0   j     superscript   subscript  C    M  0    j    C_{M0}^{j}   : initial condition for the next channel to the one analyzed at present time step.  For the last cell of the channels ( z ) the most convenient condition becomes an adiabatic one, so         ∂  C    ∂  x     x  =  z    =    (    C   i  +  1    -   C   i  -  1     )    2  Δ  x    =  0.         subscript      C     x      x  z         subscript  C    i  1     subscript  C    i  1       2  normal-Δ  x         0.     \frac{\partial C}{\partial x}_{x=z}=\frac{(C_{i+1}-C_{i-1})}{2\Delta x}=0.     This condition is satisfied if and only if (regardless of a null value)        C   i  +  1    j  +  1    =   C   i  -  1    j  +  1     .       superscript   subscript  C    i  1      j  1     superscript   subscript  C    i  1      j  1      C_{i+1}^{j+1}=C_{i-1}^{j+1}.\,     Let us solve this problem (in a matrix form) for the case of 3 channels and 5 nodes (including the initial boundary condition). We express this as a linear system problem:        [      A  A      ]    [      C   j  +  1       ]    =     [   B  B   ]    [   C  j   ]    +   [  d  ]              A  A        superscript  C    j  1            delimited-[]    B  B     delimited-[]   superscript  C  j      delimited-[]  d      \begin{bmatrix}AA\end{bmatrix}\begin{bmatrix}C^{j+1}\end{bmatrix}=[BB][C^{j}]+%
 [d]     where       𝐂   𝐣  +  𝟏    =   [      C  11   j  +  1         C  12   j  +  1         C  13   j  +  1         C  14   j  +  1         C  21   j  +  1         C  22   j  +  1         C  23   j  +  1         C  24   j  +  1         C  31   j  +  1         C  32   j  +  1         C  33   j  +  1         C  34   j  +  1       ]        superscript  𝐂    𝐣  1       superscript   subscript  C  11     j  1       superscript   subscript  C  12     j  1       superscript   subscript  C  13     j  1       superscript   subscript  C  14     j  1       superscript   subscript  C  21     j  1       superscript   subscript  C  22     j  1       superscript   subscript  C  23     j  1       superscript   subscript  C  24     j  1       superscript   subscript  C  31     j  1       superscript   subscript  C  32     j  1       superscript   subscript  C  33     j  1       superscript   subscript  C  34     j  1        \mathbf{C^{j+1}}=\begin{bmatrix}C_{11}^{j+1}\\
 C_{12}^{j+1}\\
 C_{13}^{j+1}\\
 C_{14}^{j+1}\\
 C_{21}^{j+1}\\
 C_{22}^{j+1}\\
 C_{23}^{j+1}\\
 C_{24}^{j+1}\\
 C_{31}^{j+1}\\
 C_{32}^{j+1}\\
 C_{33}^{j+1}\\
 C_{34}^{j+1}\end{bmatrix}   and      𝐂  𝐣   =   [      C  11  j        C  12  j        C  13  j        C  14  j        C  21  j        C  22  j        C  23  j        C  24  j        C  31  j        C  32  j        C  33  j        C  34  j      ]    .       superscript  𝐂  𝐣      superscript   subscript  C  11   j      superscript   subscript  C  12   j      superscript   subscript  C  13   j      superscript   subscript  C  14   j      superscript   subscript  C  21   j      superscript   subscript  C  22   j      superscript   subscript  C  23   j      superscript   subscript  C  24   j      superscript   subscript  C  31   j      superscript   subscript  C  32   j      superscript   subscript  C  33   j      superscript   subscript  C  34   j       \mathbf{C^{j}}=\begin{bmatrix}C_{11}^{j}\\
 C_{12}^{j}\\
 C_{13}^{j}\\
 C_{14}^{j}\\
 C_{21}^{j}\\
 C_{22}^{j}\\
 C_{23}^{j}\\
 C_{24}^{j}\\
 C_{31}^{j}\\
 C_{32}^{j}\\
 C_{33}^{j}\\
 C_{34}^{j}\end{bmatrix}.     Now we must realize that AA and BB should be arrays made of four different subarrays (remember that only three channels are considered for this example but it covers the main part discussed above).      𝐀𝐀  =   [      A  A  1      A  A  3     0       A  A  3      A  A  2      A  A  3       0     A  A  3      A  A  1      ]       𝐀𝐀      A  A  1     A  A  3   0      A  A  3     A  A  2     A  A  3     0    A  A  3     A  A  1       \mathbf{AA}=\begin{bmatrix}AA1&AA3&0\\
 AA3&AA2&AA3\\
 0&AA3&AA1\end{bmatrix}   and      𝐁𝐁  =   [      B  B  1      -   A  A  3      0       -   A  A  3       B  B  2      -   A  A  3        0     -   A  A  3       B  B  1      ]       𝐁𝐁      B  B  1       A  A  3    0        A  A  3      B  B  2       A  A  3      0      A  A  3      B  B  1       \mathbf{BB}=\begin{bmatrix}BB1&-AA3&0\\
 -AA3&BB2&-AA3\\
 0&-AA3&BB1\end{bmatrix}     where the elements mentioned above correspond to the next arrays and an additional 4x4 full of zeros. Please note that the sizes of AA and BB are 12x12:      𝐀𝐀𝟏  =   [      (   1  +   2  λ   +  β   )      -   (   λ  -  α   )      0    0       -   (   λ  +  α   )       (   1  +   2  λ   +  β   )      -   (   λ  -  α   )      0      0     -   (   λ  +  α   )       (   1  +   2  λ   +  β   )      -   (   λ  -  α   )        0    0     -   2  λ       (   1  +   2  λ   +  β   )      ]       𝐀𝐀𝟏      1    2  λ   β       λ  α    0  0        λ  α      1    2  λ   β       λ  α    0    0      λ  α      1    2  λ   β       λ  α      0  0      2  λ      1    2  λ   β       \mathbf{AA1}=\begin{bmatrix}(1+2\lambda+\beta)&-(\lambda-\alpha)&0&0\\
 -(\lambda+\alpha)&(1+2\lambda+\beta)&-(\lambda-\alpha)&0\\
 0&-(\lambda+\alpha)&(1+2\lambda+\beta)&-(\lambda-\alpha)\\
 0&0&-2\lambda&(1+2\lambda+\beta)\end{bmatrix}   ,      𝐀𝐀𝟐  =   [      (   1  +   2  λ   +   2  β    )      -   (   λ  -  α   )      0    0       -   (   λ  +  α   )       (   1  +   2  λ   +   2  β    )      -   (   λ  -  α   )      0      0     -   (   λ  +  α   )       (   1  +   2  λ   +   2  β    )      -   (   λ  -  α   )        0    0     -   2  λ       (   1  +   2  λ   +   2  β    )      ]       𝐀𝐀𝟐      1    2  λ     2  β        λ  α    0  0        λ  α      1    2  λ     2  β        λ  α    0    0      λ  α      1    2  λ     2  β        λ  α      0  0      2  λ      1    2  λ     2  β        \mathbf{AA2}=\begin{bmatrix}(1+2\lambda+2\beta)&-(\lambda-\alpha)&0&0\\
 -(\lambda+\alpha)&(1+2\lambda+2\beta)&-(\lambda-\alpha)&0\\
 0&-(\lambda+\alpha)&(1+2\lambda+2\beta)&-(\lambda-\alpha)\\
 0&0&-2\lambda&(1+2\lambda+2\beta)\end{bmatrix}   ,      𝐀𝐀𝟑  =   [      -  β     0    0    0      0     -  β     0    0      0    0     -  β     0      0    0    0     -  β      ]       𝐀𝐀𝟑      β   0  0  0    0    β   0  0    0  0    β   0    0  0  0    β       \mathbf{AA3}=\begin{bmatrix}-\beta&0&0&0\\
 0&-\beta&0&0\\
 0&0&-\beta&0\\
 0&0&0&-\beta\end{bmatrix}   ,      𝐁𝐁𝟏  =   [      (   1  -   2  λ   -  β   )      (   λ  -  α   )     0    0       (   λ  +  α   )      (   1  -   2  λ   -  β   )      (   λ  -  α   )     0      0     (   λ  +  α   )      (   1  -   2  λ   -  β   )      (   λ  -  α   )       0    0     2  λ      (   1  -   2  λ   -  β   )      ]       𝐁𝐁𝟏      1    2  λ   β     λ  α   0  0      λ  α     1    2  λ   β     λ  α   0    0    λ  α     1    2  λ   β     λ  α     0  0    2  λ     1    2  λ   β       \mathbf{BB1}=\begin{bmatrix}(1-2\lambda-\beta)&(\lambda-\alpha)&0&0\\
 (\lambda+\alpha)&(1-2\lambda-\beta)&(\lambda-\alpha)&0\\
 0&(\lambda+\alpha)&(1-2\lambda-\beta)&(\lambda-\alpha)\\
 0&0&2\lambda&(1-2\lambda-\beta)\end{bmatrix}   &       𝐁𝐁𝟐  =   [      (   1  -   2  λ   -   2  β    )      (   λ  -  α   )     0    0       (   λ  +  α   )      (   1  -   2  λ   -   2  β    )      (   λ  -  α   )     0      0     (   λ  +  α   )      (   1  -   2  λ   -   2  β    )      (   λ  -  α   )       0    0     2  λ      (   1  -   2  λ   -   2  β    )      ]    .      𝐁𝐁𝟐      1    2  λ     2  β      λ  α   0  0      λ  α     1    2  λ     2  β      λ  α   0    0    λ  α     1    2  λ     2  β      λ  α     0  0    2  λ     1    2  λ     2  β        \mathbf{BB2}=\begin{bmatrix}(1-2\lambda-2\beta)&(\lambda-\alpha)&0&0\\
 (\lambda+\alpha)&(1-2\lambda-2\beta)&(\lambda-\alpha)&0\\
 0&(\lambda+\alpha)&(1-2\lambda-2\beta)&(\lambda-\alpha)\\
 0&0&2\lambda&(1-2\lambda-2\beta)\end{bmatrix}.     The d vector here is used to hold the boundary conditions. In this example it is a 12x1 vector:       𝐝  =   [       (   λ  +  α   )    (    C  10   j  +  1    +   C  10  j    )        0      0      0        (   λ  +  α   )    (    C  20   j  +  1    +   C  20  j    )        0      0      0        (   λ  +  α   )    (    C  30   j  +  1    +   C  30  j    )        0      0      0     ]    .      𝐝        λ  α      superscript   subscript  C  10     j  1     superscript   subscript  C  10   j       0    0    0        λ  α      superscript   subscript  C  20     j  1     superscript   subscript  C  20   j       0    0    0        λ  α      superscript   subscript  C  30     j  1     superscript   subscript  C  30   j       0    0    0      \mathbf{d}=\begin{bmatrix}(\lambda+\alpha)(C_{10}^{j+1}+C_{10}^{j})\\
 0\\
 0\\
 0\\
 (\lambda+\alpha)(C_{20}^{j+1}+C_{20}^{j})\\
 0\\
 0\\
 0\\
 (\lambda+\alpha)(C_{30}^{j+1}+C_{30}^{j})\\
 0\\
 0\\
 0\end{bmatrix}.     To find the concentration at any time, one must iterate the following equation:        [      C   j  +  1       ]   =    [      A   A   -  1        ]    (     [   B  B   ]    [   C  j   ]    +   [  d  ]    )     .         superscript  C    j  1            A   superscript  A    1            delimited-[]    B  B     delimited-[]   superscript  C  j      delimited-[]  d       \begin{bmatrix}C^{j+1}\end{bmatrix}=\begin{bmatrix}AA^{-1}\end{bmatrix}([BB][C%
 ^{j}]+[d]).     Example: 2D diffusion  When extending into two dimensions on a uniform Cartesian grid , the derivation is similar and the results may lead to a system of band-diagonal equations rather than tridiagonal ones. The two-dimensional heat equation        ∂  u    ∂  t    =   a   (      ∂  2   u    ∂   x  2     +     ∂  2   u    ∂   y  2      )            u     t      a        superscript   2   u      superscript  x  2         superscript   2   u      superscript  y  2         \frac{\partial u}{\partial t}=a\left(\frac{\partial^{2}u}{\partial x^{2}}+%
 \frac{\partial^{2}u}{\partial y^{2}}\right)     can be solved with the Crank–Nicolson discretization of      u   i  ,  j    n  +  1      superscript   subscript  u   i  j      n  1     \displaystyle u_{i,j}^{n+1}     assuming that a square grid is used so that     Δ  x   =   Δ  y         normal-Δ  x     normal-Δ  y     \Delta x=\Delta y   . This equation can be simplified somewhat by rearranging terms and using the CFL number       μ  =    a  Δ  t     (   Δ  x   )   2     .      μ      a  normal-Δ  t    superscript    normal-Δ  x   2      \mu=\frac{a\Delta t}{(\Delta x)^{2}}.     For the Crank–Nicolson numerical scheme, a low CFL number is not required for stability, however it is required for numerical accuracy. We can now write the scheme as:        (   1  +   2  μ    )    u   i  ,  j    n  +  1     -     μ  2     (    u    i  +  1   ,  j    n  +  1    +   u    i  -  1   ,  j    n  +  1    +   u   i  ,   j  +  1     n  +  1    +   u   i  ,   j  -  1     n  +  1     )            1    2  μ     superscript   subscript  u   i  j      n  1         μ  2      superscript   subscript  u     i  1   j      n  1     superscript   subscript  u     i  1   j      n  1     superscript   subscript  u   i    j  1       n  1     superscript   subscript  u   i    j  1       n  1        \displaystyle(1+2\mu)u_{i,j}^{n+1}-\frac{\mu}{2}\left(u_{i+1,j}^{n+1}+u_{i-1,j%
 }^{n+1}+u_{i,j+1}^{n+1}+u_{i,j-1}^{n+1}\right)     Application in financial mathematics  Because a number of other phenomena can be modeled with the heat equation (often called the diffusion equation in financial mathematics ), the Crank–Nicolson method has been applied to those areas as well. 4 Particularly, the Black–Scholes option pricing model's differential equation can be transformed into the heat equation, and thus numerical solutions for option pricing can be obtained with the Crank–Nicolson method.  The importance of this for finance, is that option pricing problems, when extended beyond the standard assumptions (e.g. incorporating changing dividends), cannot be solved in closed form, but can be solved using this method. Note however, that for non-smooth final conditions (which happen for most financial instruments), the Crank–Nicolson method is not satisfactory as numerical oscillations are not damped. For vanilla options , this results in oscillation in the gamma value around the strike price . Therefore, special damping initialization steps are necessary (e.g., fully implicit finite difference method).  See also   Financial mathematics  Trapezoidal rule (differential equations)   References    External links   Module for Parabolic P.D.E.'s  Numerical PDE Techniques for Scientists and Engineers , open access Lectures and Codes for Numerical PDEs  An example of how to apply and implement the Crank-Nicolson method for the Advection equation   "  Category:Mathematical finance  Category:Numerical differential equations  Category:Finite differences     ↩  . ↩  . Example 3.3.2 shows that Crank–Nicolson is unconditionally stable when applied to     u  t   =   a   u   x  x          subscript  u  t     a   subscript  u    x  x       u_{t}=au_{xx}   . ↩  ↩     