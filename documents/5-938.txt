   Color balance      Color balance   (Figure)  The left half shows the photo as it came from the digital camera. The right half shows the photo adjusted to make a gray surface neutral in the same light.   In photography and image processing , color balance is the global adjustment of the intensities of the colors (typically red, green, and blue primary colors ). An important goal of this adjustment is to render specific colors ‚Äì particularly neutral colors ‚Äì correctly; hence, the general method is sometimes called gray balance , neutral balance , or white balance . Color balance changes the overall mixture of colors in an image and is used for color correction ; generalized versions of color balance are used to get colors other than neutrals to also appear correct or pleasing.  Image data acquired by sensors ‚Äì either film or electronic image sensors ‚Äì must be transformed from the acquired values to new values that are appropriate for color reproduction or display. Several aspects of the acquisition and display process make such color correction essential ‚Äì including the fact that the acquisition sensors do not match the sensors in the human eye, that the properties of the display medium must be accounted for, and that the ambient viewing conditions of the acquisition differ from the display viewing conditions.  The color balance operations in popular image editing applications usually operate directly on the red, green, and blue channel pixel values, 1 2 without respect to any color sensing or reproduction model. In shooting film, color balance is typically achieved by using color correction filters over the lights or on the camera lens. 3  Generalized color balance  Sometimes the adjustment to keep neutrals neutral is called white balance , and the phrase color balance refers to the adjustment that in addition makes other colors in a displayed image appear to have the same general appearance as the colors in an original scene. 4 It is particularly important that neutral (gray, neutral, white) colors in a scene appear neutral in the reproduction. Hence, the special case of balancing the neutral colors (sometimes gray balance , neutral balance , or white balance ) is a particularly important ‚Äì perhaps dominant ‚Äì element of color balancing.  Normally, one would not use the phrase color balance to describe the adjustments needed to account for differences between the sensors and the human eye, or the details of the display primaries. Color balance is normally reserved to refer to correction for differences in the ambient illumination conditions. However, the algorithms for transforming the data do not always clearly separate out the different elements of the correction. Hence, it can be difficult to assign color balance to a specific step in the color correction process. Moreover, there can be significant differences in the color balancing goal. Some applications are created to produce an accurate rendering ‚Äì as suggested above. In other applications, the goal of color balancing is to produce a pleasing rendering. This difference also creates difficulty in defining the color balancing processing operations.  Illuminant estimation and adaptation  Most digital cameras have a means to select a color correction based on the type of scene illumination, using either manual illuminant selection, or automatic white balance (AWB), or custom white balance. The algorithm that performs this analysis performs generalized color balancing, known as illuminant adaptation or chromatic adaptation .  Many methods are used to achieve color balancing. Setting a button on a camera is a way for the user to indicate to the processor the nature of the scene lighting. Another option on some cameras is a button which one may press when the camera is pointed at a gray card or other neutral object. This "custom white balance" step captures an image of the ambient light, and this information is helpful in controlling color balance.  There is a large literature on how one might estimate the ambient illumination from the camera data and then use this information to transform the image data. A variety of algorithms have been proposed, and the quality of these have been debated. A few examples and examination of the references therein will lead the reader to many others. Examples are Retinex , an artificial neural network 5 or a Bayesian method . 6  Color balance and chromatic colors  Color balancing an image affects not only the neutrals, but other colors as well. An image that is not color balanced is said to have a color cast, as everything in the image appears to have been shifted towards one color or another. 7 Color balancing may be thought in terms of removing this color cast.  Color balance is also related to color constancy . Algorithms and techniques used to attain color constancy are frequently used for color balancing, as well. Color constancy is, in turn, related to chromatic adaptation . Conceptually, color balancing consists of two steps: first, determining the illuminant under which an image was captured; and second, scaling the components (e.g., R, G, and B) of the image or otherwise transforming the components so they conform to the viewing illuminant.  Viggiano found that white balancing in the camera's native RGB tended to produce less color inconstancy (i.e., less distortion of the colors) than in monitor RGB for over 4000 hypothetical sets of camera sensitivities. 8 This difference typically amounted to a factor of more than two in favor of camera RGB. This means that it is advantageous to get color balance right at the time an image is captured, rather than edit later on a monitor. If one must color balance later, balancing the raw image data will tend to produce less distortion of chromatic colors than balancing in monitor RGB.  Mathematics of color balance  Color balancing is sometimes performed on a three-component image (e.g., RGB ) using a 3x3 matrix . This type of transformation is appropriate if the image were captured using the wrong white balance setting on a digital camera, or through a color filter.  Scaling monitor R, G, and B  In principle, one wants to scale all relative luminances in an image so that objects which are believed to be neutral appear so. If, say, a surface with    R  =  240      R  240    R=240   was believed to be a white object, and if 255 is the count which corresponds to white, one could multiply all red values by 255/240. Doing analogously for green and blue would result, at least in theory, in a color balanced image. In this type of transformation the 3x3 matrix is a diagonal matrix .       [     R      G      B     ]   =    [      255  /   R  w  ‚Ä≤      0    0      0     255  /   G  w  ‚Ä≤      0      0    0     255  /   B  w  ‚Ä≤       ]    [      R  ‚Ä≤        G  ‚Ä≤        B  ‚Ä≤      ]         delimited-[]    R    G    B        delimited-[]      255   subscript   superscript  R  normal-‚Ä≤   w    0  0    0    255   subscript   superscript  G  normal-‚Ä≤   w    0    0  0    255   subscript   superscript  B  normal-‚Ä≤   w        delimited-[]     superscript  R  normal-‚Ä≤      superscript  G  normal-‚Ä≤      superscript  B  normal-‚Ä≤         \left[\begin{array}[]{c}R\\
 G\\
 B\end{array}\right]=\left[\begin{array}[]{ccc}255/R^{\prime}_{w}&0&0\\
 0&255/G^{\prime}_{w}&0\\
 0&0&255/B^{\prime}_{w}\end{array}\right]\left[\begin{array}[]{c}R^{\prime}\\
 G^{\prime}\\
 B^{\prime}\end{array}\right]     where   R   R   R   ,   G   G   G   , and   B   B   B   are the color balanced red, green, and blue components of a pixel in the image;    R  ‚Ä≤     superscript  R  normal-‚Ä≤    R^{\prime}   ,    G  ‚Ä≤     superscript  G  normal-‚Ä≤    G^{\prime}   , and    B  ‚Ä≤     superscript  B  normal-‚Ä≤    B^{\prime}   are the red, green, and blue components of the image before color balancing, and    R  w  ‚Ä≤     subscript   superscript  R  normal-‚Ä≤   w    R^{\prime}_{w}   ,    G  w  ‚Ä≤     subscript   superscript  G  normal-‚Ä≤   w    G^{\prime}_{w}   , and    B  w  ‚Ä≤     subscript   superscript  B  normal-‚Ä≤   w    B^{\prime}_{w}   are the red, green, and blue components of a pixel which is believed to be a white surface in the image before color balancing. This is a simple scaling of the red, green, and blue channels, and is why color balance tools in Photoshop and the GIMP have a white eyedropper tool. It has been demonstrated that performing the white balancing in the phosphor set assumed by sRGB tends to produce large errors in chromatic colors, even though it can render the neutral surfaces perfectly neutral. 9  Scaling X, Y, Z  If the image may be transformed into CIE XYZ tristimulus values , the color balancing may be performed there. This has been termed a ‚Äúwrong von Kries‚Äù transformation. 10 11 Although it has been demonstrated to offer usually poorer results than balancing in monitor RGB, it is mentioned here as a bridge to other things. Mathematically, one computes:       [     X      Y      Z     ]   =    [       X  w   /   X  w  ‚Ä≤      0    0      0      Y  w   /   Y  w  ‚Ä≤      0      0    0      Z  w   /   Z  w  ‚Ä≤       ]    [      X  ‚Ä≤        Y  ‚Ä≤        Z  ‚Ä≤      ]         delimited-[]    X    Y    Z        delimited-[]       subscript  X  w    subscript   superscript  X  normal-‚Ä≤   w    0  0    0     subscript  Y  w    subscript   superscript  Y  normal-‚Ä≤   w    0    0  0     subscript  Z  w    subscript   superscript  Z  normal-‚Ä≤   w        delimited-[]     superscript  X  normal-‚Ä≤      superscript  Y  normal-‚Ä≤      superscript  Z  normal-‚Ä≤         \left[\begin{array}[]{c}X\\
 Y\\
 Z\end{array}\right]=\left[\begin{array}[]{ccc}X_{w}/X^{\prime}_{w}&0&0\\
 0&Y_{w}/Y^{\prime}_{w}&0\\
 0&0&Z_{w}/Z^{\prime}_{w}\end{array}\right]\left[\begin{array}[]{c}X^{\prime}\\
 Y^{\prime}\\
 Z^{\prime}\end{array}\right]     where   X   X   X   ,   Y   Y   Y   , and   Z   Z   Z   are the color-balanced tristimulus values;    X  w     subscript  X  w    X_{w}   ,    Y  w     subscript  Y  w    Y_{w}   , and    Z  w     subscript  Z  w    Z_{w}   are the tristimulus values of the viewing illuminant (the white point to which the image is being transformed to conform to);    X  w  ‚Ä≤     subscript   superscript  X  normal-‚Ä≤   w    X^{\prime}_{w}   ,    Y  w  ‚Ä≤     subscript   superscript  Y  normal-‚Ä≤   w    Y^{\prime}_{w}   , and    Z  w  ‚Ä≤     subscript   superscript  Z  normal-‚Ä≤   w    Z^{\prime}_{w}   are the tristimulus values of an object believed to be white in the un-color-balanced image, and    X  ‚Ä≤     superscript  X  normal-‚Ä≤    X^{\prime}   ,    Y  ‚Ä≤     superscript  Y  normal-‚Ä≤    Y^{\prime}   , and    Z  ‚Ä≤     superscript  Z  normal-‚Ä≤    Z^{\prime}   are the tristimulus values of a pixel in the un-color-balanced image. If the tristimulus values of the monitor primaries are in a matrix   ùêè   ùêè   \mathbf{P}   so that:       [     X      Y      Z     ]   =   ùêè   [      L  R        L  G        L  B      ]         delimited-[]    X    Y    Z       ùêè   delimited-[]     subscript  L  R      subscript  L  G      subscript  L  B         \left[\begin{array}[]{c}X\\
 Y\\
 Z\end{array}\right]=\mathbf{P}\left[\begin{array}[]{c}L_{R}\\
 L_{G}\\
 L_{B}\end{array}\right]     where    L  R     subscript  L  R    L_{R}   ,    L  G     subscript  L  G    L_{G}   , and    L  B     subscript  L  B    L_{B}   are the un- gamma corrected monitor RGB, one may use:       [      L  R        L  G        L  B      ]   =    ùêè   -  ùüè     [       X  w   /   X  w  ‚Ä≤      0    0      0      Y  w   /   Y  w  ‚Ä≤      0      0    0      Z  w   /   Z  w  ‚Ä≤       ]   ùêè   [      L   R  ‚Ä≤         L   G  ‚Ä≤         L   B  ‚Ä≤       ]         delimited-[]     subscript  L  R      subscript  L  G      subscript  L  B         superscript  ùêè    1     delimited-[]       subscript  X  w    subscript   superscript  X  normal-‚Ä≤   w    0  0    0     subscript  Y  w    subscript   superscript  Y  normal-‚Ä≤   w    0    0  0     subscript  Z  w    subscript   superscript  Z  normal-‚Ä≤   w       ùêè   delimited-[]     subscript  L   superscript  R  normal-‚Ä≤       subscript  L   superscript  G  normal-‚Ä≤       subscript  L   superscript  B  normal-‚Ä≤          \left[\begin{array}[]{c}L_{R}\\
 L_{G}\\
 L_{B}\end{array}\right]=\mathbf{P^{-1}}\left[\begin{array}[]{ccc}X_{w}/X^{%
 \prime}_{w}&0&0\\
 0&Y_{w}/Y^{\prime}_{w}&0\\
 0&0&Z_{w}/Z^{\prime}_{w}\end{array}\right]\mathbf{P}\left[\begin{array}[]{c}L_%
 {R^{\prime}}\\
 L_{G^{\prime}}\\
 L_{B^{\prime}}\end{array}\right]     Von Kries's method  Johannes von Kries , whose theory of rods and three color-sensitive cone types in the retina has survived as the dominant explanation of color sensation for over 100 years, motivated the method of converting color to the LMS color space , representing the effective stimuli for the Long-, Medium-, and Short-wavelength cone types that are modeled as adapting independently. A 3x3 matrix converts RGB or XYZ to LMS, and then the three LMS primary values are scaled to balance the neutral; the color can then be converted back to the desired final color space : 12       [     L      M      S     ]   =    [      1  /   L  w  ‚Ä≤      0    0      0     1  /   M  w  ‚Ä≤      0      0    0     1  /   S  w  ‚Ä≤       ]    [      L  ‚Ä≤        M  ‚Ä≤        S  ‚Ä≤      ]         delimited-[]    L    M    S        delimited-[]      1   subscript   superscript  L  normal-‚Ä≤   w    0  0    0    1   subscript   superscript  M  normal-‚Ä≤   w    0    0  0    1   subscript   superscript  S  normal-‚Ä≤   w        delimited-[]     superscript  L  normal-‚Ä≤      superscript  M  normal-‚Ä≤      superscript  S  normal-‚Ä≤         \left[\begin{array}[]{c}L\\
 M\\
 S\end{array}\right]=\left[\begin{array}[]{ccc}1/L^{\prime}_{w}&0&0\\
 0&1/M^{\prime}_{w}&0\\
 0&0&1/S^{\prime}_{w}\end{array}\right]\left[\begin{array}[]{c}L^{\prime}\\
 M^{\prime}\\
 S^{\prime}\end{array}\right]     where   L   L   L   ,   M   M   M   , and   S   S   S   are the color-balanced LMS cone tristimulus values;    L  w  ‚Ä≤     subscript   superscript  L  normal-‚Ä≤   w    L^{\prime}_{w}   ,    M  w  ‚Ä≤     subscript   superscript  M  normal-‚Ä≤   w    M^{\prime}_{w}   , and    S  w  ‚Ä≤     subscript   superscript  S  normal-‚Ä≤   w    S^{\prime}_{w}   are the tristimulus values of an object believed to be white in the un-color-balanced image, and    L  ‚Ä≤     superscript  L  normal-‚Ä≤    L^{\prime}   ,    M  ‚Ä≤     superscript  M  normal-‚Ä≤    M^{\prime}   , and    S  ‚Ä≤     superscript  S  normal-‚Ä≤    S^{\prime}   are the tristimulus values of a pixel in the un-color-balanced image.  Matrices to convert to LMS space were not specified by von Kries, but can be derived from CIE color matching functions and LMS color matching functions when the latter are specified; matrices can also be found in reference books. 13  Scaling camera RGB  By Viggiano's measure, and using his model of gaussian camera spectral sensitivities, most camera RGB spaces performed better than either monitor RGB or XYZ. 14 If the camera's raw RGB values are known, one may use the 3x3 diagonal matrix:       [     R      G      B     ]   =    [      255  /   R  w  ‚Ä≤      0    0      0     255  /   G  w  ‚Ä≤      0      0    0     255  /   B  w  ‚Ä≤       ]    [      R  ‚Ä≤        G  ‚Ä≤        B  ‚Ä≤      ]         delimited-[]    R    G    B        delimited-[]      255   subscript   superscript  R  normal-‚Ä≤   w    0  0    0    255   subscript   superscript  G  normal-‚Ä≤   w    0    0  0    255   subscript   superscript  B  normal-‚Ä≤   w        delimited-[]     superscript  R  normal-‚Ä≤      superscript  G  normal-‚Ä≤      superscript  B  normal-‚Ä≤         \left[\begin{array}[]{c}R\\
 G\\
 B\end{array}\right]=\left[\begin{array}[]{ccc}255/R^{\prime}_{w}&0&0\\
 0&255/G^{\prime}_{w}&0\\
 0&0&255/B^{\prime}_{w}\end{array}\right]\left[\begin{array}[]{c}R^{\prime}\\
 G^{\prime}\\
 B^{\prime}\end{array}\right]     and then convert to a working RGB space such as sRGB or Adobe RGB after balancing.  Preferred chromatic adaptation spaces  Comparisons of images balanced by diagonal transforms in a number of different RGB spaces have identified several such spaces that work better than others, and better than camera or monitor spaces, for chromatic adaptation, as measured by several color appearance models ; the systems that performed statistically as well as the best on the majority of the image test sets used were the "Sharp", "Bradford", "CMCCAT", and "ROMM" spaces. 15  General illuminant adaptation  The best color matrix for adapting to a change in illuminant is not necessarily a diagonal matrix in a fixed color space. It has long been known that if the space of illuminants can be described as a linear model with N basis terms, the proper color transformation will be the weighted sum of N fixed linear transformations, not necessarily consistently diagonalizable. 16  See also   Color cast  Color temperature  Gamma correction  White point   References  External links   White Balance - Intro at nikondigital.org  Understanding White Balance - Tutorial  Affine color balance with saturation, with code and on-line demonstration  Getting the White Balance Right for Neutral Colors - Photography Tutorial   "  Category:Color  Category:Image processing     ‚Ü©  ‚Ü©  ‚Ü©  ‚Ü©  Brian Funt, Vlad Cardei, and Kobus Barnard, " Learning color constancy ," in Proceedings of the Fourth IS&T;/SID Color Imaging Conference, p 58-60 (1996). ‚Ü©  ‚Ü©  John A C Yule, Principles of Color Reproduction. New York: Wiley, 1967. ‚Ü©   J A Stephen Viggiano, " Comparison of the accuracy of different white balancing options as quantified by their color constancy ." Sensors and Camera Systems for Scientific, Industrial, and Digital Photography Applications V: Proceedings of the SPIE, volume 5301. Bellingham, WA: SPIE: the International Society for Optical Engineering, p 323-333 (2004), retrieved online 2008-07-28. ‚Ü©  ‚Ü©  Mark D Fairchild, Color Appearance Models. Reading, MA: Addison-Wesley, 1998. ‚Ü©  ‚Ü©    ‚Ü©  ‚Ü©     