   Convolution for optical broad-beam responses in scattering media      Convolution for optical broad-beam responses in scattering media   Photon transport theories, such as the Monte Carlo method , are commonly used to model light propagation in tissue . The responses to a pencil beam incident on a scattering medium are referred to as Green's functions or impulse responses . Photon transport methods can be directly used to compute broad-beam responses by distributing photons over the cross section of the beam. However, convolution can be used in certain cases to improve computational efficiency.  General convolution formulas  In order for convolution to be used to calculate a broad-beam response, a system must be time invariant , linear , and translation invariant . Time invariance implies that a photon beam delayed by a given time produces a response shifted by the same delay. Linearity indicates that a given response will increase by the same amount if the input is scaled and obeys the property of superposition . Translational invariance means that if a beam is shifted to a new location on the tissue surface, its response is also shifted in the same direction by the same distance. Here, only spatial convolution is considered.  Responses from photon transport methods can be physical quantities such as absorption , fluence , reflectance , or transmittance . Given a specific physical quantity, G(x,y,z) , from a pencil beam in Cartesian space and a collimated light source with beam profile S(x,y) , a broad-beam response can be calculated using the following 2-D convolution formula:      C   (  x  ,  y  ,  z  )   =   ∫   -  ∞   ∞     ∫   -  ∞   ∞    G   (  x  -   x  ′   ,  y  -   y  ′   ,  z  )   S   (   x  ′   ,   y  ′   )   d    x  ′    d   y  ′   .   (  1  )      fragments  C   fragments  normal-(  x  normal-,  y  normal-,  z  normal-)     superscript   subscript           superscript   subscript          G   fragments  normal-(  x    superscript  x  normal-′   normal-,  y    superscript  y  normal-′   normal-,  z  normal-)   S   fragments  normal-(   superscript  x  normal-′   normal-,   superscript  y  normal-′   normal-)   d   superscript  x  normal-′   d   superscript  y  normal-′   normal-.  italic-   fragments  normal-(  1  normal-)     C(x,y,z)=\int_{-\infty}^{\infty}\int_{-\infty}^{\infty}\ G(x-x^{\prime},y-y^{%
 \prime},z)S(x^{\prime},y^{\prime})\,dx^{\prime}\,dy^{\prime}.\qquad(1)     Similar to 1-D convolution, 2-D convolution is commutative between G and S with a change of variables      x  ′′   =   x  -    x  ′          superscript  x  ′′     x   superscript  x  normal-′      x^{\prime\prime}=x-x^{\prime}\,    and      y  ′′   =   y  -    y  ′          superscript  y  ′′     y   superscript  y  normal-′      y^{\prime\prime}=y-y^{\prime}\,    :      C   (  x  ,  y  ,  z  )   =    ∫   -  ∞   ∞      ∫   -  ∞   ∞    G   (   x  ′′   ,   y  ′′   ,  z  )   S   (  x  -   x  ′′   ,  y  -   y  ′′   )   d    x  ′′    d   y  ′′   .   (  2  )      fragments  C   fragments  normal-(  x  normal-,  y  normal-,  z  normal-)     superscript   subscript           superscript   subscript          G   fragments  normal-(   superscript  x  ′′   normal-,   superscript  y  ′′   normal-,  z  normal-)   S   fragments  normal-(  x    superscript  x  ′′   normal-,  y    superscript  y  ′′   normal-)   d   superscript  x  ′′   d   superscript  y  ′′   normal-.  italic-   fragments  normal-(  2  normal-)     C(x,y,z)=\int_{-\infty}^{\infty}\!\int_{-\infty}^{\infty}\ G(x^{\prime\prime},%
 y^{\prime\prime},z)S(x-x^{\prime\prime},y-y^{\prime\prime})\,dx^{\prime\prime}%
 \,dy^{\prime\prime}.\qquad(2)     Because the broad-beam response    C   (  x  ,  y  ,  z  )       C   x  y  z     C(x,y,z)\,   has cylindrical symmetry, its convolution integrals can be rewritten as:       C   (  r  ,  z  )    =      ∫  0  ∞     S   (   r  ′   )    r  ′    [     ∫  0   2  π      G   (     r  2   +    r  ′     -    2   2  r   r  ′   c  o  s   ϕ  ′     ,  z  )   d   ϕ  ′     ]   d   r  ′      (  3  )          C   r  z       superscript   subscript   0       S   superscript  r  normal-′    superscript  r  normal-′    delimited-[]    superscript   subscript   0     2  π      G      fragments   superscript  r  2     superscript  r  normal-′    superscript   2   2  r   superscript  r  normal-′   c  o  s   superscript  ϕ  normal-′     z   d   superscript  ϕ  normal-′      d   superscript  r  normal-′     3     C(r,z)=\int_{0}^{\infty}\ S(r^{\prime})r^{\prime}\left[\int_{0}^{2\pi}\ G\left%
 (\sqrt{r^{2}+r^{\prime}\,{}^{2}-2rr^{\prime}cos\phi^{\prime}},z\right)\,d\phi^%
 {\prime}\right]dr^{\prime}\qquad(3)          C   (  r  ,  z  )    =     ∫  0  ∞    G   (   r  ′′   ,  z  )    r  ′′    [    ∫  0   2  π     S   (     r  2   +    r  ′′     -    2   2  r   r  ′′   c  o  s   ϕ  ′′     )   d   ϕ  ′′     ]   d   r  ′′      (  4  )          C   r  z       superscript   subscript   0       G    superscript  r  ′′   z    superscript  r  ′′    delimited-[]    superscript   subscript   0     2  π      S     fragments   superscript  r  2     superscript  r  ′′    superscript   2   2  r   superscript  r  ′′   c  o  s   superscript  ϕ  ′′     d   superscript  ϕ  ′′      d   superscript  r  ′′     4     C(r,z)=\int_{0}^{\infty}G(r^{\prime\prime},z)r^{\prime\prime}\left[\int_{0}^{2%
 \pi}S\left(\sqrt{r^{2}+r^{\prime\prime}\,{}^{2}-2rr^{\prime\prime}cos\phi^{%
 \prime\prime}}\right)\,d\phi^{\prime\prime}\right]dr^{\prime\prime}\qquad(4)     where     r  ′   =     x   ′  2    +   y   ′  2           superscript  r  normal-′        superscript  x   normal-′  2     superscript  y   normal-′  2        r^{\prime}=\sqrt{x^{\prime 2}+y^{\prime 2}}   . Because the inner integration of Equation 4 is independent of z , it only needs to be calculated once for all depths. Thus this form of the broad-beam response is more computationally advantageous.  Common beam profiles  Gaussian beam  For a Gaussian beam , the intensity profile is given by      S   (   r  ′   )   =   S  0   exp   [  -  2    (    r  ′   R   )   2   ]   .   (  5  )      fragments  S   fragments  normal-(   superscript  r  normal-′   normal-)     subscript  S  0     fragments  normal-[   2   superscript   fragments  normal-(     superscript  r  normal-′   R   normal-)   2   normal-]   normal-.  italic-   fragments  normal-(  5  normal-)     S(r^{\prime})=S_{0}\exp\left[-2\left(\frac{r^{\prime}}{R}\right)^{2}\right].%
 \qquad(5)     Here, R denotes the     1   e  2        1   superscript  e  2     \tfrac{1}{e^{2}}\,   radius of the beam, and S 0 denotes the intensity at the center of the beam. S 0 is related to the total power P 0 by       S  0   =    2   P  0     π   R  2     .   (  6  )      fragments   subscript  S  0        2   subscript  P  0      π   superscript  R  2     normal-.  italic-   fragments  normal-(  6  normal-)     S_{0}=\frac{2P_{0}}{\pi R^{2}}.\qquad(6)   Substituting Eq. 5 into Eq. 4, we obtain       C   (  r  ,  z  )    =    2  π  S   (  r  )     ∫  0  ∞    G   (   r  ′′   ,  z  )    exp   [   -   2    (    r  ′′   R   )   2     ]     I  0    (    4  r   r  ′′     R  2    )     r  ′′    d   r  ′′      ,   (  7  )          C   r  z       2  π  S  r    superscript   subscript   0       G    superscript  r  ′′   z         2   superscript     superscript  r  ′′   R   2       subscript  I  0       4  r   superscript  r  ′′     superscript  R  2     superscript  r  ′′   d   superscript  r  ′′      7     C(r,z)=2\pi S(r)\int_{0}^{\infty}G(r^{\prime\prime},z)\exp\left[-2\left(\frac{%
 r^{\prime\prime}}{R}\right)^{2}\right]I_{0}\left(\frac{4rr^{\prime\prime}}{R^{%
 2}}\right)r^{\prime\prime}\,dr^{\prime\prime},\qquad(7)     where I 0 is the zeroth-order modified Bessel function .  Top-hat beam  For a top-hat beam of radius R , the source function becomes       S   (   r  ′   )    =    {       S  0   ,       if   r  ′    ≤  R        0  ,       if   r  ′    >  R        (  8  )          S   superscript  r  normal-′      cases   subscript  S  0       if   superscript  r  normal-′    R   0      if   superscript  r  normal-′    R    8     S(r^{\prime})=\begin{cases}S_{0},&\text{if }r^{\prime}\leq R\\
 \,0,&\text{if }r^{\prime}>R\end{cases}\qquad(8)     where S 0 denotes the intensity inside the beam. S 0 is related to the total beam power P 0 by       S  0   =    P  0    π   R  2     .   (  9  )      fragments   subscript  S  0       subscript  P  0     π   superscript  R  2     normal-.  italic-   fragments  normal-(  9  normal-)     S_{0}=\frac{P_{0}}{\pi R^{2}}.\qquad(9)     Substituting Eq. 8 into Eq. 4, we obtain       C   (  r  ,  z  )    =    2  π   S  0     ∫  0  ∞    G   (   r  ′′   ,  z  )    I  ϕ    (  r  ,   r  ′′   )     r  ′′    d   r  ′′      ,   (  10  )          C   r  z       2  π   subscript  S  0     superscript   subscript   0       G    superscript  r  ′′   z    subscript  I  ϕ    r   superscript  r  ′′     superscript  r  ′′   d   superscript  r  ′′      10     C(r,z)=2\pi S_{0}\int_{0}^{\infty}G(r^{\prime\prime},z)I_{\phi}(r,r^{\prime%
 \prime})r^{\prime\prime}\,dr^{\prime\prime},\qquad(10)   where        I  ϕ    (  r  ,   r  ′′   )    =    {      1  ,        if  R   ≥   r  +   r  ′′     ,           1  π      cos   -  1     (       r  2   +   r   ′′  2     -   R  2     2  r   r  ′′      )     ,        if   |   r  -   r  ′′    |    ≤  R  <   r  +   r  ′′     ,        0  ,        if  R   <   |   r  +   r  ′′    |    .        (  11  )           subscript  I  ϕ    r   superscript  r  ′′       cases  1      if  R     r   superscript  r  ′′         1  π     superscript     1           superscript  r  2    superscript  r   ′′  2      superscript  R  2      2  r   superscript  r  ′′             if      r   superscript  r  ′′      R         r   superscript  r  ′′      0      if  R       r   superscript  r  ′′       11     I_{\phi}(r,r^{\prime\prime})=\begin{cases}1,&\mbox{if }R\geq r+r^{\prime\prime%
 },\\
 \tfrac{1}{\pi}\cos^{-1}\left(\tfrac{r^{2}+r^{\prime\prime 2}-R^{2}}{2rr^{%
 \prime\prime}}\right),&\mbox{if }\left|r-r^{\prime\prime}\right|\leq R     Errors in numerical evaluation  First interactions  First photon-tissue interactions always occur on the z axis and hence contribute to the specific absorption or related physical quantities as a Dirac delta function . Errors will result if absorption due to the first interactions is not recorded separately from absorption due to subsequent interactions. The total impulse response can be expressed in two parts:       C   (  r  ,  z  )    =      G  1    (  0  ,  z  )     δ   (  r  )     2  π  r     +    G  2    (  r  ,  z  )     ,   (  12  )          C   r  z          subscript  G  1    0  z       δ  r     2  π  r        subscript  G  2    r  z     12     C(r,z)=G_{1}(0,z)\frac{\delta(r)}{2\pi r}+G_{2}(r,z),\qquad(12)     where the first term results from the first interactions and the second, from subsequent interactions. For a Gaussian beam, we have      C   (  r  ,  z  )   =   G  1    (  0  ,  z  )   S   (  r  )   +  2  π   S  0    ∫  0  ∞    G  2    (   r  ′′   ,  z  )   e  x  p   [  -  2    (     r  ′′   -  r   R   )   2   ]    I   0  e     (    4  r   r  ′′     R  2    )     r  ′′    d   r  ′′   .   (  13  )      fragments  C   fragments  normal-(  r  normal-,  z  normal-)     subscript  G  1    fragments  normal-(  0  normal-,  z  normal-)   S   fragments  normal-(  r  normal-)    2  π   subscript  S  0    superscript   subscript   0      subscript  G  2    fragments  normal-(   superscript  r  ′′   normal-,  z  normal-)   e  x  p   fragments  normal-[   2   superscript   fragments  normal-(       superscript  r  ′′   r   R   normal-)   2   normal-]    subscript  I    0  e     fragments  normal-(      4  r   superscript  r  ′′     superscript  R  2    normal-)    superscript  r  ′′   d   superscript  r  ′′   normal-.  italic-   fragments  normal-(  13  normal-)     C(r,z)=G_{1}(0,z)S(r)+2\pi S_{0}\int_{0}^{\infty}G_{2}(r^{\prime\prime},z)\,%
 exp\left[-2\left(\frac{r^{\prime\prime}-r}{R}\right)^{2}\right]I_{0e}\left(%
 \frac{4rr^{\prime\prime}}{R^{2}}\right)r^{\prime\prime}\,dr^{\prime\prime}.%
 \qquad(13)     For a top-hat beam, we have      C   (  r  ,  z  )   =   G  1    (  0  ,  z  )   S   (  r  )   +  2  π   S  0    ∫  0  ∞    G  2    (   r  ′′   ,  z  )    I  ϕ    (  r  ,   r  ′′   )     r  ′′    d   r  ′′   .   (  14  )      fragments  C   fragments  normal-(  r  normal-,  z  normal-)     subscript  G  1    fragments  normal-(  0  normal-,  z  normal-)   S   fragments  normal-(  r  normal-)    2  π   subscript  S  0    superscript   subscript   0      subscript  G  2    fragments  normal-(   superscript  r  ′′   normal-,  z  normal-)    subscript  I  ϕ    fragments  normal-(  r  normal-,   superscript  r  ′′   normal-)    superscript  r  ′′   d   superscript  r  ′′   normal-.  italic-   fragments  normal-(  14  normal-)     C(r,z)=G_{1}(0,z)S(r)+2\pi S_{0}\int_{0}^{\infty}G_{2}(r^{\prime\prime},z)I_{%
 \phi}(r,r^{\prime\prime})r^{\prime\prime}\,dr^{\prime\prime}.\qquad(14)     Truncation error  For a top-hat beam, the upper integration limits may be bounded by r max , such that r ≤ r max − R . Thus, the limited grid coverage in the r direction does not affect the convolution. To convolve reliably for physical quantities at r in response to a top-hat beam, we must ensure that r max in photon transport methods is large enough that r ≤ r max − R holds. For a Gaussian beam, no simple upper integration limits exist because it theoretically extends to infinity. At r >> R , a Gaussian beam and a top-hat beam of the same R and S 0 have comparable convolution results. Therefore, r ≤ r max − R can be used approximately for Gaussian beams as well.  Implementation of convolution  There are two common methods used to implement discrete convolution: the definition of convolution and fast Fourier transformation (FFT and IFFT) according to the convolution theorem . To calculate the optical broad-beam response, the impulse response of a pencil beam is convolved with the beam function. As shown by Equation 4, this is a 2-D convolution. To calculate the response of a light beam on a plane perpendicular to the z axis, the beam function (represented by a b × b matrix) is convolved with the impulse response on that plane (represented by an a × a matrix). Normally a is greater than b . The calculation efficiency of these two methods depends largely on b , the size of the light beam.  In direct convolution, the solution matrix is of the size ( a + b − 1) × ( a + b − 1). The calculation of each of these elements (except those near boundaries) includes b × b multiplications and b × b − 1 additions, so the time complexity is O [( a + b ) 2 b 2 ]. Using the FFT method, the major steps are the FFT and IFFT of ( a + b − 1) × ( a + b − 1) matrices, so the time complexity is O[( a + b ) 2 log( a + b )]. Comparing O[( a + b ) 2 b 2 ] and O[( a + b ) 2 log( a + b )], it is apparent that direct convolution will be faster if b is much smaller than a , but the FFT method will be faster if b is relatively large.  Computational examples  The fate of photons can be modeled using a Matlab implementation of the Monte Carlo method ( n rel = 1, μ a = 0.1, μ s =100, g = 0.9, 100,000 photons). Using this Matlab model, the fluence of a 3 × 3 × 3 cm 3 region is recorded and the fluence distribution of a broad-beam response is plotted. Figure 1 and Figure 2 show the responses to a pencil beam and a 1-cm top-hat broad-beam, respectively. Direct convolution was used to calculate the broad-beam response in Figure 2. Figure 3 shows the broad-beam response calculated using the FFT method. When the diameter of the light beam is 0.2 cm, direct convolution costs 1.93 seconds, and the FFT method costs 7.35 seconds. When the diameter of the light beam is 2 cm, direct convolution costs 90.1 seconds, and FFT method costs 16.8 seconds. Of course, the absolute computation time depends on the processing speed of the computer being used. These two comparisons were made on the same computer. Although the computation times differ, the plots in Figures 2 and 3 are indistinguishable.           See also   Radiative transfer equation and diffusion theory for photon transport in biological tissue  Monte Carlo method  Monte Carlo method for photon transport   Links to other Monte Carlo resources   Optical Imaging Laboratory at Washington University in St. Louis (MCML)  Oregon Medical Laser Center   References   L.-H. Wang and H.-I. Wu. Biomedical Optics: Principles and Imaging. Wiley 2007.  L.-H. Wang, S. L. Jacques, and L.-Q. Zheng, "Monte Carlo modeling of photon transport in multi-layered tissues," Computer Methods and Programs in Biomedicine 47, 131–146 (1995).  L.-H. Wang, S. L. Jacques, and L.-Q. Zheng, "Convolution for responses to a finite diameter photon beam incident on multi-layered tissues," Computer Methods and Programs in Biomedicine 54, 141–150 (1997). Download article .   "  Category:Scattering theory   