   Draft:Portfolio performance contributions      Draft:Portfolio performance contributions   Portfolio performance contributions 1 form a summable set of measures which explains and breaks down the different sources of a portfolio global performance in presence of external flows. Portfolio external flows are movements of value in or out of the portfolio such as transfers of cash, securities or other instruments, with no equal simultaneous movement of value in the opposite direction, and which are not income (such as interest, coupons or dividends) or outcome (such as fees) from the investments in the portfolio. The sum of the performance contribution of all the portfolio components (such as securities performance, currencies performance, fees or other portfolio internal sources of performance) equals the total portfolio performance (i.e. portfolio performance contributions are additive).  Formula  The portfolio performance contributions computation algorithm, developed by R. Barbanneau , is as follows:  Introduction  Inputs  Let,       Π  t     subscript  normal-Π  t    \Pi_{t}   the portfolio total net asset value at time step   t   t   t   ,       \Epsilon   t     subscript  \Epsilon  t    \Epsilon_{t}   the portfolio net external cash flow at time step   t   t   t   with      \Epsilon   0   =  0       subscript  \Epsilon  0   0    \Epsilon_{0}=0   ,      m   k  ,  t      subscript  m   k  t     m_{k,t}   the portfolio component   k   k   k   movement quantity (i.e. traded quantity) at time step   t   t   t   with    m   k  ,  0      subscript  m   k  0     m_{k,0}   the quantity held at the beginning of the period, at time step    t  =  0      t  0    t=0   ,      p   k  ,  t      subscript  p   k  t     p_{k,t}   the portfolio component   k   k   k   price at time step   t   t   t   ,      d   k  ,  t      subscript  d   k  t     d_{k,t}   the portfolio component   k   k   k   dividend payment at time step   t   t   t   with     d   k  ,  0    =  0       subscript  d   k  0    0    d_{k,0}=0   ,      f   k  ,  t      subscript  f   k  t     f_{k,t}   the portfolio component   k   k   k   currency exchange rate (against the portfolio base currency) at time step   t   t   t   .   Traded quantity adjusted currency exchange rate  The performance contributions inherited from the currency contribution of portfolio components are evaluated by computing the weighted average traded quantity currency exchange rate for each portfolio component at each time step   t   t   t   (other valuation methodologies can be used for computation, such as FIFO and LIFO accounting ). Let    ϕ   k  ,  t      subscript  ϕ   k  t     \phi_{k,t}   the portfolio component   k   k   k   weighted average traded quantity currency exchange rate (against the portfolio base currency) at time step   t   t   t   ,       ϕ   k  ,  t    =   1     α   k  ,  t    ⋅    1   f   k  ,  t       +    (   1  -   α   k  ,  t     )   ⋅      ∑   i  =  0    t  -  1       m   k  ,  i     ϕ   k  ,  i         ∑   i  =  0    t  -  1     m   k  ,  i               subscript  ϕ   k  t     continued-fraction  1     normal-⋅   subscript  α   k  t     continued-fraction  1   subscript  f   k  t       normal-⋅    1   subscript  α   k  t      continued-fraction    superscript   subscript     i  0      t  1     continued-fraction   subscript  m   k  i     subscript  ϕ   k  i        superscript   subscript     i  0      t  1     subscript  m   k  i           \phi_{k,t}=\cfrac{1}{\alpha_{k,t}\cdot\cfrac{1}{f_{k,t}}+(1-\alpha_{k,t})\cdot%
 \cfrac{\sum\limits_{i=0}^{t-1}\cfrac{m_{k,i}}{\phi_{k,i}}}{\sum\limits_{i=0}^{%
 t-1}m_{k,i}}}     With,       ϕ   k  ,  0    =   f   k  ,  0         subscript  ϕ   k  0     subscript  f   k  0      \phi_{k,0}=f_{k,0}          ϕ   k  ,  t    =    f   k  ,  t    if   m   k  ,  t     =   0  or    ∑   i  =  0    t  -  1     m   k  ,  i      =  0         subscript  ϕ   k  t       subscript  f   k  t    if   subscript  m   k  t            0  or    superscript   subscript     i  0      t  1     subscript  m   k  i           0     \phi_{k,t}=f_{k,t}\text{ if }m_{k,t}=0\text{ or }\sum\limits_{i=0}^{t-1}m_{k,i%
 }=0     Where    α   k  ,  t      subscript  α   k  t     \alpha_{k,t}   is the proportion of the portfolio component   k   k   k   traded quantity at time step   t   t   t   impacting the weighted average traded quantity currency exchange rate of component   k   k   k   ,       α   k  ,  t    =   max   {  0  ,   min   {  1  ,     ∑   i  =  0   t    m   k  ,  i      m   k  ,  t     }    }         subscript  α   k  t      0    1   continued-fraction    superscript   subscript     i  0    t    subscript  m   k  i      subscript  m   k  t         \alpha_{k,t}=\max\left\{0,\min\left\{1,\cfrac{\sum\limits_{i=0}^{t}m_{k,i}}{m_%
 {k,t}}\right\}\right\}     Adjustement factor  Each external cash flow has an impact on the performance contributions computation, both at the portfolio level and the portfolio components level. External inflows dilute the performance whereas external outflows concentrate the performance.   Let    Λ  t     subscript  normal-Λ  t    \Lambda_{t}   the portfolio adjustement factor (i.e. the performance dilution or concentration measurement at the portfolio level) at time step   t   t   t   ,        Λ  t   =    ∏   i  =  1   t     (   1  -     \Epsilon   i    Π  i     )   with   Λ  0     =  1         subscript  normal-Λ  t     superscript   subscript  product    i  1    t       1   continued-fraction   subscript  \Epsilon  i    subscript  normal-Π  i     with   subscript  normal-Λ  0          1     \Lambda_{t}=\prod_{i=1}^{t}\left(1-\cfrac{\Epsilon_{i}}{\Pi_{i}}\right)\text{ %
 with }\Lambda_{0}=1      Let    λ   k  ,  t      subscript  λ   k  t     \lambda_{k,t}   the portfolio component   k   k   k   adjustement factor (i.e. the performance dilution or concentration measurement at the portfolio component   k   k   k   level) at time step   t   t   t   ,        λ   k  ,  t    =    ∏   i  =  1   t     (   1  -     \Epsilon   i     Π  i   +      ∑   j  =  1   i     m   k  ,  j     (    p   k  ,  i    -   p   k  ,  j     )    (     1   ϕ   k  ,  j      -    1   f   k  ,  i       )     ⏟   price adjustement factor   +      ∑   j  =  1   i     ∑   l  =  0    j  -  1      m   k  ,  l     d   k  ,  j     (     1   ϕ   k  ,  l      -    1   f   k  ,  i       )      ⏟   dividend adjustement factor      )   with   λ   k  ,  0      =  1         subscript  λ   k  t      superscript   subscript  product    i  1    t       1   continued-fraction   subscript  \Epsilon  i      subscript  normal-Π  i    subscript   normal-⏟    superscript   subscript     j  1    i      subscript  m   k  j       subscript  p   k  i     subscript  p   k  j        continued-fraction  1   subscript  ϕ   k  j      continued-fraction  1   subscript  f   k  i         price adjustement factor    subscript   normal-⏟    superscript   subscript     j  1    i     superscript   subscript     l  0      j  1       subscript  m   k  l     subscript  d   k  j       continued-fraction  1   subscript  ϕ   k  l      continued-fraction  1   subscript  f   k  i          dividend adjustement factor      with   subscript  λ   k  0           1     \lambda_{k,t}=\prod_{i=1}^{t}\left(1-\cfrac{\Epsilon_{i}}{\Pi_{i}+\underbrace{%
 \sum\limits_{j=1}^{i}m_{k,j}\left(p_{k,i}-p_{k,j}\right)\left(\cfrac{1}{\phi_{%
 k,j}}-\cfrac{1}{f_{k,i}}\right)}_{\text{price adjustement factor}}+\underbrace%
 {\sum\limits_{j=1}^{i}\sum\limits_{l=0}^{j-1}m_{k,l}d_{k,j}\left(\cfrac{1}{%
 \phi_{k,l}}-\cfrac{1}{f_{k,i}}\right)}_{\text{dividend adjustement factor}}}%
 \right)\text{ with }\lambda_{k,0}=1     Global portfolio performance  Let,       r  t     subscript  r  t    r_{t}   the global portfolio performance,      r   k  ,  t      subscript  r   k  t     r_{k,t}   the performance contribution of the   k   k   k   -th portfolio component for    k  ∈   [  1  ,  n  ]       k   1  n     k\in[1,n]   ,   Each component is decomposed into two sources of performance contribution,       r   k  ,  t   base     superscript   subscript  r   k  t    base    r_{k,t}^{\text{base}}   the performance contribution of the   k   k   k   -th portfolio component hedged continuously against the currency variations,      r   k  ,  t   crcy     superscript   subscript  r   k  t    crcy    r_{k,t}^{\text{crcy}}   the performance contribution of the currency variations of the   k   k   k   -th portfolio component,   Hence,       r  t   =    ∑   k  =  1   n      (    r   k  ,  t   base   +   r   k  ,  t   crcy    )   ⏟     =   r   k  ,  t            subscript  r  t     superscript   subscript     k  1    n    subscript   normal-⏟     superscript   subscript  r   k  t    base    superscript   subscript  r   k  t    crcy       absent   subscript  r   k  t         r_{t}=\sum\limits_{k=1}^{n}\underbrace{\left(r_{k,t}^{\text{base}}+r_{k,t}^{%
 \text{crcy}}\right)}_{=r_{k,t}}     Performance contribution of portfolio components  For every    k  ∈   [  1  ,  n  ]       k   1  n     k\in[1,n]   , the performance contribution of the   k   k   k   -th portfolio component is computed as follows,       r   k  ,  t    =    1   Π  0      ∑   i  =  1   t     Λ   i  -  1     (       ∑   j  =  0    i  -  1      m   k  ,  j     (      p   k  ,  i    -   p   k  ,  j      f   k  ,  i     -     p   k  ,   i  -  1     -   p   k  ,  j      f   k  ,   i  -  1       )     ⏟   price   +         ∑   j  =  1    i  -  1      ∑   l  =  0    j  -  1      m   k  ,  l     d   k  ,  j     (    1   f   k  ,  i     -   1   f   k  ,   i  -  1       )      ⏟   paid   +      ∑   j  =  0    i  -  1      m   k  ,  j      d   k  ,  i     f   k  ,  i       ⏟   to be paid    ⏟   dividend    )           subscript  r   k  t       continued-fraction  1   subscript  normal-Π  0      superscript   subscript     i  1    t      subscript  normal-Λ    i  1       subscript   normal-⏟    superscript   subscript     j  0      i  1       subscript  m   k  j       continued-fraction     subscript  p   k  i     subscript  p   k  j      subscript  f   k  i      continued-fraction     subscript  p   k    i  1      subscript  p   k  j      subscript  f   k    i  1          price    subscript   normal-⏟     subscript   normal-⏟    superscript   subscript     j  1      i  1      superscript   subscript     l  0      j  1       subscript  m   k  l     subscript  d   k  j       continued-fraction  1   subscript  f   k  i      continued-fraction  1   subscript  f   k    i  1           paid    subscript   normal-⏟    superscript   subscript     j  0      i  1       subscript  m   k  j     continued-fraction   subscript  d   k  i     subscript  f   k  i        to be paid     dividend         r_{k,t}=\cfrac{1}{\Pi_{0}}\sum\limits_{i=1}^{t}\Lambda_{i-1}\left(\underbrace{%
 \sum\limits_{j=0}^{i-1}m_{k,j}\left(\cfrac{p_{k,i}-p_{k,j}}{f_{k,i}}-\cfrac{p_%
 {k,i-1}-p_{k,j}}{f_{k,i-1}}\right)}_{\text{price}}+\underbrace{\underbrace{%
 \sum\limits_{j=1}^{i-1}\sum\limits_{l=0}^{j-1}m_{k,l}d_{k,j}\left(\cfrac{1}{f_%
 {k,i}}-\cfrac{1}{f_{k,i-1}}\right)}_{\text{paid}}+\underbrace{\sum\limits_{j=0%
 }^{i-1}m_{k,j}\cfrac{d_{k,i}}{f_{k,i}}}_{\text{to be paid}}}_{\text{dividend}}\right)     Base contribution       r   k  ,  t   base   =    1   Π  0      ∑   i  =  1   t     λ   k  ,   i  -  1      (       ∑   j  =  0    i  -  1      m   k  ,  j      (    p   k  ,  i    -   p   k  ,   i  -  1      )    ϕ   k  ,  j       ⏟   price   +      ∑   j  =  0    i  -  1      m   k  ,  j      d   k  ,  i     ϕ   k  ,  j       ⏟   dividend    )           superscript   subscript  r   k  t    base      continued-fraction  1   subscript  normal-Π  0      superscript   subscript     i  1    t      subscript  λ   k    i  1        subscript   normal-⏟    superscript   subscript     j  0      i  1       subscript  m   k  j     continued-fraction     subscript  p   k  i     subscript  p   k    i  1       subscript  ϕ   k  j        price    subscript   normal-⏟    superscript   subscript     j  0      i  1       subscript  m   k  j     continued-fraction   subscript  d   k  i     subscript  ϕ   k  j        dividend         r_{k,t}^{\text{base}}=\cfrac{1}{\Pi_{0}}\sum\limits_{i=1}^{t}\lambda_{k,i-1}%
 \left(\underbrace{\sum\limits_{j=0}^{i-1}m_{k,j}\cfrac{\left(p_{k,i}-p_{k,i-1}%
 \right)}{\phi_{k,j}}}_{\text{price}}+\underbrace{\sum\limits_{j=0}^{i-1}m_{k,j%
 }\cfrac{d_{k,i}}{\phi_{k,j}}}_{\text{dividend}}\right)     Currency contribution       r   k  ,  t   crcy   =    r   k  ,  t    -   r   k  ,  t   base         superscript   subscript  r   k  t    crcy      subscript  r   k  t     superscript   subscript  r   k  t    base      r_{k,t}^{\text{crcy}}=r_{k,t}-r_{k,t}^{\text{base}}     Interpretation  The portfolio performance contributions algorithm evaluates over a period of time the different sources of performance of a portfolio. By decomposing the contribution of each portfolio component into a base and a currency part, the algorithm allows the computation of contributions to the performance of currencies over a portfolio. Furthermore, the performance contribution of specific portfolio components computation, such as compensatory fees, can be derived from the method by weighting each amount at each time step by the portfolio adjustement factor.  Algorithm  VBA  Public Function PortfolioPerformanceContributions( _
     t As Integer, _
     n As Integer, _
     TNAV() As Double, _
     E() As Double, _
     m() As Double, _
     p() As Double, _
     d() As Double, _
     f() As Double) As Double()
     
     ' Function inputs
     ' ================================================================
     ' t : time steps 0 to t
     ' n : portfolio components 1 to n
     ' TNAV(i) : portfolio total net asset at time step i as [0, t]
     ' E(i) : portfolio net external cash flow at time step i as [0, t]
     ' m(k,i) : portfolio component k movement quantity at time step i as [1, n]x[0, t]
     ' p(k,i) : portfolio component k price at time step i as [1, n]x[0, t]
     ' d(k,i) : portfolio component k dividend at time step i as [1, n]x[0, t]
     ' f(k,i) : portfolio component k currency exchange rate at time step i as [1, n]x[0, t]
     
     ' Function outputs
     ' ================================================================
     ' r(k,part) : portfolio component k performance contributions
     '             with 0 = component
     '                  1 = base component part
     '                  2 = currency component part
     Dim r() As Double: ReDim r(1 To n, 0 To 2)
     
     ' Variables
     ' ================================================================
     Dim i As Integer, j As Integer, k As Integer, l As Integer
     Dim var1 As Double, var2 As Double, var3 As Double
     
     Dim phi() As Double: ReDim phi(1 To n, 0 To t)
     
     Dim lambda_ptf() As Double: ReDim lambda_ptf(0 To t)
     Dim lambda() As Double: ReDim lambda(1 To n, 0 To t)
     
     ' Computation
     ' ================================================================
     ' Portfolio lambda adjustement factor
     lambda_ptf(0) = 1
     For i = 1 To t
         lambda_ptf(i) = lambda_ptf(i - 1) * (1 - E(i) / TNAV(i))
     Next i
     
     ' Components weighted average movements currency exchange rate
     For k = 1 To n
         phi(k, 0) = f(k, 0)
         For i = 1 To t
             If m(k, i) = 0 Then
                 phi(k, i) = f(k, i)
             Else
                 var1 = 0
                 For j = 0 To i - 1
                     var1 = var1 + m(k, j)
                 Next j
                 If var1 = 0 Then
                     phi(k, i) = f(k, i)
                 Else
                     With Application.WorksheetFunction
                         var2 = .Max(0, .Min(1, (var1 + m(k, i)) / m(k, i)))
                     End With
                     var3 = 0
                     For j = 0 To i - 1
                         var3 = var3 + m(k, j) / phi(k, j)
                     Next j
                     phi(k, i) = 1 / (var2 / f(k, i) + (1 - var2) * var3 / var1)
                 End If
             End If
         Next i
     Next k
     
     ' Components lambda adjustement factor
     For k = 1 To n
         lambda(k, 0) = 1
         For i = 1 To t
             var1 = 0
             For j = 0 To i
                 var1 = var1 + m(k, j) * (p(k, i) - p(k, j)) * (1 / phi(k, j) - 1 / f(k, i))
             Next j
             var2 = 0
             For j = 1 To i
                 For l = 0 To j - 1
                     var2 = var2 + d(k, j) * m(k, l) * (1 / phi(k, l) - 1 / f(k, i))
                 Next l
             Next j
             lambda(k, i) = lambda(k, i - 1) * (1 - E(i) / (TNAV(i) + var1 + var2))
         Next i
     Next k
     
     ' Performance contributions
     For k = 1 To n
         ' Component performance contributions
         r(k, 0) = 0
         For i = 1 To t
             var1 = 0
             For j = 0 To i - 1
                 var1 = var1 + m(k, j) * ((p(k, i) - p(k, j)) / f(k, i) - (p(k, i - 1) - p(k, j)) / f(k, i - 1))
             Next j
             var2 = 0
             For j = 0 To i - 1
                 var2 = var2 + m(k, j) * d(k, i) / f(k, i)
             Next j
             var3 = 0
             For j = 1 To i - 1
                 For l = 0 To j - 1
                     var3 = var3 + d(k, j) * m(k, l) * (1 / f(k, i) - 1 / f(k, i - 1))
                 Next l
             Next j
             r(k, 0) = r(k, 0) + lambda_ptf(i - 1) * (var1 + var2 + var3)
         Next i
         r(k, 0) = r(k, 0) / TNAV(0)
         
         ' Base component part performance contributions
         r(k, 1) = 0
         For i = 1 To t
             var1 = 0
             For j = 0 To i - 1
                 var1 = var1 + m(k, j) * (p(k, i) - p(k, i - 1)) / phi(k, j)
             Next j
             var2 = 0
             For j = 0 To i - 1
                 var2 = var2 + m(k, j) * d(k, i) / phi(k, j)
             Next j
             r(k, 1) = r(k, 1) + lambda(k, i - 1) * (var1 + var2)
         Next i
         r(k, 1) = r(k, 1) / TNAV(0)
         
         ' Currency component part performance contributions
         r(k, 2) = r(k, 0) - r(k, 1)
     Next k
 
     PortfolioPerformanceContributions = r
 End Function  The above VBA algorithm is designed to be used with Excel.  See also   Time-weighted return  Modified Dietz method  Simple Dietz method  Performance attribution   References      "      Barbanneau, Rodolphe. Portfolio Performance Contributions Computation Algorithm , 2014 ↩     