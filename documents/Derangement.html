<html lang="en">
<head>
<meta charset="utf-8"/>
<title offset="535">Derangement</title>
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_SVG.js" type="text/javascript">
</script>
</head>
<body>
<h1>Derangement</h1>
<hr/>

<p>[[<a class="uri" href="File:n">File:n</a>! v !n.svg|thumb|300px|Number of possible permutations and derangements of <em>n</em> elements. <em>n</em>! (<em>n</em> factorial) is the number of <em>n</em>-permutations; !<em>n</em> (<em>n</em> subfactorial) is the number of derangements — <em>n</em>-permutations where all of the <em>n</em> elements change their initial places.</p>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">
<p>Table of values</p></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">
<p>

<math display="inline" id="Derangement:0">
 <semantics>
  <mi>n</mi>
  <annotation-xml encoding="MathML-Content">
   <ci>n</ci>
  </annotation-xml>
  <annotation encoding="application/x-tex">
   n
  </annotation>
 </semantics>
</math>

</p></td>
</tr>
<tr class="even">
<td style="text-align: left;">
<p>0</p></td>
</tr>
<tr class="odd">
<td style="text-align: left;">
<p>1</p></td>
</tr>
<tr class="even">
<td style="text-align: left;">
<p>2</p></td>
</tr>
<tr class="odd">
<td style="text-align: left;">
<p>3</p></td>
</tr>
<tr class="even">
<td style="text-align: left;">
<p>4</p></td>
</tr>
<tr class="odd">
<td style="text-align: left;">
<p>5</p></td>
</tr>
<tr class="even">
<td style="text-align: left;">
<p>6</p></td>
</tr>
<tr class="odd">
<td style="text-align: left;">
<p>7</p></td>
</tr>
<tr class="even">
<td style="text-align: left;">
<p>8</p></td>
</tr>
<tr class="odd">
<td style="text-align: left;">
<p>9</p></td>
</tr>
<tr class="even">
<td style="text-align: left;">
<p>10</p></td>
</tr>
<tr class="odd">
<td style="text-align: left;">
<p>11</p></td>
</tr>
<tr class="even">
<td style="text-align: left;">
<p>12</p></td>
</tr>
<tr class="odd">
<td style="text-align: left;">
<p>13</p></td>
</tr>
<tr class="even">
<td style="text-align: left;">
<p>14</p></td>
</tr>
<tr class="odd">
<td style="text-align: left;">
<p>15</p></td>
</tr>
<tr class="even">
<td style="text-align: left;">
<p>16</p></td>
</tr>
<tr class="odd">
<td style="text-align: left;">
<p>17</p></td>
</tr>
<tr class="even">
<td style="text-align: left;">
<p>18</p></td>
</tr>
<tr class="odd">
<td style="text-align: left;">
<p>19</p></td>
</tr>
<tr class="even">
<td style="text-align: left;">
<p>20</p></td>
</tr>
<tr class="odd">
<td style="text-align: left;">
<p>21</p></td>
</tr>
<tr class="even">
<td style="text-align: left;">
<p>22</p></td>
</tr>
<tr class="odd">
<td style="text-align: left;">
<p>23</p></td>
</tr>
<tr class="even">
<td style="text-align: left;">
<p>24</p></td>
</tr>
<tr class="odd">
<td style="text-align: left;">
<p>25</p></td>
</tr>
<tr class="even">
<td style="text-align: left;">
<p>26</p></td>
</tr>
<tr class="odd">
<td style="text-align: left;">
<p>27</p></td>
</tr>
<tr class="even">
<td style="text-align: left;">
<p>28</p></td>
</tr>
<tr class="odd">
<td style="text-align: left;">
<p>29</p></td>
</tr>
<tr class="even">
<td style="text-align: left;">
<p>30</p></td>
</tr>
</tbody>
</table>

<p>]]</p>

<p>In <a href="combinatorics" title="wikilink">combinatorial</a> <a class="uri" href="mathematics" title="wikilink">mathematics</a>, a <strong>derangement</strong> is a <a class="uri" href="permutation" title="wikilink">permutation</a> of the elements of a <a href="set_(mathematics)" title="wikilink">set</a>, such that no element appears in its original position.</p>

<p>The number of derangements of a set of size <em>n</em>, usually written <em>D<sub>n</sub></em>, <em>d<sub>n</sub></em>, or !<em>n</em>, is called the "derangement number" or "de Montmort number". (These numbers are generalized to <a href="rencontres_numbers" title="wikilink">rencontres numbers</a>.) The <strong>subfactorial</strong> function (not to be confused with the <a class="uri" href="factorial" title="wikilink">factorial</a> <em>n</em>!) maps <em>n</em> to !<em>n</em>.<a class="footnoteRef" href="#fn1" id="fnref1"><sup>1</sup></a> No standard notation for subfactorials is agreed upon; <em>n</em>¡ is sometimes used instead of !<em>n</em>.<a class="footnoteRef" href="#fn2" id="fnref2"><sup>2</sup></a></p>

<p>The problem of counting derangements was first considered by <a href="Pierre_Raymond_de_Montmort" title="wikilink">Pierre Raymond de Montmort</a><a class="footnoteRef" href="#fn3" id="fnref3"><sup>3</sup></a> in 1708; he solved it in 1713, as did <a href="Nicolaus_I_Bernoulli" title="wikilink">Nicholas Bernoulli</a> at about the same time.</p>
<h2 id="example">Example</h2>

<p> Suppose that a professor has had 4 of his students – student A, student B, student C, and student D – take a test and wants to let his students grade each other's tests. Of course, no student should grade his or her own test. How many ways could the professor hand the tests back to the students for grading, such that no student received his or her own test back? Out of <a href="v:Symmetric_group_S4#tables" title="wikilink">24 possible permutations</a> (4!) for handing back the tests, there are only 9 derangements:</p>
<dl>
<dd>BADC, BCDA, BDAC,
</dd>
<dd>CADB, CDAB, CDBA,
</dd>
<dd>DABC, DCAB, DCBA.
</dd>
</dl>

<p>In every other permutation of this 4-member set, at least one student gets his or her own test back.</p>

<p>Another version of the problem arises when we ask for the number of ways <em>n</em> letters, each addressed to a different person, can be placed in <em>n</em> pre-addressed envelopes so that no letter appears in the correctly addressed envelope.</p>
<h2 id="counting-derangements">Counting derangements</h2>

<p>Suppose that there are <em>n</em> persons numbered 1, 2, ..., <em>n</em>. Let there be <em>n</em> hats also numbered 1, 2, ..., <em>n</em>. We have to find the number of ways in which no one gets the hat having same number as his/her number. Let us assume that the first person takes hat <em>i</em>. There are <em>n</em> − 1 ways for the first person to make such a choice. There are now two possibilities, depending on whether or not person <em>i</em> takes hat 1 in return:</p>
<ol>
<li>Person <em>i</em> does not take the hat 1. This case is equivalent to solving the problem with <em>n</em> − 1 persons and <em>n</em> − 1 hats: each of the remaining <em>n</em> − 1 people has precisely 1 forbidden choice from among the remaining <em>n</em> − 1 hats (<em>i</em>'s forbidden choice is hat 1).</li>
<li>Person <em>i</em> takes the hat 1. Now the problem reduces to <em>n</em> − 2 persons and <em>n</em> − 2 hats.</li>
</ol>

<p>From this, the following relation is derived:</p>

<p>

<math display="block" id="Derangement:1">
 <semantics>
  <mrow>
   <mo lspace="0pt" rspace="3.5pt">!</mo>
   <mi>n</mi>
   <mo>=</mo>
   <mrow>
    <mo stretchy="false">(</mo>
    <mi>n</mi>
    <mo>-</mo>
    <mn>1</mn>
    <mo stretchy="false">)</mo>
   </mrow>
   <mrow>
    <mo stretchy="false">(</mo>
    <mo lspace="0pt" rspace="3.5pt">!</mo>
    <mrow>
     <mo stretchy="false">(</mo>
     <mi>n</mi>
     <mo>-</mo>
     <mn>1</mn>
     <mo stretchy="false">)</mo>
    </mrow>
    <mo>+</mo>
    <mo lspace="0pt" rspace="3.5pt">!</mo>
    <mrow>
     <mo stretchy="false">(</mo>
     <mi>n</mi>
     <mo>-</mo>
     <mn>2</mn>
     <mo stretchy="false">)</mo>
    </mrow>
    <mo stretchy="false">)</mo>
   </mrow>
   <mo rspace="4.2pt">.</mo>
  </mrow>
  <annotation-xml encoding="MathML-Content">
   <cerror>
    <csymbol cd="ambiguous">fragments</csymbol>
    <factorial></factorial>
    <csymbol cd="unknown">n</csymbol>
    <eq></eq>
    <cerror>
     <csymbol cd="ambiguous">fragments</csymbol>
     <ci>normal-(</ci>
     <csymbol cd="unknown">n</csymbol>
     <minus></minus>
     <cn type="integer">1</cn>
     <ci>normal-)</ci>
    </cerror>
    <cerror>
     <csymbol cd="ambiguous">fragments</csymbol>
     <ci>normal-(</ci>
     <factorial></factorial>
     <cerror>
      <csymbol cd="ambiguous">fragments</csymbol>
      <ci>normal-(</ci>
      <csymbol cd="unknown">n</csymbol>
      <minus></minus>
      <cn type="integer">1</cn>
      <ci>normal-)</ci>
     </cerror>
     <plus></plus>
     <factorial></factorial>
     <cerror>
      <csymbol cd="ambiguous">fragments</csymbol>
      <ci>normal-(</ci>
      <csymbol cd="unknown">n</csymbol>
      <minus></minus>
      <cn type="integer">2</cn>
      <ci>normal-)</ci>
     </cerror>
     <ci>normal-)</ci>
    </cerror>
    <ci>normal-.</ci>
   </cerror>
  </annotation-xml>
  <annotation encoding="application/x-tex">
   !n=(n-1)(!(n-1)+!(n-2)).\,
  </annotation>
 </semantics>
</math>

</p>

<p>where !n, known as the subfactorial, represents the number of derangements, with the starting values !0 = 1 and !1 = 0.</p>

<p>Notice that this same recurrence formula also works for factorials with different starting values. That is 0! = 1, 1! = 1 and</p>

<p>

<math display="block" id="Derangement:2">
 <semantics>
  <mrow>
   <mrow>
    <mi>n</mi>
    <mo lspace="0pt" rspace="3.5pt">!</mo>
   </mrow>
   <mo>=</mo>
   <mrow>
    <mrow>
     <mo stretchy="false">(</mo>
     <mrow>
      <mi>n</mi>
      <mo>-</mo>
      <mn>1</mn>
     </mrow>
     <mo stretchy="false">)</mo>
    </mrow>
    <mrow>
     <mo stretchy="false">(</mo>
     <mrow>
      <mrow>
       <mrow>
        <mo stretchy="false">(</mo>
        <mrow>
         <mi>n</mi>
         <mo>-</mo>
         <mn>1</mn>
        </mrow>
        <mo stretchy="false">)</mo>
       </mrow>
       <mo lspace="0pt" rspace="3.5pt">!</mo>
      </mrow>
      <mo>+</mo>
      <mrow>
       <mrow>
        <mo stretchy="false">(</mo>
        <mrow>
         <mi>n</mi>
         <mo>-</mo>
         <mn>2</mn>
        </mrow>
        <mo stretchy="false">)</mo>
       </mrow>
       <mo lspace="0pt" rspace="3.5pt">!</mo>
      </mrow>
     </mrow>
     <mo rspace="4.2pt" stretchy="false">)</mo>
    </mrow>
   </mrow>
  </mrow>
  <annotation-xml encoding="MathML-Content">
   <apply>
    <eq></eq>
    <apply>
     <factorial></factorial>
     <ci>n</ci>
    </apply>
    <apply>
     <times></times>
     <apply>
      <minus></minus>
      <ci>n</ci>
      <cn type="integer">1</cn>
     </apply>
     <apply>
      <plus></plus>
      <apply>
       <factorial></factorial>
       <apply>
        <minus></minus>
        <ci>n</ci>
        <cn type="integer">1</cn>
       </apply>
      </apply>
      <apply>
       <factorial></factorial>
       <apply>
        <minus></minus>
        <ci>n</ci>
        <cn type="integer">2</cn>
       </apply>
      </apply>
     </apply>
    </apply>
   </apply>
  </annotation-xml>
  <annotation encoding="application/x-tex">
   n!=(n-1)((n-1)!+(n-2)!)\,
  </annotation>
 </semantics>
</math>

</p>

<p>which is helpful in proving the limit relationship with <em>e</em> below.</p>

<p>Also, the following formulae are known:<a class="footnoteRef" href="#fn4" id="fnref4"><sup>4</sup></a></p>

<p>

<math display="block" id="Derangement:3">
 <semantics>
  <mrow>
   <mo lspace="0pt" rspace="3.5pt">!</mo>
   <mi>n</mi>
   <mo>=</mo>
   <mi>n</mi>
   <mo lspace="0pt" rspace="3.5pt">!</mo>
   <munderover>
    <mo largeop="true" movablelimits="false" symmetric="true">∑</mo>
    <mrow>
     <mi>i</mi>
     <mo>=</mo>
     <mn>0</mn>
    </mrow>
    <mi>n</mi>
   </munderover>
   <mfrac>
    <msup>
     <mrow>
      <mo stretchy="false">(</mo>
      <mrow>
       <mo>-</mo>
       <mn>1</mn>
      </mrow>
      <mo stretchy="false">)</mo>
     </mrow>
     <mi>i</mi>
    </msup>
    <mrow>
     <mi>i</mi>
     <mo lspace="0pt" rspace="3.5pt">!</mo>
    </mrow>
   </mfrac>
   <mo>,</mo>
  </mrow>
  <annotation-xml encoding="MathML-Content">
   <cerror>
    <csymbol cd="ambiguous">fragments</csymbol>
    <factorial></factorial>
    <csymbol cd="unknown">n</csymbol>
    <eq></eq>
    <csymbol cd="unknown">n</csymbol>
    <factorial></factorial>
    <apply>
     <csymbol cd="ambiguous">superscript</csymbol>
     <apply>
      <csymbol cd="ambiguous">subscript</csymbol>
      <sum></sum>
      <apply>
       <eq></eq>
       <ci>i</ci>
       <cn type="integer">0</cn>
      </apply>
     </apply>
     <ci>n</ci>
    </apply>
    <apply>
     <divide></divide>
     <apply>
      <csymbol cd="ambiguous">superscript</csymbol>
      <apply>
       <minus></minus>
       <cn type="integer">1</cn>
      </apply>
      <ci>i</ci>
     </apply>
     <apply>
      <factorial></factorial>
      <ci>i</ci>
     </apply>
    </apply>
    <ci>normal-,</ci>
   </cerror>
  </annotation-xml>
  <annotation encoding="application/x-tex">
   !n=n!\sum_{i=0}^{n}\frac{(-1)^{i}}{i!},
  </annotation>
 </semantics>
</math>

</p>

<p>

<math display="block" id="Derangement:4">
 <semantics>
  <mrow>
   <mo lspace="0pt" rspace="3.5pt">!</mo>
   <mi>n</mi>
   <mo>=</mo>
   <mrow>
    <mo>[</mo>
    <mfrac>
     <mrow>
      <mi>n</mi>
      <mo lspace="0pt" rspace="3.5pt">!</mo>
     </mrow>
     <mi>e</mi>
    </mfrac>
    <mo>]</mo>
   </mrow>
   <mo>=</mo>
   <mrow>
    <mo>⌊</mo>
    <mfrac>
     <mrow>
      <mi>n</mi>
      <mo lspace="0pt" rspace="3.5pt">!</mo>
     </mrow>
     <mi>e</mi>
    </mfrac>
    <mo>+</mo>
    <mfrac>
     <mn>1</mn>
     <mn>2</mn>
    </mfrac>
    <mo>⌋</mo>
   </mrow>
   <mo rspace="12.5pt">,</mo>
   <mi>n</mi>
   <mo>≥</mo>
   <mn>1</mn>
  </mrow>
  <annotation-xml encoding="MathML-Content">
   <cerror>
    <csymbol cd="ambiguous">fragments</csymbol>
    <factorial></factorial>
    <csymbol cd="unknown">n</csymbol>
    <eq></eq>
    <cerror>
     <csymbol cd="ambiguous">fragments</csymbol>
     <ci>normal-[</ci>
     <apply>
      <divide></divide>
      <apply>
       <factorial></factorial>
       <ci>n</ci>
      </apply>
      <ci>e</ci>
     </apply>
     <ci>normal-]</ci>
    </cerror>
    <eq></eq>
    <cerror>
     <csymbol cd="ambiguous">fragments</csymbol>
     <ci>normal-⌊</ci>
     <apply>
      <divide></divide>
      <apply>
       <factorial></factorial>
       <ci>n</ci>
      </apply>
      <ci>e</ci>
     </apply>
     <plus></plus>
     <apply>
      <divide></divide>
      <cn type="integer">1</cn>
      <cn type="integer">2</cn>
     </apply>
     <ci>normal-⌋</ci>
    </cerror>
    <ci>normal-,</ci>
    <csymbol cd="unknown">n</csymbol>
    <geq></geq>
    <cn type="integer">1</cn>
   </cerror>
  </annotation-xml>
  <annotation encoding="application/x-tex">
   !n=\left[\frac{n!}{e}\right]=\left\lfloor\frac{n!}{e}+\frac{1}{2}\right\rfloor%
,\quad n\geq 1
  </annotation>
 </semantics>
</math>

 where 

<math display="inline" id="Derangement:5">
 <semantics>
  <mrow>
   <mo>[</mo>
   <mi>x</mi>
   <mo>]</mo>
  </mrow>
  <annotation-xml encoding="MathML-Content">
   <apply>
    <csymbol cd="latexml">delimited-[]</csymbol>
    <ci>x</ci>
   </apply>
  </annotation-xml>
  <annotation encoding="application/x-tex">
   \left[x\right]
  </annotation>
 </semantics>
</math>

 is the <a href="nearest_integer_function" title="wikilink">nearest integer function</a> and 

<math display="inline" id="Derangement:6">
 <semantics>
  <mrow>
   <mo>⌊</mo>
   <mi>x</mi>
   <mo>⌋</mo>
  </mrow>
  <annotation-xml encoding="MathML-Content">
   <apply>
    <floor></floor>
    <ci>x</ci>
   </apply>
  </annotation-xml>
  <annotation encoding="application/x-tex">
   \left\lfloor x\right\rfloor
  </annotation>
 </semantics>
</math>

 is the <a href="floor_function" title="wikilink">floor function</a>.</p>

<p>

<math display="block" id="Derangement:7">
 <semantics>
  <mrow>
   <mo lspace="0pt" rspace="3.5pt">!</mo>
   <mi>n</mi>
   <mo>=</mo>
   <mrow>
    <mo>⌊</mo>
    <mrow>
     <mo stretchy="false">(</mo>
     <mi>e</mi>
     <mo>+</mo>
     <msup>
      <mi>e</mi>
      <mrow>
       <mo>-</mo>
       <mn>1</mn>
      </mrow>
     </msup>
     <mo stretchy="false">)</mo>
    </mrow>
    <mi>n</mi>
    <mo lspace="0pt" rspace="3.5pt">!</mo>
    <mo>⌋</mo>
   </mrow>
   <mo>-</mo>
   <mrow>
    <mo stretchy="false">⌊</mo>
    <mi>e</mi>
    <mi>n</mi>
    <mo lspace="0pt" rspace="3.5pt">!</mo>
    <mo stretchy="false">⌋</mo>
   </mrow>
   <mo rspace="12.5pt">,</mo>
   <mi>n</mi>
   <mo>≥</mo>
   <mn>2</mn>
   <mo>,</mo>
  </mrow>
  <annotation-xml encoding="MathML-Content">
   <cerror>
    <csymbol cd="ambiguous">fragments</csymbol>
    <factorial></factorial>
    <csymbol cd="unknown">n</csymbol>
    <eq></eq>
    <cerror>
     <csymbol cd="ambiguous">fragments</csymbol>
     <ci>normal-⌊</ci>
     <cerror>
      <csymbol cd="ambiguous">fragments</csymbol>
      <ci>normal-(</ci>
      <csymbol cd="unknown">e</csymbol>
      <plus></plus>
      <apply>
       <csymbol cd="ambiguous">superscript</csymbol>
       <ci>e</ci>
       <apply>
        <minus></minus>
        <cn type="integer">1</cn>
       </apply>
      </apply>
      <ci>normal-)</ci>
     </cerror>
     <csymbol cd="unknown">n</csymbol>
     <factorial></factorial>
     <ci>normal-⌋</ci>
    </cerror>
    <minus></minus>
    <cerror>
     <csymbol cd="ambiguous">fragments</csymbol>
     <ci>normal-⌊</ci>
     <csymbol cd="unknown">e</csymbol>
     <csymbol cd="unknown">n</csymbol>
     <factorial></factorial>
     <ci>normal-⌋</ci>
    </cerror>
    <ci>normal-,</ci>
    <csymbol cd="unknown">n</csymbol>
    <geq></geq>
    <cn type="integer">2</cn>
    <ci>normal-,</ci>
   </cerror>
  </annotation-xml>
  <annotation encoding="application/x-tex">
   !n=\left\lfloor(e+e^{-1})n!\right\rfloor-\lfloor en!\rfloor,\quad n\geq 2,
  </annotation>
 </semantics>
</math>

</p>

<p>

<math display="block" id="Derangement:8">
 <semantics>
  <mrow>
   <mo lspace="0pt" rspace="3.5pt">!</mo>
   <mi>n</mi>
   <mo>=</mo>
   <mi>n</mi>
   <mo lspace="0pt" rspace="3.5pt">!</mo>
   <mo>-</mo>
   <munderover>
    <mo largeop="true" movablelimits="false" symmetric="true">∑</mo>
    <mrow>
     <mi>i</mi>
     <mo>=</mo>
     <mn>1</mn>
    </mrow>
    <mi>n</mi>
   </munderover>
   <mrow>
    <mo>(</mo>
    <mtable columnspacing="0.4em" rowspacing="0.2ex">
     <mtr>
      <mtd>
       <mi>n</mi>
      </mtd>
     </mtr>
     <mtr>
      <mtd>
       <mi>i</mi>
      </mtd>
     </mtr>
    </mtable>
    <mo>)</mo>
   </mrow>
   <mo>⋅</mo>
   <mo lspace="0pt" rspace="3.5pt">!</mo>
   <mrow>
    <mo stretchy="false">(</mo>
    <mi>n</mi>
    <mo>-</mo>
    <mi>i</mi>
    <mo stretchy="false">)</mo>
   </mrow>
   <mo>,</mo>
  </mrow>
  <annotation-xml encoding="MathML-Content">
   <cerror>
    <csymbol cd="ambiguous">fragments</csymbol>
    <factorial></factorial>
    <csymbol cd="unknown">n</csymbol>
    <eq></eq>
    <csymbol cd="unknown">n</csymbol>
    <factorial></factorial>
    <minus></minus>
    <apply>
     <csymbol cd="ambiguous">superscript</csymbol>
     <apply>
      <csymbol cd="ambiguous">subscript</csymbol>
      <sum></sum>
      <apply>
       <eq></eq>
       <ci>i</ci>
       <cn type="integer">1</cn>
      </apply>
     </apply>
     <ci>n</ci>
    </apply>
    <apply>
     <csymbol cd="latexml">binomial</csymbol>
     <ci>n</ci>
     <ci>i</ci>
    </apply>
    <ci>normal-⋅</ci>
    <factorial></factorial>
    <cerror>
     <csymbol cd="ambiguous">fragments</csymbol>
     <ci>normal-(</ci>
     <csymbol cd="unknown">n</csymbol>
     <minus></minus>
     <csymbol cd="unknown">i</csymbol>
     <ci>normal-)</ci>
    </cerror>
    <ci>normal-,</ci>
   </cerror>
  </annotation-xml>
  <annotation encoding="application/x-tex">
   !n=n!-\sum_{i=1}^{n}{n\choose i}\cdot!(n-i),
  </annotation>
 </semantics>
</math>

</p>

<p>The following recurrence relationship also holds:<a class="footnoteRef" href="#fn5" id="fnref5"><sup>5</sup></a></p>

<p>

<math display="block" id="Derangement:9">
 <semantics>
  <mrow>
   <mo lspace="0pt" rspace="3.5pt">!</mo>
   <mi>n</mi>
   <mo>=</mo>
   <mi>n</mi>
   <mrow>
    <mo stretchy="false">[</mo>
    <mo lspace="0pt" rspace="3.5pt">!</mo>
    <mrow>
     <mo stretchy="false">(</mo>
     <mi>n</mi>
     <mo>-</mo>
     <mn>1</mn>
     <mo stretchy="false">)</mo>
    </mrow>
    <mo stretchy="false">]</mo>
   </mrow>
   <mo>+</mo>
   <msup>
    <mrow>
     <mo stretchy="false">(</mo>
     <mo>-</mo>
     <mn>1</mn>
     <mo stretchy="false">)</mo>
    </mrow>
    <mi>n</mi>
   </msup>
  </mrow>
  <annotation-xml encoding="MathML-Content">
   <cerror>
    <csymbol cd="ambiguous">fragments</csymbol>
    <factorial></factorial>
    <csymbol cd="unknown">n</csymbol>
    <eq></eq>
    <csymbol cd="unknown">n</csymbol>
    <cerror>
     <csymbol cd="ambiguous">fragments</csymbol>
     <ci>normal-[</ci>
     <factorial></factorial>
     <cerror>
      <csymbol cd="ambiguous">fragments</csymbol>
      <ci>normal-(</ci>
      <csymbol cd="unknown">n</csymbol>
      <minus></minus>
      <cn type="integer">1</cn>
      <ci>normal-)</ci>
     </cerror>
     <ci>normal-]</ci>
    </cerror>
    <plus></plus>
    <apply>
     <csymbol cd="ambiguous">superscript</csymbol>
     <cerror>
      <csymbol cd="ambiguous">fragments</csymbol>
      <ci>normal-(</ci>
      <minus></minus>
      <cn type="integer">1</cn>
      <ci>normal-)</ci>
     </cerror>
     <ci>n</ci>
    </apply>
   </cerror>
  </annotation-xml>
  <annotation encoding="application/x-tex">
   !n=n[!(n-1)]+(-1)^{n}
  </annotation>
 </semantics>
</math>

</p>

<p>Starting with <em>n</em> = 0, the numbers of derangements of <em>n</em> are:</p>
<dl>
<dd>1, 0, 1, 2, 9, 44, 265, 1854, 14833, 133496, 1334961, 14684570, 176214841, 2290792932, ... .
</dd>
</dl>

<p>These numbers are also called <strong>subfactorial</strong> or <strong><a href="rencontres_numbers" title="wikilink">rencontres numbers</a></strong>.</p>

<p>Perhaps a more well-known method of counting derangements uses the <a href="inclusion-exclusion_principle#Examples" title="wikilink">inclusion-exclusion principle</a>.</p>
<h2 id="limit-of-ratio-of-derangement-to-permutation-as-n-approaches">Limit of ratio of derangement to permutation as <em>n</em> approaches ∞</h2>

<p>Using this recurrence, it can be shown that, in the limit,</p>

<p>

<math display="block" id="Derangement:10">
 <semantics>
  <mrow>
   <mrow>
    <mrow>
     <munder>
      <mo movablelimits="false">lim</mo>
      <mrow>
       <mi>n</mi>
       <mo>→</mo>
       <mi mathvariant="normal">∞</mi>
      </mrow>
     </munder>
     <mfrac>
      <mrow>
       <mo lspace="0pt" rspace="3.5pt">!</mo>
       <mi>n</mi>
      </mrow>
      <mrow>
       <mi>n</mi>
       <mo lspace="0pt" rspace="3.5pt">!</mo>
      </mrow>
     </mfrac>
    </mrow>
    <mo>=</mo>
    <mfrac>
     <mn>1</mn>
     <mi>e</mi>
    </mfrac>
    <mo>≈</mo>
    <mrow>
     <mn>0.3679</mn>
     <mi mathvariant="normal">…</mi>
    </mrow>
   </mrow>
   <mo>.</mo>
  </mrow>
  <annotation-xml encoding="MathML-Content">
   <apply>
    <and></and>
    <apply>
     <eq></eq>
     <apply>
      <apply>
       <csymbol cd="ambiguous">subscript</csymbol>
       <limit></limit>
       <apply>
        <ci>normal-→</ci>
        <ci>n</ci>
        <infinity></infinity>
       </apply>
      </apply>
      <apply>
       <divide></divide>
       <cerror>
        <csymbol cd="ambiguous">fragments</csymbol>
        <factorial></factorial>
        <csymbol cd="unknown">n</csymbol>
       </cerror>
       <apply>
        <factorial></factorial>
        <ci>n</ci>
       </apply>
      </apply>
     </apply>
     <apply>
      <divide></divide>
      <cn type="integer">1</cn>
      <ci>e</ci>
     </apply>
    </apply>
    <apply>
     <approx></approx>
     <share href="#.cmml">
     </share>
     <apply>
      <times></times>
      <cn type="float">0.3679</cn>
      <ci>normal-…</ci>
     </apply>
    </apply>
   </apply>
  </annotation-xml>
  <annotation encoding="application/x-tex">
   \lim_{n\to\infty}{!n\over n!}={1\over e}\approx 0.3679\dots.
  </annotation>
 </semantics>
</math>

</p>

<p>This is the limit of the <a class="uri" href="probability" title="wikilink">probability</a> <em>p</em><sub><em>n</em></sub> = <em>d</em><sub><em>n</em></sub>/<em>n</em>! that a randomly selected permutation is a derangement. The probability converges to this limit extremely quickly as <em>n</em> increases, which is why <em>d</em><sub><em>n</em></sub> is the nearest integer to <em>n</em>!/<em>e</em>. The above <a class="uri" href="semi-log" title="wikilink">semi-log</a> graph shows that the derangement graph lags the permutation graph by an almost constant value.</p>

<p>More information about this calculation and the above limit may be found in the article on the <a href="Random_permutation_statistics#Number_of_permutations_that_are_derangements" title="wikilink">statistics of random permutations</a>.</p>
<h2 id="generalizations">Generalizations</h2>

<p>The <a href="rencontres_numbers" title="wikilink">problème des rencontres</a> asks how many permutations of a size-<em>n</em> set have exactly <em>k</em> fixed points.</p>

<p>Derangements are an example of the wider field of constrained permutations. For example, the <em><a href="ménage_problem" title="wikilink">ménage problem</a></em> asks if <em>n</em> opposite-sex couples are seated man-woman-man-woman-... around a table, how many ways can they be seated so that nobody is seated next to his or her partner?</p>

<p>More formally, given sets <em>A</em> and <em>S</em>, and some sets <em>U</em> and <em>V</em> of <a href="surjection" title="wikilink">surjections</a> <em>A</em> → <em>S</em>, we often wish to know the number of pairs of functions (<em>f</em>, <em>g</em>) such that <em>f</em> is in <em>U</em> and <em>g</em> is in <em>V</em>, and for all <em>a</em> in <em>A</em>, <em>f</em>(<em>a</em>) ≠ <em>g</em>(<em>a</em>); in other words, where for each <em>f</em> and <em>g</em>, there exists a derangement φ of <em>S</em> such that <em>f</em>(<em>a</em>) = φ(<em>g</em>(<em>a</em>)).</p>

<p>Another generalization is the following problem:</p>
<dl>
<dd><em>How many anagrams with no fixed letters of a given word are there?</em>
</dd>
</dl>

<p>For instance, for a word made of only two different letters, say <em>n</em> letters A and <em>m</em> letters B, the answer is, of course, 1 or 0 according whether <em>n</em> = <em>m</em> or not, for the only way to form an anagram without fixed letters is to exchange all the <em>A</em> with <em>B</em>, which is possible if and only if <em>n</em> = <em>m</em>. In the general case, for a word with <em>n</em><sub>1</sub> letters <em>X</em><sub>1</sub>, <em>n</em><sub>2</sub> letters <em>X</em><sub>2</sub>, ..., <em>n</em><sub><em>r</em></sub> letters <em>X</em><sub><em>r</em></sub> it turns out (after a proper use of the <a class="uri" href="inclusion-exclusion" title="wikilink">inclusion-exclusion</a> formula) that the answer has the form:</p>

<p>

<math display="block" id="Derangement:11">
 <semantics>
  <mrow>
   <mrow>
    <msubsup>
     <mo largeop="true" symmetric="true">∫</mo>
     <mn>0</mn>
     <mi mathvariant="normal">∞</mi>
    </msubsup>
    <mrow>
     <msub>
      <mi>P</mi>
      <msub>
       <mi>n</mi>
       <mn>1</mn>
      </msub>
     </msub>
     <mrow>
      <mo stretchy="false">(</mo>
      <mi>x</mi>
      <mo stretchy="false">)</mo>
     </mrow>
     <msub>
      <mi>P</mi>
      <msub>
       <mi>n</mi>
       <mn>2</mn>
      </msub>
     </msub>
     <mrow>
      <mo stretchy="false">(</mo>
      <mi>x</mi>
      <mo stretchy="false">)</mo>
     </mrow>
     <mi mathvariant="normal">⋯</mi>
     <msub>
      <mi>P</mi>
      <msub>
       <mi>n</mi>
       <mi>r</mi>
      </msub>
     </msub>
     <mrow>
      <mo stretchy="false">(</mo>
      <mi>x</mi>
      <mo stretchy="false">)</mo>
     </mrow>
     <mpadded width="+1.7pt">
      <msup>
       <mi>e</mi>
       <mrow>
        <mo>-</mo>
        <mi>x</mi>
       </mrow>
      </msup>
     </mpadded>
     <mi>d</mi>
     <mi>x</mi>
    </mrow>
   </mrow>
   <mo>,</mo>
  </mrow>
  <annotation-xml encoding="MathML-Content">
   <apply>
    <apply>
     <csymbol cd="ambiguous">superscript</csymbol>
     <apply>
      <csymbol cd="ambiguous">subscript</csymbol>
      <int></int>
      <cn type="integer">0</cn>
     </apply>
     <infinity></infinity>
    </apply>
    <apply>
     <times></times>
     <apply>
      <csymbol cd="ambiguous">subscript</csymbol>
      <ci>P</ci>
      <apply>
       <csymbol cd="ambiguous">subscript</csymbol>
       <ci>n</ci>
       <cn type="integer">1</cn>
      </apply>
     </apply>
     <ci>x</ci>
     <apply>
      <csymbol cd="ambiguous">subscript</csymbol>
      <ci>P</ci>
      <apply>
       <csymbol cd="ambiguous">subscript</csymbol>
       <ci>n</ci>
       <cn type="integer">2</cn>
      </apply>
     </apply>
     <ci>x</ci>
     <ci>normal-⋯</ci>
     <apply>
      <csymbol cd="ambiguous">subscript</csymbol>
      <ci>P</ci>
      <apply>
       <csymbol cd="ambiguous">subscript</csymbol>
       <ci>n</ci>
       <ci>r</ci>
      </apply>
     </apply>
     <ci>x</ci>
     <apply>
      <csymbol cd="ambiguous">superscript</csymbol>
      <ci>e</ci>
      <apply>
       <minus></minus>
       <ci>x</ci>
      </apply>
     </apply>
     <ci>d</ci>
     <ci>x</ci>
    </apply>
   </apply>
  </annotation-xml>
  <annotation encoding="application/x-tex">
   \int_{0}^{\infty}P_{n_{1}}(x)P_{n_{2}}(x)\cdots P_{n_{r}}(x)e^{-x}\,dx,
  </annotation>
 </semantics>
</math>

</p>

<p>for a certain sequence of polynomials <em>P</em><sub><em>n</em></sub>, where <em>P</em><sub><em>n</em></sub> has degree <em>n</em>. But the above answer for the case <em>r</em> = 2 gives an orthogonality relation, whence the <em>P</em><sub><em>n</em></sub>'s are the <a href="Laguerre_polynomials" title="wikilink">Laguerre polynomials</a> (<a href="up_to" title="wikilink">up to</a> a sign that is easily decided).<a class="footnoteRef" href="#fn6" id="fnref6"><sup>6</sup></a></p>
<h2 id="computational-complexity">Computational complexity</h2>

<p>It is <a class="uri" href="NP-complete" title="wikilink">NP-complete</a> to determine whether a given <a href="permutation_group" title="wikilink">permutation group</a> (described by a given set of permutations that generate it) contains any derangements.<a class="footnoteRef" href="#fn7" id="fnref7"><sup>7</sup></a></p>
<h2 id="references">References</h2>
<h2 id="external-links">External links</h2>
<ul>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
</ul>

<p><a class="uri" href="es:Subfactorial" title="wikilink">es:Subfactorial</a> <a href="fr:Analogues_de_la_factorielle#Sous-factorielle" title="wikilink">fr:Analogues de la factorielle#Sous-factorielle</a>"</p>

<p><a class="uri" href="Category:Permutations" title="wikilink">Category:Permutations</a> <a href="Category:Fixed_points_(mathematics)" title="wikilink">Category:Fixed points (mathematics)</a> <a href="Category:Integer_sequences" title="wikilink">Category:Integer sequences</a></p>
<section class="footnotes">
<hr/>
<ol>
<li id="fn1">The name "subfactorial" originates with <a href="William_Allen_Whitworth" title="wikilink">William Allen Whitworth</a>; see .<a href="#fnref1">↩</a></li>
<li id="fn2">Ronald L. Graham, Donald E. Knuth, Oren Patashnik, <em>Concrete Mathematics</em> (1994), Addison–Wesley, Reading MA. ISBN 0-201-55802-5<a href="#fnref2">↩</a></li>
<li id="fn3">de Montmort, P. R. (1708). <em>Essay d'analyse sur les jeux de hazard</em>. Paris: Jacque Quillau. <em>Seconde Edition, Revue &amp; augmentée de plusieurs Lettres</em>. Paris: Jacque Quillau. 1713.<a href="#fnref3">↩</a></li>
<li id="fn4">Hassani, M. "Derangements and Applications." J. Integer Seq. 6, No. 03.1.2, 1–8, 2003<a href="#fnref4">↩</a></li>
<li id="fn5">See the notes for .<a href="#fnref5">↩</a></li>
<li id="fn6"><a href="#fnref6">↩</a></li>
<li id="fn7">. .<a href="#fnref7">↩</a></li>
</ol>
</section>
</body>
</html>
